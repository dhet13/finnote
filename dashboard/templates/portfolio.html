{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}포트폴리오 분석{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/css/dashboard_portfolio.css' %}">
<style>
/* 포트폴리오 페이지 전용 스타일 */
.portfolio-content {
    padding: 24px 0;
    height: 100%; /* 부모 컨테이너 높이 상속 */
    min-height: calc(100vh - 200px); /* 최소 높이 보장 */
    overflow: visible; /* 스크롤을 상위 요소에서 처리 */
}

/* portfolio-chart 스타일은 dashboard_portfolio.css에서 관리 */

.sector-analysis {
    background-color: #f7f9fa;
    padding: 24px;
    border-radius: 8px;
}

/* 원형 그래프 컨테이너 스타일 */
.portfolio-chart {
    position: relative;
    height: 300px;
    width: 100%;
}

/* 섹터 카드 그리드 스타일 */
.sector-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
    margin-top: 20px;
}

.sector-card {
    background: #f7f9fa;
    border-radius: 12px;
    padding: 20px;
    border-left: 4px solid #1d9bf0;
}

.sector-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.sector-header h4 {
    margin: 0;
    color: #0f1419;
    font-size: 16px;
    font-weight: 600;
}

.sector-value {
    color: #0f1419;
    font-weight: 600;
    font-size: 14px;
}

.sector-holdings {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.holding-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #eff3f4;
}

.holding-item:last-child {
    border-bottom: none;
}

.holding-name {
    color: #0f1419;
    font-size: 14px;
}

.holding-value {
    color: #536471;
    font-size: 12px;
}

/* 부동산 카드 그리드 스타일 */
.property-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
    margin-top: 20px;
}

.property-card {
    background: #f7f9fa;
    border-radius: 12px;
    padding: 20px;
    border-left: 4px solid #17bf63;
}

.property-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.property-header h4 {
    margin: 0;
    color: #0f1419;
    font-size: 16px;
    font-weight: 600;
}

.property-value {
    color: #0f1419;
    font-weight: 600;
    font-size: 14px;
}

.property-details {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.property-detail {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.detail-label {
    color: #536471;
    font-size: 12px;
}

.detail-value {
    color: #0f1419;
    font-size: 12px;
    font-weight: 500;
}
</style>
{% endblock %}

{% block extra_js %}
<!-- Chart.js 라이브러리 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- 포트폴리오 성과 차트 JavaScript -->
<script src="{% static 'dashboard/js/portfolio_performance_charts.js' %}"></script>
{% endblock %}

{% block content %}

<!-- 포트폴리오 전체 콘텐츠 -->
<div class="portfolio-main-content" style="padding: 20px;">
    <!-- 자산 타입 선택 버튼 (주식/부동산) - 자산 현황 페이지와 동일한 위치와 스타일 -->
    <div style="display: flex;justify-content: space-between;align-items: center;margin-top: 20px;margin-bottom: 16px;">
        <div></div> <!-- 왼쪽 빈 공간 -->
        <div class="asset-type-buttons">
            <button class="asset-type-btn active" data-type="stock">주식</button>
            <button class="asset-type-btn" data-type="real_estate">부동산</button>
        </div>
    </div>

    <!-- 주식 포트폴리오 콘텐츠 -->
    <div id="stockPortfolio" class="portfolio-content">
        <!-- 섹터별 자산 배분 원형 차트 -->
        <div class="portfolio-chart-container">
            <h3>섹터별 자산 배분 현황</h3>
            <div class="portfolio-chart">
                <canvas id="stockSectorPieChart"></canvas>
            </div>
        </div>

        <!-- 주식 자산 전체 추이 차트 -->
        <div class="stock-performance-chart-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #0f1419; font-size: 18px; font-weight: 600; margin: 0;">주식 자산 추이</h3>
                <div class="stock-period-buttons" style="display: flex; gap: 8px;">
                    <button class="stock-period-btn active" data-period="1D">1D</button>
                    <button class="stock-period-btn" data-period="1W">1W</button>
                    <button class="stock-period-btn" data-period="1M">1M</button>
                    <button class="stock-period-btn" data-period="1Y">1Y</button>
                </div>
            </div>
            <div style="height: 200px; background: white; border-radius: 8px; padding: 16px;">
                <canvas id="stockPerformanceChart"></canvas>
            </div>
        </div>

        <!-- 섹터별 카드뷰와 수익률 -->
        <div class="sector-cards-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>섹터별 보유 종목</h3>
                <div class="sector-return-buttons" style="display: flex; gap: 8px;">
                    <button class="sector-return-btn active" data-period="daily">일간 수익률</button>
                    <button class="sector-return-btn" data-period="weekly">주간 수익률</button>
                </div>
            </div>
            <div class="sector-cards-grid">
                <!-- JavaScript로 동적 생성 -->
            </div>
        </div>
    </div>

    <!-- 부동산 포트폴리오 콘텐츠 -->
    <div id="propertyPortfolio" class="portfolio-content" style="display: none;">
        <!-- 물건별 자산 배분 원형 차트 -->
        <div class="portfolio-chart-container">
            <h3>물건별 자산 배분 현황</h3>
            <div class="portfolio-chart">
                <canvas id="realEstatePieChart"></canvas>
            </div>
        </div>

        <!-- 부동산 자산 전체 추이 차트 -->
        <div class="property-performance-chart-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #0f1419; font-size: 18px; font-weight: 600; margin: 0;">부동산 자산 추이</h3>
                <div class="property-period-buttons" style="display: flex; gap: 8px;">
                    <button class="property-period-btn active" data-period="1D">1D</button>
                    <button class="property-period-btn" data-period="1W">1W</button>
                    <button class="property-period-btn" data-period="1M">1M</button>
                    <button class="property-period-btn" data-period="1Y">1Y</button>
                </div>
            </div>
            <div style="height: 200px; background: white; border-radius: 8px; padding: 16px;">
                <canvas id="propertyPerformanceChart"></canvas>
            </div>
        </div>

        <!-- 지역별 카드뷰 -->
        <div class="property-cards-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>지역별 보유 부동산</h3>
            </div>
            <div class="property-cards-grid">
                <!-- JavaScript로 동적 생성 -->
            </div>
        </div>

        <!-- 물건별 카드뷰와 수익률 -->
        <div class="property-cards-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>물건별 보유 부동산</h3>
                <div class="property-return-buttons" style="display: flex; gap: 8px;">
                    <button class="property-return-btn active" data-period="daily">일간 수익률</button>
                    <button class="property-return-btn" data-period="weekly">주간 수익률</button>
                </div>
            </div>
            <div class="property-cards-grid">
                <!-- JavaScript로 동적 생성 -->
            </div>
        </div>
    </div>
{% endblock %}

<!-- JavaScript는 base.html에서 로드됨 -->
<script>
// 포트폴리오 페이지 전용 JavaScript
// currentAssetType, stockSectorChart, realEstateChart는 dashboard.js에서 정의됨

// 포트폴리오 페이지 즉시 초기화 함수 (AJAX 로딩 시에도 작동)
function initializePortfolioPage() {
    console.log('포트폴리오 페이지 즉시 초기화 시작');
    
    // 주식/부동산 버튼 즉시 초기화
    if (typeof initializeAssetTypeButtons === 'function') {
        console.log('주식/부동산 버튼 초기화');
        initializeAssetTypeButtons();
    }
    
    // 포트폴리오 콘텐츠 초기화
    if (typeof initializeStockPortfolio === 'function') {
        initializeStockPortfolio();
    }
    if (typeof initializeRealEstatePortfolio === 'function') {
        initializeRealEstatePortfolio();
    }
    
    // 차트 초기화
    if (typeof initializeTotalPage === 'function') {
        initializeTotalPage();
    }
    
    console.log('포트폴리오 페이지 초기화 완료');
}

// 페이지 로드 시 즉시 실행 (로그인 상태 확인 후)
// DOM이 로드된 후에 실행하도록 변경
document.addEventListener('DOMContentLoaded', function() {
    // 포트폴리오 페이지 직접 접근 시 로그인 확인
    if (typeof checkPortfolioPageAccess === 'function') {
        checkPortfolioPageAccess().then((isLoggedIn) => {
            if (isLoggedIn) {
                // 로그인된 경우에만 초기화
                if (typeof initializePortfolioPageWithAuth === 'function') {
                    initializePortfolioPageWithAuth();
                } else {
                    // fallback
                    if (typeof initializePortfolioPage === 'function') {
                        initializePortfolioPage();
                    }
                }
            } else {
                console.log('포트폴리오 페이지 직접 접근: 로그인 안내 표시');
            }
        });
    } else {
        // fallback
        if (typeof initializePortfolioPageWithAuth === 'function') {
            initializePortfolioPageWithAuth();
        } else if (typeof initializePortfolioPage === 'function') {
            initializePortfolioPage();
        }
    }
});

    // 약간의 지연을 두고 초기화 (DOM이 완전히 로드된 후)
    setTimeout(() => {
        // 로그인 상태 확인 후 포트폴리오 초기화
        if (typeof initializePortfolioPageWithAuth === 'function') {
            initializePortfolioPageWithAuth().then((isLoggedIn) => {
                if (isLoggedIn) {
                    // 로그인된 경우에만 추가 초기화
                    initializeAssetTypeButtons();
                    initializeStockPortfolio();
                    initializeRealEstatePortfolio();
                    
                    // 차트 초기화도 함께 실행
                    if (typeof initializeTotalPage === 'function') {
                        initializeTotalPage();
                    }
                } else {
                    console.log('포트폴리오 페이지: 로그인되지 않은 사용자 - 추가 초기화 건너뜀');
                }
            });
        } else {
            // 기존 방식 (fallback)
            initializeAssetTypeButtons();
            initializeStockPortfolio();
            initializeRealEstatePortfolio();
            
            if (typeof initializeStockPerformanceChart === 'function') {
                initializeStockPerformanceChart();
            }
            if (typeof initializePropertyPerformanceChart === 'function') {
                initializePropertyPerformanceChart();
            }
            if (typeof initializeSectorReturnButtons === 'function') {
                initializeSectorReturnButtons();
            }
            if (typeof initializePropertyReturnButtons === 'function') {
                initializePropertyReturnButtons();
            }
            
            if (typeof initializeTotalPage === 'function') {
                initializeTotalPage();
            }
        }
    }, 100);
    
    // 추가 지연 후 차트 재초기화 (DOM 완전 로드 보장)
    setTimeout(() => {
        // 기존 차트들 제거 (안전한 체크)
        if (typeof stockSectorChart !== 'undefined' && stockSectorChart) {
            stockSectorChart.destroy();
            stockSectorChart = null;
        }
        if (typeof realEstateChart !== 'undefined' && realEstateChart) {
            realEstateChart.destroy();
            realEstateChart = null;
        }
        
        if (typeof initializeStockPerformanceChart === 'function') {
            initializeStockPerformanceChart();
        }
        if (typeof initializePropertyPerformanceChart === 'function') {
            initializePropertyPerformanceChart();
        }
        
        // 메인 차트들도 재초기화
        if (typeof initializeTotalPage === 'function') {
            initializeTotalPage();
        }
    }, 100);
});

// initializeAssetTypeButtons와 switchAssetType 함수는 dashboard.js로 이동됨

function initializeStockPortfolio() {
    // 기존 차트 제거 (안전한 체크)
    if (typeof stockSectorChart !== 'undefined' && stockSectorChart) {
        stockSectorChart.destroy();
        stockSectorChart = null;
    }
    
    // 주식 섹터별 원형 차트
    const stockCtx = document.getElementById('stockSectorPieChart').getContext('2d');
    
    // stockSectorChart 변수가 정의되지 않았다면 전역으로 선언
    if (typeof stockSectorChart === 'undefined') {
        window.stockSectorChart = null;
    }
    
    stockSectorChart = new Chart(stockCtx, {
        type: 'pie',
        data: {
            labels: ['기술주', '금융주', '헬스케어', '소비재', '에너지'],
            datasets: [{
                data: [35, 25, 20, 15, 5],
                backgroundColor: [
                    '#1d9bf0',
                    '#17bf63',
                    '#ffd400',
                    '#f91880',
                    '#8b5cf6'
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: false
                },
                datalabels: {
                    display: true,
                    color: 'white',
                    font: {
                        weight: 'bold',
                        size: 12
                    },
                    formatter: function(value, context) {
                        const label = context.chart.data.labels[context.dataIndex];
                        return label + '\n' + value + '%';
                    },
                    textAlign: 'center'
                }
            }
        },
        plugins: [ChartDataLabels]
    });
    
    // 섹터별 카드뷰 생성 - 외부 JS 파일 함수 사용
    if (typeof updateSectorCards === 'function') {
        updateSectorCards();
    }
}

function initializeRealEstatePortfolio() {
    // 기존 차트 제거 (안전한 체크)
    if (typeof realEstateChart !== 'undefined' && realEstateChart) {
        realEstateChart.destroy();
        realEstateChart = null;
    }
    
    // 부동산 물건별 원형 차트
    const realEstateCtx = document.getElementById('realEstatePieChart').getContext('2d');
    
    // realEstateChart 변수가 정의되지 않았다면 전역으로 선언
    if (typeof realEstateChart === 'undefined') {
        window.realEstateChart = null;
    }
    
    realEstateChart = new Chart(realEstateCtx, {
        type: 'pie',
        data: {
            labels: ['아파트', '오피스텔', '빌라', '상가', '기타'],
            datasets: [{
                data: [50, 25, 15, 8, 2],
                backgroundColor: [
                    '#17bf63',
                    '#1d9bf0',
                    '#ffd400',
                    '#f91880',
                    '#8b5cf6'
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: false
                },
                datalabels: {
                    display: true,
                    color: 'white',
                    font: {
                        weight: 'bold',
                        size: 12
                    },
                    formatter: function(value, context) {
                        const label = context.chart.data.labels[context.dataIndex];
                        return label + '\n' + value + '%';
                    },
                    textAlign: 'center'
                }
            }
        },
        plugins: [ChartDataLabels]
    });
    
    // 물건별 카드뷰 생성 - 외부 JS 파일 함수 사용
    if (typeof updatePropertyCards === 'function') {
        updatePropertyCards();
    }
}

// createSectorCards 함수는 외부 JS 파일에서 정의됨
function createSectorCards_REMOVED() {
    const sectorData = [
        {
            sector: '기술주',
            color: '#1d9bf0',
            stocks: [
                { name: '삼성전자', value: '₩3,500,000', return: '+12.5%', weight: '15%' },
                { name: 'SK하이닉스', value: '₩1,800,000', return: '+8.3%', weight: '8%' },
                { name: 'NAVER', value: '₩1,200,000', return: '+15.2%', weight: '6%' },
                { name: 'LG전자', value: '₩900,000', return: '+5.8%', weight: '4%' }
            ]
        },
        {
            sector: '금융주',
            color: '#17bf63',
            stocks: [
                { name: '삼성생명', value: '₩2,200,000', return: '+6.7%', weight: '10%' },
                { name: 'KB금융', value: '₩1,500,000', return: '+4.2%', weight: '7%' },
                { name: '신한지주', value: '₩1,300,000', return: '+3.8%', weight: '6%' }
            ]
        },
        {
            sector: '헬스케어',
            color: '#ffd400',
            stocks: [
                { name: '셀트리온', value: '₩1,800,000', return: '+18.5%', weight: '8%' },
                { name: '바이오니아', value: '₩1,200,000', return: '+22.1%', weight: '5%' },
                { name: '유한양행', value: '₩800,000', return: '+9.3%', weight: '4%' }
            ]
        }
    ];
    
    const container = document.querySelector('.sector-cards-grid');
    container.innerHTML = '';
    
    sectorData.forEach(sector => {
        const card = document.createElement('div');
        card.style.cssText = `
            background: #f7f9fa;
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid ${sector.color};
        `;
        
        let stocksHTML = sector.stocks.map(stock => {
            const returnColor = stock.return.startsWith('+') ? '#17bf63' : '#f91880';
            return `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eff3f4;">
                    <div>
                        <div style="font-weight: 600; color: #0f1419;">${stock.name}</div>
                        <div style="font-size: 12px; color: #536471;">비중: ${stock.weight}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 600; color: #0f1419;">${stock.value}</div>
                        <div style="font-size: 12px; color: ${returnColor};">${stock.return}</div>
                    </div>
                </div>
            `;
        }).join('');
        
        card.innerHTML = `
            <h4 style="margin-bottom: 16px; color: #0f1419; display: flex; align-items: center;">
                <div style="width: 12px; height: 12px; background: ${sector.color}; border-radius: 50%; margin-right: 8px;"></div>
                ${sector.sector}
            </h4>
            <div>${stocksHTML}</div>
        `;
        
        container.appendChild(card);
    });
}

// createPropertyCards 함수는 외부 JS 파일에서 정의됨  
function createPropertyCards_REMOVED() {
    const propertyData = [
        {
            propertyType: '아파트',
            color: '#17bf63',
            properties: [
                { name: '대치동 래미안', value: '₩12억', return: '+8.5%', location: '강남구' },
                { name: '반포동 아크로리버파크', value: '₩15억', return: '+12.1%', location: '서초구' },
                { name: '잠실 롯데캐슬', value: '₩10억', return: '+6.8%', location: '송파구' }
            ]
        },
        {
            propertyType: '오피스텔',
            color: '#1d9bf0',
            properties: [
                { name: '역삼동 센터필드', value: '₩6억', return: '+5.2%', location: '강남구' },
                { name: '홍대 메세나폴리스', value: '₩4억', return: '+7.3%', location: '마포구' }
            ]
        },
        {
            propertyType: '빌라',
            color: '#ffd400',
            properties: [
                { name: '성수동 단독주택', value: '₩8억', return: '+4.1%', location: '성동구' },
                { name: '한남동 빌라', value: '₩5억', return: '+9.2%', location: '용산구' }
            ]
        }
    ];
    
    const container = document.querySelector('.property-cards-grid');
    container.innerHTML = '';
    
    propertyData.forEach(propertyGroup => {
        const card = document.createElement('div');
        card.style.cssText = `
            background: #f7f9fa;
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid ${propertyGroup.color};
        `;
        
        let propertiesHTML = propertyGroup.properties.map(property => {
            const returnColor = property.return.startsWith('+') ? '#17bf63' : '#f91880';
            return `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eff3f4;">
                    <div>
                        <div style="font-weight: 600; color: #0f1419;">${property.name}</div>
                        <div style="font-size: 12px; color: #536471;">위치: ${property.location}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 600; color: #0f1419;">${property.value}</div>
                        <div style="font-size: 12px; color: ${returnColor};">${property.return}</div>
                    </div>
    </div>
            `;
        }).join('');
        
        card.innerHTML = `
            <h4 style="margin-bottom: 16px; color: #0f1419; display: flex; align-items: center;">
                <div style="width: 12px; height: 12px; background: ${propertyGroup.color}; border-radius: 50%; margin-right: 8px;"></div>
                ${propertyGroup.propertyType}
            </h4>
            <div>${propertiesHTML}</div>
        `;
        
        container.appendChild(card);
    });
}
</script>

</div> <!-- portfolio-main-content 닫기 -->