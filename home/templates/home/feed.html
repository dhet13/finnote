{% extends 'home/base.html' %}

{% block title %}홈 피드 - FinTech SNS{% endblock %}

{% block content %}


<!-- 탭 영역 -->
<div style="border-bottom: 1px solid #eff3f4;">
    <div style="display: flex;">
        <button class="feed-tab active-tab" onclick="switchTab('foryou')" style="flex: 1; padding: 16px; background: none; border: none; font-weight: bold; font-size: 15px; cursor: pointer; position: relative; color: #0f1419;">
            For you
        </button>
        <button class="feed-tab" onclick="switchTab('following')" style="flex: 1; padding: 16px; background: none; border: none; font-weight: bold; font-size: 15px; cursor: pointer; position: relative; color: #536471;">
            Following
        </button>
    </div>
</div>

<!-- 포스트 작성 영역 -->
<form method="POST" action="{% url 'home:create_simple_post' %}" enctype="multipart/form-data" style="border-bottom: 1px solid #eff3f4; padding: 15px;" onsubmit="submitPost(event)">
    {% csrf_token %}
    <div style="display: flex; align-items: flex-start; gap: 12px;">
        <!-- 프로필 이미지 placeholder -->
        <div style="width: 40px; height: 40px; background: #1d9bf0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
            U
        </div>
        
        <!-- 입력 영역 -->
        <div style="flex: 1;">
            <textarea name="content" id="post-content" placeholder="What's happening?" 
                style="width: 100%; min-height: 50px; font-size: 18px; color: #0f1419; border: none; outline: none; resize: none; padding: 12px 0; border-bottom: 1px solid #eff3f4; margin-bottom: 12px; background: transparent; font-family: inherit;" 
                oninput="togglePostButton()"></textarea>

            <input type="file" id="image-input" name="image" accept="image/*" style="display: none;" onchange="previewImage(this)">
            
            <div id="image-preview" style="display: none; margin-bottom: 12px; position: relative;">
                <div style="width: 100%; aspect-ratio: 16/9; overflow: hidden; border-radius: 12px; border: 1px solid #eff3f4; position: relative;">
                    <img id="preview-img" style="width: 100%; height: 100%; object-fit: cover;">
                    <button type="button" onclick="removeImage()" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 12px;">✕</button>
                </div>
            </div>

            <!-- 액션 버튼들 -->
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; gap: 16px;">
                    <button type="button" id="trading-journal-btn" onclick="openTradingJournal()" style="display: inline-block; padding: 8px; border-radius: 50%; transition: background-color 0.2s; margin-right: 12px; background: none; border: none; cursor: pointer;" 
                    onmouseover="this.style.backgroundColor='rgba(29, 155, 240, 0.1)'" 
                    onmouseout="this.style.backgroundColor='transparent'"
                    title="매매일지 작성">
                        <span class="material-symbols-outlined" style="color: #1d9bf0; font-size: 20px;">assessment</span>
                    </button>

                    <button type="button" id="image-upload-btn" onclick="document.getElementById('image-input').click()" style="display: inline-block; padding: 8px; border-radius: 50%; transition: background-color 0.2s; background: none; border: none; cursor: pointer;"
                    onmouseover="this.style.backgroundColor='rgba(29, 155, 240, 0.1)'" 
                    onmouseout="this.style.backgroundColor='transparent'"
                    title="이미지 첨부">
                        <span class="material-symbols-outlined" style="color: #1d9bf0; font-size: 20px;">image</span>
                    </button>
                </div>
                
                <button type="submit" id="post-button" style="background: #1d9bf0; color: white; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; opacity: 0.5;" disabled>
                    Post
                </button>
            </div>
        </div>
    </div>
</form>



<!-- 필터 버튼 -->
<div style="padding: 12px 16px; border-bottom: 1px solid #eff3f4; background: #f7f9fa;">
    <div style="display: flex; gap: 8px;">
        <button onclick="toggleFilter('trading')" id="filter-trading" style="background: #ffffff; color: #0f1419; border: 1px solid #eff3f4; padding: 6px 12px; border-radius: 20px; font-size: 14px; cursor: pointer;">
            <span class="material-symbols-outlined" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">filter_list</span>
            매매일지만 보기
        </button>
        <button onclick="toggleFilter('stock')" id="filter-stock" style="background: #ffffff; color: #0f1419; border: 1px solid #eff3f4; padding: 6px 12px; border-radius: 20px; font-size: 14px; cursor: pointer;">
            주식
        </button>
        <button onclick="toggleFilter('realestate')" id="filter-realestate" style="background: #ffffff; color: #0f1419; border: 1px solid #eff3f4; padding: 6px 12px; border-radius: 20px; font-size: 14px; cursor: pointer;">
            부동산
        </button>
    </div>
</div>


<!-- 포스트 피드 -->
<div id="posts-container">
    {% if posts %}
        {% for post in posts %}
        <div class="post-card" data-post-type="{{ post.asset_class }}">
            <div class="post-header">
                <span class="post-username">{{ post.user.username }}</span>
                <span class="post-time">{{ post.created_at|timesince }} 전</span>
            </div>
            
            <div class="post-meta">
                <span style="color: #1d9bf0; font-weight: 500;">{{ post.get_asset_class_display }}</span> • 
            </div>
            
            <div class="post-content">
                {{ post.content }}
            </div>
                        
            {% if post.image %}
            <div style="margin: 10px 0;">
                <div style="width: 100%; aspect-ratio: 16/9; overflow: hidden; border-radius: 12px; border: 1px solid #eff3f4; cursor: pointer;" onclick="openImageModal('{{ post.image.url }}')">
                    <img src="{{ post.image.url }}" alt="첨부 이미지" 
                        style="width: 100%; height: 100%; object-fit: cover;">
                </div>
            </div>
            {% elif post.screenshot_url %}
            <div style="margin: 10px 0; cursor: pointer;" onclick="openImageModal('{{ post.screenshot_url }}')">
                <img src="{{ post.screenshot_url }}" alt="첨부 이미지" 
                    style="max-width: 100%; border-radius: 12px; border: 1px solid #eff3f4;">
            </div>
            {% endif %}
            
            <div class="action-buttons">
                <div class="action-btn">
                    <span class="material-symbols-outlined">chat_bubble</span>
                    <span>{{ post.comments.count }}</span>
                </div>
                
                <div class="action-btn">
                    <span class="material-symbols-outlined">favorite</span>
                    <span>{{ post.likes.count }}</span>
                </div>
                
                <div class="action-btn">
                    <span class="material-symbols-outlined">bookmark</span>
                    <span>{{ post.bookmarks.count }}</span>
                </div>
                
                <div class="action-btn">
                    <span class="material-symbols-outlined">share</span>
                    <span>0</span>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <h3>포스트가 없습니다</h3>
            <p>
                <a href="/admin/">관리자 페이지</a>에서 테스트 데이터를 추가해보세요.
            </p>
        </div>
    {% endif %}
</div>

<!-- 이미지 모달 -->
<div id="image-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9);" onclick="closeImageModal()">
    <span style="position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer;" onclick="closeImageModal()">&times;</span>
    <img id="modal-image" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90%; max-height: 90%;">
</div>

<script>
// 매매일지 인터페이스 추상화 레이어
const TradingJournalInterface = {
    // 설정 (팀원과 합의된 부분)
    config: {
        modalUrl: '/journals/compose/?modal=1',
        modalWidth: 800,
        modalHeight: 600
    },
    
    // 모달 열기
    openModal: function(callback) {
        this.resultCallback = callback;
        
        // 모달 오버레이 생성
        const overlay = document.createElement('div');
        overlay.id = 'trading-modal-overlay';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        `;
        
        // 모달 컨테이너
        const modal = document.createElement('div');
        modal.style.cssText = `
            background: white;
            border-radius: 8px;
            width: ${this.config.modalWidth}px;
            height: ${this.config.modalHeight}px;
            max-width: 95vw;
            max-height: 95vh;
            overflow: hidden;
            position: relative;
        `;
        
        // iframe으로 매매일지 로드
        const iframe = document.createElement('iframe');
        iframe.src = this.config.modalUrl;
        iframe.style.cssText = `
            width: 100%;
            height: 100%;
            border: none;
        `;
        
        // 닫기 버튼
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = '&times;';
        closeBtn.style.cssText = `
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            z-index: 1;
            color: #666;
        `;
        closeBtn.onclick = () => this.closeModal();
        
        modal.appendChild(iframe);
        modal.appendChild(closeBtn);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        
        // ESC 키로 닫기
        this.keyHandler = (e) => {
            if (e.key === 'Escape') this.closeModal();
        };
        document.addEventListener('keydown', this.keyHandler);
        
        console.log('매매일지 모달 열림');
    },
    
    // 모달 닫기
    closeModal: function() {
        const overlay = document.getElementById('trading-modal-overlay');
        if (overlay) {
            overlay.remove();
        }
        if (this.keyHandler) {
            document.removeEventListener('keydown', this.keyHandler);
        }
        console.log('매매일지 모달 닫힘');
    },
    
    // 완료 결과 처리 (팀원 시스템에서 호출)
    onComplete: function(result) {
        if (this.resultCallback) {
            this.resultCallback(result);
        }
        this.closeModal();
    },
    
    // 팀원과의 인터페이스 (postMessage 수신)
    setupMessageListener: function() {
        window.addEventListener('message', (event) => {
            if (event.data.type === 'trading-journal-complete') {
                this.onComplete(event.data.payload);
            }
        });
    }
};
// 포스트 상태 관리
const PostStateManager = {
    currentState: 'none', // 'none', 'image', 'trading'
    
    setState: function(newState) {
        this.currentState = newState;
        this.updateUI();
    },
    
    updateUI: function() {
        const tradingBtn = document.getElementById('trading-journal-btn');
        const imageBtn = document.getElementById('image-upload-btn');
        const postBtn = document.getElementById('post-button');
        
        if (this.currentState === 'trading') {
            // 매매일지 선택됨
            tradingBtn.style.opacity = '1';
            imageBtn.style.opacity = '0.3';
            imageBtn.style.pointerEvents = 'none';
            this.showPrivacyToggle();
        } else if (this.currentState === 'image') {
            // 이미지 선택됨  
            imageBtn.style.opacity = '1';
            tradingBtn.style.opacity = '0.3';
            tradingBtn.style.pointerEvents = 'none';
            this.hidePrivacyToggle();
        } else {
            // 아무것도 선택 안됨
            tradingBtn.style.opacity = '1';
            tradingBtn.style.pointerEvents = 'auto';
            imageBtn.style.opacity = '1';
            imageBtn.style.pointerEvents = 'auto';
            this.hidePrivacyToggle();
        }
        
        this.updatePostButton();
    },
    
    updatePostButton: function() {
        const textarea = document.getElementById('post-content');
        const postBtn = document.getElementById('post-button');
        const hasContent = textarea.value.trim().length > 0;
        const hasAttachment = this.currentState !== 'none';
        
        if (hasContent || hasAttachment) {
            postBtn.disabled = false;
            postBtn.style.opacity = '1';
        } else {
            postBtn.disabled = true;
            postBtn.style.opacity = '0.5';
        }
    },
    
    showPrivacyToggle: function() {
        let toggle = document.getElementById('privacy-toggle');
        if (!toggle) {
            toggle = document.createElement('div');
            toggle.id = 'privacy-toggle';
            toggle.innerHTML = `
                <label style="display: flex; align-items: center; gap: 8px; margin-top: 10px; font-size: 14px;">
                    <input type="checkbox" id="private-post" style="margin: 0;">
                    <span>나만보기</span>
                </label>
            `;
            const form = document.querySelector('form[action*="create_simple_post"]');
            form.insertBefore(toggle, form.lastElementChild);
        }
        toggle.style.display = 'block';
    },
    
    hidePrivacyToggle: function() {
        const toggle = document.getElementById('privacy-toggle');
        if (toggle) {
            toggle.style.display = 'none';
        }
    }
};

// 매매일지 열기 함수
function openTradingJournal() {
    TradingJournalInterface.openModal(function(result) {
        // 매매일지 완료시 콜백
        console.log('매매일지 완료:', result);
        PostStateManager.setState('trading');
        // TODO: 매매일지 카드 표시
    });
}
// 페이지 로드시 메시지 리스너 설정
document.addEventListener('DOMContentLoaded', function() {
    TradingJournalInterface.setupMessageListener();
});

// 탭 전환 기능
function switchTab(tabType) {
    // 모든 탭 비활성화
    document.querySelectorAll('.feed-tab').forEach(tab => {
        tab.classList.remove('active-tab');
        tab.style.color = '#536471';
    });
    
    // 클릭된 탭 활성화
    event.target.classList.add('active-tab');
    event.target.style.color = '#0f1419';
    
    // 여기에 실제 필터링 로직 추가 예정
    console.log('Tab switched to:', tabType);
}

// 포스트 버튼 활성화/비활성화
function togglePostButton() {
    PostStateManager.updatePostButton(); 
}

// 이미지 미리보기
function previewImage(input) {
    const preview = document.getElementById('image-preview');
    const img = document.getElementById('preview-img');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            img.src = e.target.result;
            preview.style.display = 'block';
            PostStateManager.setState('image');
        }
        
        reader.readAsDataURL(input.files[0]);
    }
}

// 이미지 제거
function removeImage() {
    document.getElementById('image-input').value = '';
    document.getElementById('image-preview').style.display = 'none';
    PostStateManager.setState('none');
}

// 필터 상태 관리
let activeFilters = [];

function toggleFilter(type) {
    const button = document.getElementById(`filter-${type}`);
    
    // 필터 토글
    if (activeFilters.includes(type)) {
        // 비활성화
        activeFilters = activeFilters.filter(f => f !== type);
        button.style.background = '#ffffff';
        button.style.color = '#0f1419';
    } else {
        // 활성화
        activeFilters.push(type);
        button.style.background = '#1d9bf0';
        button.style.color = '#ffffff';
    }
    
    // 포스트 필터링
    const posts = document.querySelectorAll('.post-card');
    posts.forEach(post => {
        if (activeFilters.length === 0) {
            // 필터 없으면 모두 표시
            post.style.display = 'block';
        } else {
            // 활성화된 필터 중 하나라도 맞으면 표시
            const postType = post.dataset.postType;
            
            let shouldShow = false;
            if (activeFilters.includes('trading') && postType === 'stock') shouldShow = true;
            if (activeFilters.includes('stock') && postType === 'stock') shouldShow = true;
            if (activeFilters.includes('realestate') && postType === 'realestate') shouldShow = true;
            
            post.style.display = shouldShow ? 'block' : 'none';
        }
    });
}

// 이미지 모달 열기
function openImageModal(imageSrc) {
    const modal = document.getElementById('image-modal');
    const modalImg = document.getElementById('modal-image');
    
    modal.style.display = 'block';
    modalImg.src = imageSrc;
}

// 이미지 모달 닫기
function closeImageModal() {
    document.getElementById('image-modal').style.display = 'none';
}
// AJAX 포스트 제출
function submitPost(event) {
    event.preventDefault(); // 기본 form submit 막기
    
    const form = event.target;
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 성공 시 피드에 새 포스트 추가
            addNewPostToFeed(data.post);
            
            // 폼 초기화
            form.reset();
            document.getElementById('post-button').disabled = true;
            document.getElementById('post-button').style.opacity = '0.5';
            document.getElementById('image-preview').style.display = 'none';
        } else {
            alert('포스트 작성 실패: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('포스트 작성 중 오류가 발생했습니다.');
    });
}

function addNewPostToFeed(postData) {
    const postsContainer = document.getElementById('posts-container');
    
    // 새 포스트 HTML 생성
    const newPostHTML = `
        <div class="post-card" data-post-type="${postData.asset_class}">
            <div class="post-header">
                <span class="post-username">${postData.username}</span>
                <span class="post-time">방금 전</span>
            </div>
            
            <div class="post-meta">
                <span style="color: #1d9bf0; font-weight: 500;">${postData.asset_class_display}</span> • 
            </div>
            
            <div class="post-content">
                ${postData.content}
            </div>
            
            ${postData.image_url ? `
            <div style="margin: 10px 0;">
                <div style="width: 100%; aspect-ratio: 16/9; overflow: hidden; border-radius: 12px; border: 1px solid #eff3f4; cursor: pointer;" onclick="openImageModal('${postData.image_url}')">
                    <img src="${postData.image_url}" alt="첨부 이미지" 
                        style="width: 100%; height: 100%; object-fit: cover;">
                </div>
            </div>
            ` : ''}
            
            <div class="action-buttons">
                <div class="action-btn">
                    <span class="material-symbols-outlined">chat_bubble</span>
                    <span>0</span>
                </div>
                
                <div class="action-btn">
                    <span class="material-symbols-outlined">favorite</span>
                    <span>0</span>
                </div>
                
                <div class="action-btn">
                    <span class="material-symbols-outlined">bookmark</span>
                    <span>0</span>
                </div>
                
                <div class="action-btn">
                    <span class="material-symbols-outlined">share</span>
                    <span>0</span>
                </div>
            </div>
        </div>
    `;
    
    // 피드 맨 위에 새 포스트 추가
    postsContainer.insertAdjacentHTML('afterbegin', newPostHTML);
}
// 캐러셀 변수
let currentSlide = 0;
const totalSlides = 3; // 총 3개 슬라이드 (9개 뉴스 ÷ 3개 = 3개)

// 슬라이드 표시 함수
function showSlide(slideIndex) {
    const newsItems = document.querySelectorAll('.news-item');
    const dots = document.querySelectorAll('.dot');
    
    // 모든 뉴스 아이템 숨기기
    newsItems.forEach(item => {
        item.classList.add('hidden');
    });
    
    // 해당 슬라이드의 뉴스 아이템들 보이기 (3개씩)
    for (let i = slideIndex * 3; i < (slideIndex + 1) * 3; i++) {
        if (newsItems[i]) {
            newsItems[i].classList.remove('hidden');
        }
    }
    
    // 모든 점 비활성화
    dots.forEach(dot => {
        dot.style.background = '#ccc';
    });
    
    // 현재 점 활성화
    if (dots[slideIndex]) {
        dots[slideIndex].style.background = '#1d9bf0';
    }
    
    currentSlide = slideIndex;
}

// 이전 슬라이드
function prevSlide() {
    const newSlide = currentSlide === 0 ? totalSlides - 1 : currentSlide - 1;
    showSlide(newSlide);
}

// 다음 슬라이드
function nextSlide() {
    const newSlide = currentSlide === totalSlides - 1 ? 0 : currentSlide + 1;
    showSlide(newSlide);
}

// 자동 슬라이드 (5초마다)
let autoSlideInterval = setInterval(nextSlide, 10000);

// 호버시 자동 슬라이드 정지
const carousel = document.querySelector('.news-carousel');
if (carousel) {
    carousel.addEventListener('mouseenter', () => {
        clearInterval(autoSlideInterval);
    });
    
    carousel.addEventListener('mouseleave', () => {
        autoSlideInterval = setInterval(nextSlide, 10000);
    });
}
document.addEventListener('DOMContentLoaded', function() {
    showSlide(0);
});
</script>
{% endblock %}