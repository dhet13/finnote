{% extends 'home/base.html' %}

{% block title %}홈 피드 - FinTech SNS{% endblock %}

{% block content %}
<div style="display: none;" id="auth-data" data-authenticated="{% if user.is_authenticated %}true{% else %}false{% endif %}"></div>

{% if user.is_authenticated %}
    <meta name="current-user" content="{{ user.my_ID }}">
{% endif %}


<!-- 포스트 작성 영역 -->
<form method="POST" action="{% url 'home:create_simple_post' %}" enctype="multipart/form-data" style="border-bottom: 1px solid #eff3f4; padding: 15px;" onsubmit="submitPost(event)">
    {% csrf_token %}
    <div style="display: flex; align-items: flex-start; gap: 12px;">
        {% if user.is_authenticated %}
            <a href="{% url 'user_profile:profile' my_ID=user.my_ID %}" style="text-decoration: none;">
                {% if user.profile_picture %}
                    <img src="{{ user.profile_picture.url }}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                {% else %}
                    <div style="width: 40px; height: 40px; background: #1d9bf0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px;">
                        {{ user.my_ID|first|upper }}
                    </div>
                {% endif %}
            </a>
        {% else %}
            <div style="width: 40px; height: 40px; background: #ccc; border-radius: 50%;"></div>
        {% endif %}
                        
        <!-- 입력 영역 -->
        <div style="flex: 1;">
            <div style="position: relative;">
                <textarea name="content" id="post-content" placeholder="What's happening?" 
                    style="width: 100%; min-height: 50px; font-size: 18px; color: #0f1419; border: none; outline: none; resize: none; padding: 12px 0; border-bottom: 1px solid #eff3f4; margin-bottom: 12px; background: transparent; font-family: inherit;" 
                    oninput="handleTextInput(this)" 
                    onkeyup="handleTextInput(this)"></textarea>
                
                <!-- 해시태그 미리보기 -->
                <div id="hashtag-preview" style="font-size: 14px; color: #1d9bf0; margin-bottom: 8px; display: none;">
                    <strong>감지된 해시태그:</strong> <span id="detected-tags"></span>
                </div>
            </div>

            <input type="file" id="image-input" name="image" accept="image/*" style="display: none;" onchange="previewImage(this)">
            
            <div id="image-preview" style="display: none; margin-bottom: 12px; position: relative;">
                <div style="width: 100%; aspect-ratio: 16/9; overflow: hidden; border-radius: 12px; border: 1px solid #eff3f4; position: relative;">
                    <img id="preview-img" style="width: 100%; height: 100%; object-fit: cover;">
                    <button type="button" onclick="removeImage()" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 12px;">✕</button>
                </div>
            </div>

            <!-- 액션 버튼들 -->
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; gap: 16px;">
                    <button type="button" id="trading-journal-btn" onclick="openTradingJournal()" style="display: inline-block; padding: 8px; border-radius: 50%; transition: background-color 0.2s; margin-right: 12px; background: none; border: none; cursor: pointer;" 
                    onmouseover="this.style.backgroundColor='rgba(29, 155, 240, 0.1)'" 
                    onmouseout="this.style.backgroundColor='transparent'"
                    title="매매일지 작성">
                        <span class="material-symbols-outlined" style="color: #1d9bf0; font-size: 20px;">assessment</span>
                    </button>

                    <button type="button" id="image-upload-btn" onclick="document.getElementById('image-input').click()" style="display: inline-block; padding: 8px; border-radius: 50%; transition: background-color 0.2s; background: none; border: none; cursor: pointer;"
                    onmouseover="this.style.backgroundColor='rgba(29, 155, 240, 0.1)'" 
                    onmouseout="this.style.backgroundColor='transparent'"
                    title="이미지 첨부">
                        <span class="material-symbols-outlined" style="color: #1d9bf0; font-size: 20px;">image</span>
                    </button>
                </div>
                
                <button type="submit" id="post-button" style="background: #1d9bf0; color: white; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; opacity: 0.5;" disabled>
                    Post
                </button>
            </div>
        </div>
    </div>
</form>



<!-- 필터 버튼 -->
<div style="padding: 12px 16px; border-bottom: 1px solid #eff3f4; background: #f7f9fa;">
    <div style="display: flex; gap: 8px; align-items: center; width: 100%;">
        <!-- 태그 버튼들 - 스크롤 가능한 영역 -->
        <div style="display: flex; gap: 8px; align-items: center; flex: 1; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none; white-space: nowrap;">
            <button onclick="toggleFilter('매매일지')" id="filter-매매일지" style="background: #ffffff; color: #0f1419; border: 1px solid #eff3f4; padding: 6px 12px; border-radius: 20px; font-size: 14px; cursor: pointer; flex-shrink: 0;">
                #매매일지
            </button>
            <button onclick="toggleFilter('주식')" id="filter-주식" style="background: #ffffff; color: #0f1419; border: 1px solid #eff3f4; padding: 6px 12px; border-radius: 20px; font-size: 14px; cursor: pointer; flex-shrink: 0;">
                #주식
            </button>
            <button onclick="toggleFilter('부동산')" id="filter-부동산" style="background: #ffffff; color: #0f1419; border: 1px solid #eff3f4; padding: 6px 12px; border-radius: 20px; font-size: 14px; cursor: pointer; flex-shrink: 0;">
                #부동산
            </button>
            
            <!-- 추가 태그들 -->
            <div id="custom-tags-container" style="display: flex; gap: 8px;"></div>
        </div>
        
        <!-- 태그 추가 입력창 - 고정 위치 -->
        <div style="display: flex; gap: 4px; align-items: center; flex-shrink: 0;">
            <input type="text" id="tag-input" placeholder="태그 추가" maxlength="10" 
                style="width: 80px; padding: 4px 8px; border: 1px solid #eff3f4; border-radius: 12px; font-size: 13px;"
                onkeypress="handleTagInput(event)">
            <button onclick="addCustomTag()" id="add-tag-btn" 
                style="background: #1d9bf0; color: white; border: none; padding: 4px 8px; border-radius: 12px; font-size: 12px; cursor: pointer;">
                추가
            </button>
        </div>
    </div>
</div>

<!-- 포스트 피드 -->
<div id="posts-container">
    {% if posts %}
        {% for post in posts %}
        <div class="post-card" data-post-type="{{ post.asset_class }}" style="position: relative;">
            <!-- 메뉴 버튼을 별도로 최상단에 배치 -->
            <div class="post-menu-btn" data-post-id="{{ post.id }}" data-is-my-post="{% if user.is_authenticated and post.user == user %}true{% else %}false{% endif %}" style="position: absolute; top: 8px; right: 8px; z-index: 10;">
                <span class="material-symbols-outlined">more_horiz</span>
            </div>
            
            <div style="display: flex; align-items: flex-start; gap: 12px;">
                <!-- 프로필 아이콘 -->
                {% if post.user.my_ID %}
                    <a href="{% url 'user_profile:profile' my_ID=post.user.my_ID %}" style="text-decoration: none;">
                        {% if post.user.profile_picture %}
                            <img src="{{ post.user.profile_picture.url }}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                        {% else %}
                            <div style="width: 32px; height: 32px; background: #1d9bf0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
                                {{ post.user.my_ID|first|upper }}
                            </div>
                        {% endif %}
                    </a>
                {% else %}
                    <div style="width: 32px; height: 32px; background: #ccc; border-radius: 50%;"></div>
                {% endif %}
                
                <!-- 오른쪽 모든 내용 -->
                <div style="flex: 1; margin-top: -4px;">
                    <!-- 사용자명과 시간 -->
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        {% if post.user.my_ID %}
                            <a href="{% url 'user_profile:profile' my_ID=post.user.my_ID %}" style="text-decoration: none; display: flex; align-items: center; gap: 4px;">
                                <span style="font-weight: bold; color: #0f1419;">{{ post.user.nickname }}</span>
                                <span style="color: #536471; font-weight: normal;">@{{ post.user.my_ID }}</span>
                            </a>
                        {% else %}
                            <span class="post-username">알 수 없음</span>
                        {% endif %}
                        <span style="color: #536471; font-size: 14px;">·</span>
                        <span class="post-time" data-timestamp="{{ post.created_at|date:'c' }}" style="color: #536471; font-size: 14px;">{{ post.created_at|timesince }} 전</span>
                    </div>
                    
                    <!-- 포스트 내용 -->
                    <div class="post-content">
                        {{ post.content }}
                    </div>

                    {% if post.image %}
                        <div style="margin: 10px 0;">
                            <div style="width: 100%; aspect-ratio: 16/9; overflow: hidden; border-radius: 12px; border: 1px solid #eff3f4; cursor: pointer;" onclick="openImageModal('{{ post.image.url }}')">
                                <img data-src="{{ post.image.url }}" 
                                    src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='225'%3E%3Crect width='100%25' height='100%25' fill='%23f0f0f0'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' fill='%23999'%3E이미지 로딩중...%3C/text%3E%3C/svg%3E"
                                    alt="첨부 이미지" 
                                    class="lazy-image"
                                    style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                        </div>
                    {% elif post.screenshot_url %}
                        <div style="margin: 10px 0; cursor: pointer;" onclick="openImageModal('{{ post.screenshot_url }}')">
                            <img data-src="{{ post.screenshot_url }}" 
                                src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='225'%3E%3Crect width='100%25' height='100%25' fill='%23f0f0f0'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' fill='%23999'%3E이미지 로딩중...%3C/text%3E%3C/svg%3E"
                                alt="첨부 이미지" 
                                class="lazy-image"
                                style="max-width: 100%; border-radius: 12px; border: 1px solid #eff3f4;">
                        </div>
                    {% endif %}
                </div>
            </div>
                        
            {% if post.tags.all %}
            <div style="margin: 10px 0;">
                {% for tag in post.tags.all %}
                <span onclick="toggleFilter('{{ tag.name }}')" 
                    style="display: inline-block; background: #f0f8ff; color: #1d9bf0; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-right: 6px; margin-bottom: 4px; cursor: pointer; border: 1px solid #e1f5fe;"
                    onmouseover="this.style.backgroundColor='#e3f2fd'"
                    onmouseout="this.style.backgroundColor='#f0f8ff'">
                    #{{ tag.name }}
                </span>
                {% endfor %}
            </div>
            {% endif %}
            <div class="action-buttons">
                <div class="action-btn" data-action="comments" data-post-id="{{ post.id }}">
                    <span class="material-symbols-outlined">chat_bubble</span>
                    <span>{{ post.comments.count }}</span>
                </div>
                
                <div class="action-btn" data-action="like" data-post-id="{{ post.id }}" id="like-btn-{{ post.id }}">
                    <span class="material-symbols-outlined {% if user.is_authenticated and post.is_liked_by_user %}liked{% endif %}" id="like-icon-{{ post.id }}">
                        {% if user.is_authenticated and post.is_liked_by_user %}favorite{% else %}favorite_border{% endif %}
                    </span>
                    <span id="likes-count-{{ post.id }}">{{ post.likes.count }}</span>
                </div>
          
                <div class="action-btn" data-action="bookmark" data-post-id="{{ post.id }}">
                    <span class="material-symbols-outlined {% if user.is_authenticated and post.is_bookmarked_by_user %}bookmarked{% endif %}">
                        {% if user.is_authenticated and post.is_bookmarked_by_user %}bookmark{% else %}bookmark_border{% endif %}
                    </span>
                    <span>{{ post.bookmarks.count }}</span>
                </div>
                
                <div class="action-btn" data-action="share" data-post-id="{{ post.id }}" id="share-btn-{{ post.id }}">
                    <span class="material-symbols-outlined" id="share-icon-{{ post.id }}">share</span>
                    <span id="shares-count-{{ post.id }}">{{ post.shares.count }}</span>
                </div>
            </div>
            <!-- 댓글 섹션 추가 -->
            <div class="comments-section" id="comments-{{ post.id }}" style="display: none; margin-top: 15px; border-top: 1px solid #eff3f4; padding-top: 15px;">
                <!-- 댓글 작성 영역 -->
                <div class="comment-write" style="display: flex; gap: 8px; margin-bottom: 15px;">
                    <input type="text" id="comment-input-{{ post.id }}" placeholder="댓글을 입력하세요..." 
                           style="flex: 1; padding: 8px 12px; border: 1px solid #eff3f4; border-radius: 20px; outline: none;">
                    <button data-action="submit-comment" data-post-id="{{ post.id }}" 
                            style="padding: 8px 16px; background: #1d9bf0; color: white; border: none; border-radius: 20px; cursor: pointer;">
                        작성
                    </button>
                </div>
                
                <!-- 댓글 목록 -->
                <div class="comments-list" id="comments-list-{{ post.id }}">
                    <!-- 댓글들이 여기에 동적으로 추가됩니다 -->
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <h3>포스트가 없습니다</h3>
            <p>
                <a href="/admin/">관리자 페이지</a>에서 테스트 데이터를 추가해보세요.
            </p>
        </div>
    {% endif %}
</div>

<!-- 이미지 모달 -->
<div id="image-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9);" onclick="closeImageModal()">
    <span style="position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer;" onclick="closeImageModal()">&times;</span>
    <img id="modal-image" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90%; max-height: 90%;">
</div>

<script>
// 매매일지 인터페이스 추상화 레이어
const TradingJournalInterface = {
    // 설정 (팀원과 합의된 부분)
    config: {
        modalUrl: '/journals/compose/?modal=1',
        modalWidth: 800,
        modalHeight: 600
    },
    
    // 모달 열기
    openModal: function(callback) {
        this.resultCallback = callback;
        
        // fetch로 modal HTML 가져오기
        fetch(this.config.modalUrl)
            .then(response => response.text())
            .then(html => {
                // 모달 오버레이 생성
                const overlay = document.createElement('div');
                overlay.id = 'trading-modal-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                
                overlay.innerHTML = html;
                document.body.appendChild(overlay);
                
                // 닫기 버튼 이벤트
                const closeBtn = overlay.querySelector('.close-modal');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => this.closeModal());
                }
                
                // 배경 클릭으로 닫기
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        this.closeModal();
                    }
                });
                
                console.log('매매일지 모달 열림');
            })
            .catch(error => {
                console.error('매매일지 모달 로드 실패:', error);
                alert('매매일지 작성 창을 열 수 없습니다.');
            });
    },
    // 모달 닫기
    closeModal: function() {
        const overlay = document.getElementById('trading-modal-overlay');
        if (overlay) {
            overlay.remove();
        }
        if (this.keyHandler) {
            document.removeEventListener('keydown', this.keyHandler);
        }
        console.log('매매일지 모달 닫힘');
    },
    
    // 완료 결과 처리 (팀원 시스템에서 호출)
    onComplete: function(result) {
        if (this.resultCallback) {
            this.resultCallback(result);
        }
        this.closeModal();
    },
    
    // 팀원과의 인터페이스 (postMessage 수신)
    setupMessageListener: function() {
        window.addEventListener('message', (event) => {
            if (event.data.type === 'trading-journal-complete') {
                this.onComplete(event.data.payload);
            }
        });
    }
};
// 포스트 상태 관리
const PostStateManager = {
    currentState: 'none', // 'none', 'image', 'trading'
    
    setState: function(newState) {
        this.currentState = newState;
        this.updateUI();
    },
    
    updateUI: function() {
        const tradingBtn = document.getElementById('trading-journal-btn');
        const imageBtn = document.getElementById('image-upload-btn');
        const postBtn = document.getElementById('post-button');
        
        if (this.currentState === 'trading') {
            // 매매일지 선택됨
            tradingBtn.style.opacity = '1';
            imageBtn.style.opacity = '0.3';
            imageBtn.style.pointerEvents = 'none';
            this.showPrivacyToggle();
        } else if (this.currentState === 'image') {
            // 이미지 선택됨  
            imageBtn.style.opacity = '1';
            tradingBtn.style.opacity = '0.3';
            tradingBtn.style.pointerEvents = 'none';
            this.hidePrivacyToggle();
        } else {
            // 아무것도 선택 안됨
            tradingBtn.style.opacity = '1';
            tradingBtn.style.pointerEvents = 'auto';
            imageBtn.style.opacity = '1';
            imageBtn.style.pointerEvents = 'auto';
            this.hidePrivacyToggle();
        }
        
        this.updatePostButton();
    },
    
    updatePostButton: function() {
        const textarea = document.getElementById('post-content');
        const postBtn = document.getElementById('post-button');
        const hasContent = textarea.value.trim().length > 0;
        const hasAttachment = this.currentState !== 'none';
        
        if (hasContent || hasAttachment) {
            postBtn.disabled = false;
            postBtn.style.opacity = '1';
        } else {
            postBtn.disabled = true;
            postBtn.style.opacity = '0.5';
        }
    },
    
    showPrivacyToggle: function() {
        let toggle = document.getElementById('privacy-toggle');
        if (!toggle) {
            toggle = document.createElement('div');
            toggle.id = 'privacy-toggle';
            toggle.innerHTML = `
                <label style="display: flex; align-items: center; gap: 8px; margin-top: 10px; font-size: 14px;">
                    <input type="checkbox" id="private-post" style="margin: 0;">
                    <span>나만보기</span>
                </label>
            `;
            const form = document.querySelector('form[action*="create_simple_post"]');
            form.insertBefore(toggle, form.lastElementChild);
        }
        toggle.style.display = 'block';
    },
    
    hidePrivacyToggle: function() {
        const toggle = document.getElementById('privacy-toggle');
        if (toggle) {
            toggle.style.display = 'none';
        }
    }
};

// 매매일지 열기 함수
function openTradingJournal() {
    TradingJournalInterface.openModal(function(result) {
        // 매매일지 완료시 콜백
        console.log('매매일지 완료:', result);
        PostStateManager.setState('trading');
        // TODO: 매매일지 카드 표시
    });
}
// 페이지 로드시 메시지 리스너 설정
document.addEventListener('DOMContentLoaded', function() {
    TradingJournalInterface.setupMessageListener();
});

// 포스트 버튼 활성화/비활성화
function togglePostButton() {
    PostStateManager.updatePostButton(); 
}

// 이미지 미리보기
function previewImage(input) {
    const preview = document.getElementById('image-preview');
    const img = document.getElementById('preview-img');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            img.src = e.target.result;
            preview.style.display = 'block';
            PostStateManager.setState('image');
        }
        
        reader.readAsDataURL(input.files[0]);
    }
}

// 이미지 제거
function removeImage() {
    document.getElementById('image-input').value = '';
    document.getElementById('image-preview').style.display = 'none';
    PostStateManager.setState('none');
}

// 필터 상태 관리
let activeFilters = [];
let customTags = [];
const MAX_CUSTOM_TAGS = 3;

function toggleFilter(tagName) {
    const button = document.getElementById(`filter-${tagName}`);
    
    if (activeFilters.includes(tagName)) {
        activeFilters = activeFilters.filter(f => f !== tagName);
        button.style.background = '#ffffff';
        button.style.color = '#0f1419';
    } else {
        activeFilters.push(tagName);
        button.style.background = '#1d9bf0';
        button.style.color = '#ffffff';
    }
    
    applyFilters();
}
function handleTagInput(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        addCustomTag();
    }
}

function addCustomTag() {
    const input = document.getElementById('tag-input');
    const tagName = input.value.trim();
    
    if (!tagName) return;
    if (customTags.length >= MAX_CUSTOM_TAGS) {
        Toast.warning('최대 3개까지만 추가할 수 있습니다.');
        return;
    }
    if (customTags.includes(tagName) || ['매매일지', '주식', '부동산'].includes(tagName)) {
        Toast.warning('이미 존재하는 태그입니다.');
        return;
    }
    
    customTags.push(tagName);
    renderCustomTags();
    input.value = '';
}

function renderCustomTags() {
    const container = document.getElementById('custom-tags-container');
    container.innerHTML = '';
    
    customTags.forEach(tagName => {
        const tagButton = document.createElement('button');
        tagButton.innerHTML = `#${tagName} <span onclick="removeCustomTag('${tagName}')" style="margin-left: 6px; padding: 2px 4px; background: rgba(255,255,255,0.8); border-radius: 50%; font-size: 14px; font-weight: bold; cursor: pointer; hover:background: rgba(255,255,255,1);">×</span>`;
        tagButton.id = `filter-${tagName}`;
        tagButton.onclick = () => toggleFilter(tagName);
        tagButton.style.cssText = 'background: #ffffff; color: #0f1419; border: 1px solid #eff3f4; padding: 6px 12px; border-radius: 20px; font-size: 14px; cursor: pointer;';
        container.appendChild(tagButton);
    });
}

function removeCustomTag(tagName) {
    customTags = customTags.filter(tag => tag !== tagName);
    renderCustomTags();
    
    const index = activeFilters.indexOf(tagName);
    if (index > -1) {
        activeFilters.splice(index, 1);
        applyFilters();
    }
}

function applyFilters() {
    const posts = document.querySelectorAll('.post-card');
    posts.forEach(post => {
        if (activeFilters.length === 0) {
            // 필터 없으면 모두 표시
            post.style.display = 'block';
        } else {
            // 포스트의 태그 확인
            const postTags = post.querySelectorAll('span[onclick*="toggleFilter"]');
            const postTagNames = Array.from(postTags).map(tag => 
                tag.textContent.replace('#', '').trim()
            );
            
            // 활성화된 필터 중 하나라도 포스트에 있으면 표시
            const shouldShow = activeFilters.some(filter => 
                postTagNames.includes(filter)
            );
            
            post.style.display = shouldShow ? 'block' : 'none';
        }
    });
}
// 이미지 모달 열기
function openImageModal(imageSrc) {
    const modal = document.getElementById('image-modal');
    const modalImg = document.getElementById('modal-image');
    
    modal.style.display = 'block';
    modalImg.src = imageSrc;
}

// 이미지 모달 닫기
function closeImageModal() {
    document.getElementById('image-modal').style.display = 'none';
}
// AJAX 포스트 제출
function submitPost(event) {
    event.preventDefault(); // 기본 form submit 막기
    
    const form = event.target;
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 성공 시 피드에 새 포스트 추가
            addNewPostToFeed(data.post);
            
            // 폼 초기화
            form.reset();
            document.getElementById('post-button').disabled = true;
            document.getElementById('post-button').style.opacity = '0.5';
            document.getElementById('image-preview').style.display = 'none';
            
            // PostStateManager 상태 초기화
            PostStateManager.setState('none');
        } else {
            Toast.error('포스트 작성 실패: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Toast.error('포스트 작성 중 오류가 발생했습니다.');
    });
}

function addNewPostToFeed(postData) {
    const postsContainer = document.getElementById('posts-container');
    let tagsHtml = '';
    if (postData.tags && postData.tags.length > 0) {
        tagsHtml = '<div style="margin: 10px 0;">';
        postData.tags.forEach(tag => {
            tagsHtml += `<span onclick="toggleFilter('${tag}')" style="display: inline-block; background: #f0f8ff; color: #1d9bf0; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-right: 6px; cursor: pointer;">#${tag}</span>`;
        });
        tagsHtml += '</div>';
    }
    
    // 새 포스트 HTML 생성
    const newPostHTML = `
        <div class="post-card" style="position: relative;">
            <div class="post-menu-btn" data-post-id="${postData.id}" data-is-my-post="true">
                <span class="material-symbols-outlined">more_horiz</span>
            </div>

            <div style="display: flex; align-items: flex-start; gap: 12px;">
                <!-- 프로필 이미지 -->
                <a href="/profile/${postData.my_ID}/" style="text-decoration: none;">
                    <div style="width: 32px; height: 32px; background: #1d9bf0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
                        ${postData.my_ID.charAt(0).toUpperCase()}
                    </div>
                </a>
                
                <!-- 오른쪽 모든 내용 -->
                <div style="flex: 1; margin-top: -4px;">
                    <!-- 사용자명과 시간 -->
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <a href="/profile/${postData.my_ID}/" style="text-decoration: none; display: flex; align-items: center; gap: 4px;">
                            <span style="font-weight: bold; color: #0f1419;">${postData.nickname || postData.my_ID}</span>
                            <span style="color: #536471; font-weight: normal;">@${postData.my_ID}</span>
                        </a>
                        <span style="color: #536471; font-size: 14px;">·</span>
                        <span style="color: #536471; font-size: 14px;">방금 전</span>
                    </div>
                    
                    <!-- 포스트 내용 -->
                    <div class="post-content">
                        ${postData.content}
                    </div>

                    ${postData.image_url ? `
                    <div style="margin: 10px 0;">
                        <div style="width: 100%; aspect-ratio: 16/9; overflow: hidden; border-radius: 12px; border: 1px solid #eff3f4; cursor: pointer;" onclick="openImageModal('${postData.image_url}')">
                            <img data-src="${postData.image_url}" 
                                src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='225'%3E%3Crect width='100%25' height='100%25' fill='%23f0f0f0'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' fill='%23999'%3E이미지 로딩중...%3C/text%3E%3C/svg%3E"
                                alt="첨부 이미지" 
                                class="lazy-image"
                                style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                    </div>
                    ` : ''}
                    ${tagsHtml}
                    <div class="action-buttons">
                        <div class="action-btn">
                            <span class="material-symbols-outlined">chat_bubble</span>
                            <span>0</span>
                        </div>
                        
                        <div class="action-btn">
                            <span class="material-symbols-outlined">favorite</span>
                            <span>0</span>
                        </div>
                        
                        <div class="action-btn">
                            <span class="material-symbols-outlined">bookmark</span>
                            <span>0</span>
                        </div>
                        
                        <div class="action-btn">
                            <span class="material-symbols-outlined">share</span>
                            <span>0</span>
                        </div>
                    </div>
                                    </div> 
                                </div>
                            </div>
                        `;
                        
                        // 피드 맨 위에 새 포스트 추가
                        postsContainer.insertAdjacentHTML('afterbegin', newPostHTML);
                        LazyLoader.observeNewImages();
                    }
// 무한 스크롤용 포스트 추가 (기존 함수 재사용)
function addPostToFeed(postData) {
    const postsContainer = document.getElementById('posts-container');
    
    // asset_class 관련 제거하고 기존 함수 로직 재사용
    const modifiedPostData = {
        ...postData,
        username: postData.my_ID,
        asset_class: '',
        asset_class_display: ''
    };
    
    let tagsHtml = '';
    if (postData.tags && postData.tags.length > 0) {
        tagsHtml = '<div style="margin: 10px 0;">';
        postData.tags.forEach(tag => {
            tagsHtml += `<span onclick="toggleFilter('${tag}')" style="display: inline-block; background: #f0f8ff; color: #1d9bf0; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-right: 6px; cursor: pointer;">#${tag}</span>`;
        });
        tagsHtml += '</div>';
    }
    
    const newPostHTML = `
        <div class="post-card">
            <div class="post-header">
                <span class="post-username">${postData.my_ID}</span>
                <span class="post-time">${postData.created_at}</span>
            </div>
            
            <div class="post-content">
                ${postData.content}
            </div>
            
            ${postData.image_url ? `
            <div style="margin: 10px 0;">
                <div style="width: 100%; aspect-ratio: 16/9; overflow: hidden; border-radius: 12px; border: 1px solid #eff3f4; cursor: pointer;" onclick="openImageModal('${postData.image_url}')">
                    <img data-src="${postData.image_url}" 
                        src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='225'%3E%3Crect width='100%25' height='100%25' fill='%23f0f0f0'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' fill='%23999'%3E이미지 로딩중...%3C/text%3E%3C/svg%3E"
                        alt="첨부 이미지" 
                        class="lazy-image"
                        style="width: 100%; height: 100%; object-fit: cover;">
                </div>
            </div>
            ` : ''}
            
            ${tagsHtml}
            
            <div class="action-buttons">
                <div class="action-btn" data-action="comments" data-post-id="${postData.id}">
                    <span class="material-symbols-outlined">chat_bubble</span>
                    <span>${postData.comments_count}</span>
                </div>
                <div class="action-btn" data-action="like" data-post-id="${postData.id}">
                    <span class="material-symbols-outlined${postData.is_liked ? ' liked' : ''}">${postData.is_liked ? 'favorite' : 'favorite_border'}</span>
                    <span>${postData.likes_count}</span>
                </div>
                <div class="action-btn" data-action="bookmark" data-post-id="${postData.id}">
                    <span class="material-symbols-outlined">bookmark_border</span>
                    <span>${postData.bookmarks_count}</span>
                </div>
                <div class="action-btn" data-action="share" data-post-id="${postData.id}">
                    <span class="material-symbols-outlined">share</span>
                    <span>${postData.shares_count}</span>
                </div>
            </div>
        </div>
    `;
    
    // 애니메이션 클래스 추가
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = newPostHTML;
    const postElement = tempDiv.firstElementChild;
    postElement.classList.add('fade-in');

    postsContainer.appendChild(postElement);
    LazyLoader.observeNewImages();
    }
// 캐러셀 변수
let currentSlide = 0;
const totalSlides = 3; // 총 3개 슬라이드 (9개 뉴스 ÷ 3개 = 3개)

// 슬라이드 표시 함수
function showSlide(slideIndex) {
    const newsItems = document.querySelectorAll('.news-item');
    const dots = document.querySelectorAll('.dot');
    
    // 모든 뉴스 아이템 숨기기
    newsItems.forEach(item => {
        item.classList.add('hidden');
    });
    
    // 해당 슬라이드의 뉴스 아이템들 보이기 (3개씩)
    for (let i = slideIndex * 3; i < (slideIndex + 1) * 3; i++) {
        if (newsItems[i]) {
            newsItems[i].classList.remove('hidden');
        }
    }
    
    // 모든 점 비활성화
    dots.forEach(dot => {
        dot.style.background = '#ccc';
    });
    
    // 현재 점 활성화
    if (dots[slideIndex]) {
        dots[slideIndex].style.background = '#1d9bf0';
    }
    
    currentSlide = slideIndex;
}

// 이전 슬라이드
function prevSlide() {
    const newSlide = currentSlide === 0 ? totalSlides - 1 : currentSlide - 1;
    showSlide(newSlide);
}

// 다음 슬라이드
function nextSlide() {
    const newSlide = currentSlide === totalSlides - 1 ? 0 : currentSlide + 1;
    showSlide(newSlide);
}

// 자동 슬라이드 (5초마다)
let autoSlideInterval = setInterval(nextSlide, 10000);

// 호버시 자동 슬라이드 정지
const carousel = document.querySelector('.news-carousel');
if (carousel) {
    carousel.addEventListener('mouseenter', () => {
        clearInterval(autoSlideInterval);
    });
    
    carousel.addEventListener('mouseleave', () => {
        autoSlideInterval = setInterval(nextSlide, 10000);
    });
}
// CSRF 토큰 가져오기 함수 
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// 사용자 인증 확인 함수
function isUserAuthenticated() {
    const authData = document.getElementById('auth-data');
    return authData.getAttribute('data-authenticated') === 'true';
}

// 좋아요 토글 함수
function toggleLike(postId) {
    if (!isUserAuthenticated()) {
        Toast.warning('로그인이 필요합니다.');
        return;
    }

    const likeBtn = document.getElementById('like-btn-' + postId);
    const likeIcon = document.getElementById('like-icon-' + postId);
    const likesCount = document.getElementById('likes-count-' + postId);
    
    const isCurrentlyLiked = likeIcon.textContent === 'favorite';
    
    // 낙관적 업데이트
    likeIcon.textContent = isCurrentlyLiked ? 'favorite_border' : 'favorite';
    likeIcon.style.color = isCurrentlyLiked ? '#536471' : '#e91e63';
    
    const currentCount = parseInt(likesCount.textContent);
    likesCount.textContent = isCurrentlyLiked ? currentCount - 1 : currentCount + 1;
    
    // 서버 요청
    fetch('/home/post/' + postId + '/like/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
    })
    .then(response => response.json())
    .then(data => {
        likeIcon.textContent = data.liked ? 'favorite' : 'favorite_border';
        if (data.liked) {
            likeIcon.classList.add('liked');
        } else {
            likeIcon.classList.remove('liked');
        }
        likesCount.textContent = data.likes_count;
    })
    .catch(error => {
        console.error('오류:', error);
        likeIcon.textContent = isCurrentlyLiked ? 'favorite' : 'favorite_border';
        if (isCurrentlyLiked) {
            likeIcon.classList.add('liked');
        } else {
            likeIcon.classList.remove('liked');
        }
        likesCount.textContent = currentCount;
        Toast.error('오류가 발생했습니다.');
    });
}
// 북마크 토글 함수
function toggleBookmark(postId) {
    if (!isUserAuthenticated()) {
        Toast.warning('로그인이 필요합니다.');
        return;
    }

    const bookmarkBtn = document.querySelector('[data-post-id="' + postId + '"][data-action="bookmark"]');
    const bookmarkIcon = bookmarkBtn.querySelector('.material-symbols-outlined');
    const bookmarksCount = bookmarkBtn.querySelector('span:last-child');
    
    const isCurrentlyBookmarked = bookmarkIcon.textContent === 'bookmark';
    
    // 낙관적 업데이트
    bookmarkIcon.textContent = isCurrentlyBookmarked ? 'bookmark_border' : 'bookmark';
    bookmarkIcon.style.color = isCurrentlyBookmarked ? '#536471' : '#1d9bf0';
    
    const currentCount = parseInt(bookmarksCount.textContent);
    bookmarksCount.textContent = isCurrentlyBookmarked ? currentCount - 1 : currentCount + 1;
    
    // 서버 요청
    fetch('/home/post/' + postId + '/bookmark/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
    })
    .then(response => response.json())
    .then(data => {
        bookmarkIcon.textContent = data.bookmarked ? 'bookmark' : 'bookmark_border';
        if (data.bookmarked) {
            bookmarkIcon.classList.add('bookmarked');
        } else {
            bookmarkIcon.classList.remove('bookmarked');
        }
        bookmarksCount.textContent = data.bookmarks_count;
    })
    .catch(error => {
        console.error('오류:', error);
        bookmarkIcon.textContent = isCurrentlyBookmarked ? 'bookmark' : 'bookmark_border';
        bookmarkIcon.style.color = isCurrentlyBookmarked ? '#1d9bf0' : '#536471';
        bookmarksCount.textContent = currentCount;
        Toast.error('북마크 처리 중 오류가 발생했습니다.');
    });
}   
// 댓글 토글 함수 (댓글 섹션 열기/닫기)
function toggleComments(postId) {
    const commentsSection = document.getElementById('comments-' + postId);
    
    if (commentsSection.style.display === 'none' || commentsSection.style.display === '') {
        commentsSection.style.display = 'block';
        loadComments(postId);
    } else {
        commentsSection.style.display = 'none';
    }
}

// 댓글 목록 로드
function loadComments(postId) {
    fetch('/home/post/' + postId + '/comments/')
    .then(response => response.json())
    .then(data => {
        displayComments(postId, data.comments);
    })
    .catch(error => {
        console.error('댓글 로드 오류:', error);
    });
}

// 댓글 제출
function submitComment(postId) {
    if (!isUserAuthenticated()) {
        Toast.warning('로그인이 필요합니다.');
        return;
    }
    
    const commentInput = document.getElementById('comment-input-' + postId);
    const content = commentInput.value.trim();
    
    if (!content) {
        Toast.warning('댓글 내용을 입력해주세요.');
        return;
    }
    
    fetch('/home/post/' + postId + '/comment/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.comment_id) {
            commentInput.value = '';
            const commentsCountElement = document.querySelector(`[data-post-id="${postId}"][data-action="comments"] span:last-child`);
            commentsCountElement.textContent = data.comments_count;
            loadComments(postId);
        } else {
            Toast.error(data.error || '댓글 작성 중 오류가 발생했습니다.');
        }
    })
    .catch(error => {
        console.error('댓글 작성 오류:', error);
        Toast.error('댓글 작성 중 오류가 발생했습니다.');
    });
}

function displayComments(postId, comments) {
    const commentsList = document.getElementById('comments-list-' + postId);
    
    if (comments.length === 0) {
        commentsList.innerHTML = '<div style="color: #536471; text-align: center; padding: 20px;">아직 댓글이 없습니다.</div>';
        return;
    }
    
    let commentsHTML = '';
    comments.forEach(comment => {
        const timeAgo = getRelativeTime(comment.created_at);
        const isMyComment = isUserAuthenticated() && comment.my_ID === getCurrentUserId();
        
        commentsHTML += `
            <div class="comment" style="margin-bottom: 12px;" id="comment-${comment.id}">
                <div style="display: flex; align-items: flex-start; gap: 8px;">
                    <!-- 댓글 작성자 프로필 아이콘 -->
                    <a href="/profile/${comment.my_ID}/" style="text-decoration: none;">
                        <div style="width: 24px; height: 24px; background: #1d9bf0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px; flex-shrink: 0;">
                            ${comment.my_ID ? comment.my_ID.charAt(0).toUpperCase() : 'U'}
                        </div>
                    </a>
                    
                    <!-- 댓글 내용 -->
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 2px;">
                            <a href="/profile/${comment.my_ID}/" style="text-decoration: none; display: flex; align-items: center; gap: 4px;">
                                <span style="font-weight: bold; color: #0f1419; font-size: 14px;">${comment.nickname || comment.my_ID}</span>
                                <span style="color: #536471; font-size: 12px; font-weight: normal;">@${comment.my_ID}</span>
                            </a>
                            <span style="color: #536471; font-size: 12px;">·</span>
                            <span style="color: #536471; font-size: 12px;">${timeAgo}</span>
                            ${comment.is_edited ? '<span style="color: #536471; font-size: 11px; margin-left: 4px;">(수정됨)</span>' : ''}
                        </div>
                        
                        <div class="comment-content" style="color: #0f1419; line-height: 1.4; font-size: 14px; margin-bottom: 8px;">
                            ${comment.content}
                        </div>
                        
                        <!-- 댓글 액션 버튼들 -->
                        <div style="display: flex; gap: 16px; font-size: 13px; color: #536471;">
                            <button onclick="showReplyForm(${comment.id})" style="background: none; border: none; color: #536471; cursor: pointer; font-size: 13px;">
                                답글
                            </button>
                            
                            ${isMyComment ? `
                                <button onclick="editComment(${comment.id})" style="background: none; border: none; color: #536471; cursor: pointer; font-size: 13px;">
                                    수정
                                </button>
                                <button onclick="deleteComment(${comment.id})" style="background: none; border: none; color: #536471; cursor: pointer; font-size: 13px;">
                                    삭제
                                </button>
                            ` : ''}
                        </div>
                        <!-- 기존 대댓글들 표시 -->
                        ${comment.replies && comment.replies.length > 0 ? comment.replies.map(reply => {
                            const isMyReply = isUserAuthenticated() && reply.my_ID === getCurrentUserId();
                            const replyTimeAgo = getRelativeTime(reply.created_at);
                            
                            return `
                                <div class="reply" style="margin-left: 32px; margin-top: 8px; padding-top: 8px; border-top: 1px solid #f0f0f0;" id="reply-${reply.id}">
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <a href="/profile/${reply.my_ID}/" style="text-decoration: none;">
                                            <div style="width: 20px; height: 20px; background: #1d9bf0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 10px; flex-shrink: 0;">
                                                ${reply.my_ID.charAt(0).toUpperCase()}
                                            </div>
                                        </a>
                                        
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 2px;">
                                                <a href="/profile/${reply.my_ID}/" style="text-decoration: none; display: flex; align-items: center; gap: 4px;">
                                                    <span style="font-weight: bold; color: #0f1419; font-size: 13px;">${reply.nickname || reply.my_ID}</span>
                                                    <span style="color: #536471; font-size: 11px; font-weight: normal;">@${reply.my_ID}</span>
                                                </a>
                                                <span style="color: #536471; font-size: 11px;">·</span>
                                                <span style="color: #536471; font-size: 11px;">${replyTimeAgo}</span>
                                                ${reply.is_edited ? '<span style="color: #536471; font-size: 10px; margin-left: 4px;">(수정됨)</span>' : ''}
                                            </div>
                                            
                                            <div class="reply-content" style="color: #0f1419; line-height: 1.4; font-size: 13px; margin-bottom: 6px;">
                                                ${reply.content}
                                            </div>
                                            
                                            ${isMyReply ? `
                                                <div style="display: flex; gap: 12px; font-size: 12px; color: #536471;">
                                                    <button onclick="editReply(${reply.id})" style="background: none; border: none; color: #536471; cursor: pointer; font-size: 12px;">수정</button>
                                                    <button onclick="deleteReply(${reply.id})" style="background: none; border: none; color: #536471; cursor: pointer; font-size: 12px;">삭제</button>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('') : ''}
                        <!-- 대댓글 작성 폼 (처음에는 숨김) -->
                        <div id="reply-form-${comment.id}" style="display: none; margin-top: 12px;">
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="reply-input-${comment.id}" placeholder="답글을 입력하세요..." 
                                       style="flex: 1; padding: 6px 12px; border: 1px solid #eff3f4; border-radius: 20px; outline: none; font-size: 13px;">
                                <button onclick="submitReply(${postId}, ${comment.id})" 
                                        style="padding: 6px 12px; background: #1d9bf0; color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 13px;">
                                    작성
                                </button>
                                <button onclick="hideReplyForm(${comment.id})" 
                                        style="padding: 6px 12px; background: #f0f0f0; color: #333; border: none; border-radius: 20px; cursor: pointer; font-size: 13px;">
                                    취소
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    commentsList.innerHTML = commentsHTML;
}

// 현재 사용자 ID 가져오기 함수 추가
function getCurrentUserId() {
    // 페이지에서 현재 사용자 정보를 가져오는 방법
    // 방법 1: HTML에 숨겨진 데이터로 추가
    return document.querySelector('meta[name="current-user"]')?.content || null;
}
// 공유 기능
function sharePost(postId) {
    if (!isUserAuthenticated()) {
        Toast.warning('로그인이 필요합니다.');
        return;
    }
    
    // 먼저 공유 카운트 증가 (사용자당 1회)
    toggleShareCount(postId);
    
    // 그 다음 공유 도구 제공
    const postUrl = window.location.origin + '/post/' + postId + '/';
    showShareOptions(postUrl);
}

// 공유 카운트 토글 (사용자당 1회)
function toggleShareCount(postId) {
    fetch('/post/' + postId + '/share/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
    })
    .then(response => response.json())
    .then(data => {
        const sharesCount = document.getElementById('shares-count-' + postId);
        sharesCount.textContent = data.shares_count;
        
        // 공유 상태에 따라 아이콘 색상 변경
        const shareIcon = document.getElementById('share-icon-' + postId);
        shareIcon.style.color = data.shared ? '#1d9bf0' : '#536471';
    })
    .catch(error => {
        console.error('공유 카운트 오류:', error);
    });
}

// 공유 도구 모달 표시
function showShareOptions(postUrl) {
    const shareOptions = [
        { name: 'KakaoTalk', icon: '💬', color: '#FEE500', textColor: '#3C1E1E', action: () => shareToKakao(postUrl) },
        { name: 'Instagram', icon: '📷', color: 'linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%)', textColor: '#ffffff', action: () => shareToInstagram(postUrl) },
        { name: 'Twitter', icon: '🐦', color: '#1DA1F2', textColor: '#ffffff', action: () => shareToTwitter(postUrl) },
        { name: 'URL 복사', icon: '🔗', color: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', textColor: '#ffffff', action: () => copyToClipboard(postUrl) }
    ];
    
    let optionsHtml = `
    <div style="padding: 32px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 20px;">
        <div style="text-align: center; margin-bottom: 24px;">
            <div style="font-size: 24px; margin-bottom: 8px;">✨</div>
            <h3 style="margin: 0; font-size: 20px; font-weight: 700; color: #2d3748; letter-spacing: -0.5px;">공유하기</h3>
            <p style="margin: 8px 0 0 0; color: #718096; font-size: 14px;">친구들과 이 포스트를 공유해보세요!</p>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
    `;
    
    shareOptions.forEach((option, index) => {
        optionsHtml += `
            <button onclick="handleShareOption(${index})" 
                style="
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    padding: 20px 16px;
                    background: ${option.color};
                    color: ${option.textColor};
                    border: none;
                    border-radius: 16px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 600;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    position: relative;
                    overflow: hidden;
                "
                onmouseover="
                    this.style.transform='translateY(-2px) scale(1.02)';
                    this.style.boxShadow='0 8px 25px rgba(0,0,0,0.25)';
                "
                onmouseout="
                    this.style.transform='translateY(0) scale(1)';
                    this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';
                "
                onmousedown="this.style.transform='translateY(-1px) scale(0.98)'"
                onmouseup="this.style.transform='translateY(-2px) scale(1.02)'"
            >
                <div style="font-size: 24px; margin-bottom: 8px;">${option.icon}</div>
                <div style="font-size: 13px; font-weight: 600;">${option.name}</div>
            </button>
        `;
    });
    
    optionsHtml += `
        </div>
        <button onclick="closeShareModal()" 
            style="
                width: 100%;
                padding: 14px;
                background: rgba(255,255,255,0.9);
                color: #4a5568;
                border: 2px solid rgba(255,255,255,0.3);
                border-radius: 12px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.2s ease;
                backdrop-filter: blur(10px);
            "
            onmouseover="
                this.style.background='rgba(255,255,255,1)';
                this.style.transform='translateY(-1px)';
            "
            onmouseout="
                this.style.background='rgba(255,255,255,0.9)';
                this.style.transform='translateY(0)';
            "
        >
            닫기
        </button>
    </div>
    `;
    
    // 공유 모달 생성
    const shareModal = document.createElement('div');
    shareModal.id = 'share-modal';
    shareModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: modalFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    `;
    
    const shareContent = document.createElement('div');
    shareContent.style.cssText = `
        background: transparent;
        border-radius: 20px;
        max-width: 360px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        transform-origin: center;
    `;
    shareContent.innerHTML = optionsHtml;
    
    shareModal.appendChild(shareContent);
    
    // CSS 애니메이션 추가
    const style = document.createElement('style');
    style.textContent = `
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes modalSlideIn {
            from { 
                transform: scale(0.7) translateY(20px);
                opacity: 0;
            }
            to { 
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        @keyframes modalSlideOut {
            from { 
                transform: scale(1) translateY(0);
                opacity: 1;
            }
            to { 
                transform: scale(0.7) translateY(-20px);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(shareModal);
    
    // 전역에서 접근 가능하도록 저장
    window.currentShareOptions = shareOptions;
    
    // 모달 외부 클릭시 닫기 (애니메이션 포함)
    shareModal.addEventListener('click', function(e) {
        if (e.target === shareModal) {
            closeShareModalWithAnimation();
        }
    });
    
    // ESC 키로 닫기
    const handleEsc = (e) => {
        if (e.key === 'Escape') {
            closeShareModalWithAnimation();
            document.removeEventListener('keydown', handleEsc);
        }
    };
    document.addEventListener('keydown', handleEsc);
}

// 애니메이션과 함께 모달 닫기
function closeShareModalWithAnimation() {
    const modal = document.getElementById('share-modal');
    const content = modal?.querySelector('div');
    
    if (modal && content) {
        modal.style.animation = 'modalFadeIn 0.2s cubic-bezier(0.4, 0, 0.2, 1) reverse';
        content.style.animation = 'modalSlideOut 0.2s cubic-bezier(0.4, 0, 0.2, 1)';
        
        setTimeout(() => {
            closeShareModal();
        }, 200);
    }
}

// 기존 closeShareModal 함수 수정
function closeShareModal() {
    const modal = document.getElementById('share-modal');
    if (modal) {
        modal.remove();
    }
    window.currentShareOptions = null;
}

// 카카오톡 공유
function shareToKakao(postUrl) {
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        // 모바일에서는 카카오톡 URL 스킴 사용
        const kakaoUrl = `kakaotalk://send?text=${encodeURIComponent('FinTech SNS에서 흥미로운 포스트를 발견했습니다! ' + postUrl)}`;
        window.location.href = kakaoUrl;
        
        // 카카오톡 앱이 없을 경우 대체 방법
        setTimeout(() => {
            copyToClipboard(postUrl);
            Toast.warning('카카오톡 앱으로 연결할 수 없습니다. URL이 복사되었으니 카카오톡에서 직접 붙여넣기 하세요.');
        }, 1000);
    } else {
        // 데스크탑에서는 URL 복사 후 안내
        copyToClipboard(postUrl);
        Toast.warning('URL이 복사되었습니다. 카카오톡에서 붙여넣기 하여 공유하세요.');
    }
    
    closeShareModal();
}

// Instagram 공유
function shareToInstagram(postUrl) {
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        // 모바일에서는 Instagram 앱으로 연결 시도
        const instagramUrl = `instagram://library?AssetPath=${encodeURIComponent(postUrl)}`;
        window.location.href = instagramUrl;
        
        setTimeout(() => {
            copyToClipboard(postUrl);
            Toast.warning('Instagram 앱으로 연결할 수 없습니다. URL이 복사되었으니 Instagram에서 직접 붙여넣기 하세요.');
        }, 1000);
    } else {
        copyToClipboard(postUrl);
        Toast.warning('URL이 복사되었습니다. Instagram 웹사이트나 앱에서 붙여넣기 하여 공유하세요.');
    }
    
    closeShareModal();
}

// Twitter 공유
function shareToTwitter(postUrl) {
    const twitterUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(postUrl)}&text=${encodeURIComponent('FinTech SNS에서 흥미로운 포스트를 발견했습니다!')}`;
    window.open(twitterUrl, '_blank');
    closeShareModal();
}

// URL 클립보드 복사
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        Toast.warning('URL이 클립보드에 복사되었습니다!');
        closeShareModal();
    }).catch(err => {
        console.error('복사 실패:', err);
        Toast.error('복사에 실패했습니다.');
    });
}

// 공유 옵션 처리
function handleShareOption(index) {
    if (window.currentShareOptions && window.currentShareOptions[index]) {
        window.currentShareOptions[index].action();
    }
}

// 공유 모달 닫기
function closeShareModal() {
    const modal = document.getElementById('share-modal');
    if (modal) {
        modal.remove();
    }
    window.currentShareOptions = null;
}
// 실시간 텍스트 입력 처리
function handleTextInput(textarea) {
    const text = textarea.value;
    
    // 해시태그 감지
    const hashtags = extractHashtags(text);
    
    // 해시태그 미리보기 업데이트
    updateHashtagPreview(hashtags);
    
    // 포스트 버튼 상태 업데이트
    PostStateManager.updatePostButton();
}

// 해시태그 추출
function extractHashtags(text) {
    const hashtag_pattern = /#(\w+)/g;
    const matches = text.match(hashtag_pattern);
    return matches ? matches.map(tag => tag.substring(1)) : [];
}

// 해시태그 미리보기 업데이트
function updateHashtagPreview(hashtags) {
    const preview = document.getElementById('hashtag-preview');
    const tagsSpan = document.getElementById('detected-tags');
    
    if (hashtags.length > 0) {
        tagsSpan.innerHTML = hashtags.map(tag => `<span style="background: #e3f2fd; padding: 2px 6px; border-radius: 8px; margin-right: 4px;">#${tag}</span>`).join('');
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
}


// 로딩 스피너 표시
function showLoadingSpinner() {
    let spinner = document.getElementById('loading-spinner');
    if (!spinner) {
        spinner = document.createElement('div');
        spinner.id = 'loading-spinner';
        spinner.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #536471;">
                <div class="loading-spinner" style="display: inline-block; width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #1d9bf0; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <div style="margin-top: 8px;">포스트를 불러오는 중...</div>
            </div>
        `;
        document.getElementById('posts-container').appendChild(spinner);
    }
    spinner.style.display = 'block';
}

// 로딩 스피너 숨기기
function hideLoadingSpinner() {
    const spinner = document.getElementById('loading-spinner');
    if (spinner) {
        spinner.style.display = 'none';
    }
}
// 이미지 지연 로딩 구현
const LazyLoader = {
    observer: null,
    
    init() {
        // Intersection Observer 지원 확인
        if ('IntersectionObserver' in window) {
            this.observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        this.loadImage(entry.target);
                        this.observer.unobserve(entry.target);
                    }
                });
            }, {
                root: null,
                rootMargin: '50px', // 50px 전에 미리 로드
                threshold: 0.1
            });
            
            // 기존 이미지들 관찰 시작
            this.observeImages();
        } else {
            // 구형 브라우저는 즉시 모든 이미지 로드
            this.loadAllImages();
        }
    },
    
    observeImages() {
        const lazyImages = document.querySelectorAll('.lazy-image');
        lazyImages.forEach(img => {
            this.observer.observe(img);
        });
    },
    
    loadImage(img) {
        const src = img.getAttribute('data-src');
        if (src) {
            img.src = src;
            img.classList.add('loaded');
            img.removeAttribute('data-src');
        }
    },
    
    loadAllImages() {
        const lazyImages = document.querySelectorAll('.lazy-image');
        lazyImages.forEach(img => {
            this.loadImage(img);
        });
    },
    
    // 새로운 이미지가 추가될 때 호출
    observeNewImages() {
        const newImages = document.querySelectorAll('.lazy-image:not(.loaded)');
        newImages.forEach(img => {
            if (this.observer) {
                this.observer.observe(img);
            } else {
                this.loadImage(img);
            }
        });
    }
};

// 무한 스크롤 관리 객체
const InfiniteScroll = {
    currentPage: 1,
    isLoading: false,
    hasMorePosts: true,
    debounceTimer: null,
    
    init() {
        window.addEventListener('scroll', () => {
            clearTimeout(this.debounceTimer);
            this.debounceTimer = setTimeout(() => {
                this.handleScroll();
            }, 150);
        });
    },
    
    handleScroll() {
        if (this.isLoading || !this.hasMorePosts) return;
        
        const threshold = 300;
        const scrolled = window.innerHeight + window.scrollY;
        const documentHeight = document.body.offsetHeight;
        
        if (scrolled >= documentHeight - threshold) {
            this.loadMorePosts();
        }
    },
    
    loadMorePosts() {
        this.isLoading = true;
        this.currentPage++;
        
        showLoadingSpinner();
        
        fetch(`/home/load-more-posts/?page=${this.currentPage}`)
            .then(response => response.json())
            .then(data => {
                if (data.posts && data.posts.length > 0) {
                    data.posts.forEach((post, index) => {
                        setTimeout(() => {
                            addPostToFeed(post);
                        }, index * 100); // 100ms 간격으로 순차 등장
                    });
                    this.hasMorePosts = data.has_next;
                } else {
                    this.hasMorePosts = false;
                }
            })
            .catch(error => {
                console.error('포스트 로드 오류:', error);
                this.currentPage--;
            })
            .finally(() => {
                this.isLoading = false;
                hideLoadingSpinner();
            });
    }
};
// 상대시간 계산 함수
function getRelativeTime(dateString) {
    const now = new Date();
    const postTime = new Date(dateString);
    const diffInSeconds = Math.floor((now - postTime) / 1000);
    
    if (diffInSeconds < 60) {
        return "방금 전";
    } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes}분 전`;
    } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours}시간 전`;
    } else if (diffInSeconds < 2592000) {
        const days = Math.floor(diffInSeconds / 86400);
        return `${days}일 전`;
    } else if (diffInSeconds < 31536000) {
        const months = Math.floor(diffInSeconds / 2592000);
        return `${months}개월 전`;
    } else {
        const years = Math.floor(diffInSeconds / 31536000);
        return `${years}년 전`;
    }
}

// 모든 포스트 시간 업데이트
function updateAllPostTimes() {
    const timeElements = document.querySelectorAll('.post-time[data-timestamp]');
    timeElements.forEach(element => {
        const timestamp = element.getAttribute('data-timestamp');
        element.textContent = getRelativeTime(timestamp);
    });
}

// 1분마다 시간 업데이트
setInterval(updateAllPostTimes, 60000);
// 포스트 수정 모달 관련 함수들
function showEditModal(post) {
    const modal = document.createElement('div');
    modal.id = 'edit-modal';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 1000;
        display: flex; align-items: center; justify-content: center;
    `;
    
    const modalContent = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 500px; padding: 20px;">
            <h3 style="margin: 0 0 15px 0;">포스트 수정</h3>
            <textarea id="edit-content" style="width: 100%; height: 120px; border: 1px solid #ddd; border-radius: 8px; padding: 12px; resize: vertical;">${post.content}${post.tags.map(tag => ' #' + tag).join('')}</textarea>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button onclick="submitEdit(${post.id})" style="flex: 1; background: #1d9bf0; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">수정</button>
                <button onclick="closeEditModal()" style="flex: 1; background: #f0f0f0; color: #333; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">취소</button>
            </div>
        </div>
    `;
    
    modal.innerHTML = modalContent;
    document.body.appendChild(modal);
}

function submitEdit(postId) {
    const content = document.getElementById('edit-content').value.trim();
    
    if (!content) {
        Toast.warning('내용을 입력해주세요.');
        return;
    }
    
    fetch(`/home/post/${postId}/edit/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updatePostInDOM(postId, data.post);
            closeEditModal();
            Toast.success('포스트가 수정되었습니다.');
        } else {
            Toast.error(data.error);
        }
    })
    .catch(error => {
        Toast.error('수정 중 오류가 발생했습니다.');
    });
}

function updatePostInDOM(postId, postData) {
    const postCard = document.querySelector(`[data-post-id="${postId}"]`).closest('.post-card');
    const contentElement = postCard.querySelector('.post-content');
    
    contentElement.textContent = postData.content;
    
    // 기존 태그 제거
    const existingTagsDiv = contentElement.nextElementSibling;
    if (existingTagsDiv && existingTagsDiv.querySelector('span[onclick*="toggleFilter"]')) {
        existingTagsDiv.remove();
    }
    
    // 새 태그 추가
    if (postData.tags.length > 0) {
        let tagsHtml = '<div style="margin: 10px 0;">';
        postData.tags.forEach(tag => {
            tagsHtml += `<span onclick="toggleFilter('${tag}')" style="display: inline-block; background: #f0f8ff; color: #1d9bf0; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-right: 6px; margin-bottom: 4px; cursor: pointer; border: 1px solid #e1f5fe;">#${tag}</span>`;
        });
        tagsHtml += '</div>';
        contentElement.insertAdjacentHTML('afterend', tagsHtml);
    }
}

function closeEditModal() {
    const modal = document.getElementById('edit-modal');
    if (modal) modal.remove();
}

// 신고 모달 관련 함수들
function showReportModal(postId) {
    const modal = document.createElement('div');
    modal.id = 'report-modal';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 1000;
        display: flex; align-items: center; justify-content: center;
    `;
    
    const modalContent = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 400px; padding: 20px;">
            <h3 style="margin: 0 0 15px 0;">포스트 신고</h3>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px;"><input type="radio" name="report-reason" value="spam" style="margin-right: 8px;"> 스팸</label>
                <label style="display: block; margin-bottom: 8px;"><input type="radio" name="report-reason" value="abuse" style="margin-right: 8px;"> 욕설/비방</label>
                <label style="display: block; margin-bottom: 8px;"><input type="radio" name="report-reason" value="inappropriate" style="margin-right: 8px;"> 부적절한 내용</label>
                <label style="display: block; margin-bottom: 8px;"><input type="radio" name="report-reason" value="fake" style="margin-right: 8px;"> 허위 정보</label>
                <label style="display: block; margin-bottom: 8px;"><input type="radio" name="report-reason" value="other" style="margin-right: 8px;"> 기타</label>
            </div>
            <textarea id="report-description" placeholder="상세 내용 (선택사항)" style="width: 100%; height: 80px; border: 1px solid #ddd; border-radius: 6px; padding: 8px; resize: vertical;"></textarea>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button onclick="submitReport(${postId})" style="flex: 1; background: #e74c3c; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">신고</button>
                <button onclick="closeReportModal()" style="flex: 1; background: #f0f0f0; color: #333; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">취소</button>
            </div>
        </div>
    `;
    
    modal.innerHTML = modalContent;
    document.body.appendChild(modal);
}

function submitReport(postId) {
    const reason = document.querySelector('input[name="report-reason"]:checked')?.value;
    const description = document.getElementById('report-description').value;
    
    if (!reason) {
        Toast.warning('신고 사유를 선택해주세요.');
        return;
    }
    
    fetch(`/home/post/${postId}/report/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({
            reason: reason,
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeReportModal();
            Toast.success(data.message);
        } else {
            Toast.error(data.error);
        }
    })
    .catch(error => {
        Toast.error('신고 처리 중 오류가 발생했습니다.');
    });
}

function closeReportModal() {
    const modal = document.getElementById('report-modal');
    if (modal) modal.remove();
}
// Toast 메시지 시스템
const Toast = {
    show(message, type = 'info', duration = 3000) {
        // 기존 toast 제거
        const existingToast = document.querySelector('.toast');
        if (existingToast) {
            existingToast.remove();
        }
        
        // 새 toast 생성
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        // 애니메이션 시작
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        // 자동 제거
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 300);
        }, duration);
    },
    
    success(message) {
        this.show(message, 'success');
    },
    
    error(message) {
        this.show(message, 'error');
    },
    
    warning(message) {
        this.show(message, 'warning');
    }
};
function togglePostMenu(postId, isMyPost) {
    // 현재 열린 메뉴가 같은 포스트인지 확인
    const existingMenu = document.querySelector('.post-menu-dropdown');
    if (existingMenu && existingMenu.dataset.postId === postId.toString()) {
        // 같은 버튼 클릭시 메뉴 닫기
        existingMenu.remove();
        return;
    }
    
    // 다른 메뉴가 열려있으면 닫기
    if (existingMenu) {
        existingMenu.remove();
    }
    
    // 메뉴 생성
    const menuDiv = document.createElement('div');
    menuDiv.className = 'post-menu-dropdown show';
    menuDiv.dataset.postId = postId; // 포스트 ID 저장
    
    let menuItems = '';
    
    if (isMyPost) {
        // 내 포스트 메뉴
        menuItems = `
            <div class="menu-item" onclick="editPost(${postId})">
                <span class="material-symbols-outlined" style="font-size: 18px;">edit</span>
                수정하기
            </div>
            <div class="menu-item danger" onclick="deletePost(${postId})">
                <span class="material-symbols-outlined" style="font-size: 18px;">delete</span>
                삭제하기
            </div>
            <div class="menu-item" onclick="copyPostLink(${postId})">
                <span class="material-symbols-outlined" style="font-size: 18px;">link</span>
                링크 복사
            </div>
        `;
    } else {
        // 다른 사람 포스트 메뉴
        menuItems = `
            <div class="menu-item" onclick="copyPostLink(${postId})">
                <span class="material-symbols-outlined" style="font-size: 18px;">link</span>
                링크 복사
            </div>
            <div class="menu-item" onclick="hidePost(${postId})">
                <span class="material-symbols-outlined" style="font-size: 18px;">visibility_off</span>
                관심 없음
            </div>
            <div class="menu-item danger" onclick="reportPost(${postId})">
                <span class="material-symbols-outlined" style="font-size: 18px;">flag</span>
                포스트 신고
            </div>
        `;
    }
    
    menuDiv.innerHTML = menuItems;
    
    // body에 추가하고 위치 계산
    const menuBtn = document.querySelector(`[data-post-id="${postId}"]`);
    const btnRect = menuBtn.getBoundingClientRect();
    
    menuDiv.style.position = 'fixed';
    menuDiv.style.top = btnRect.bottom + 'px';
    menuDiv.style.left = (btnRect.right - 180) + 'px';
    menuDiv.style.width = '180px';
    menuDiv.style.zIndex = '1000';
    
    document.body.appendChild(menuDiv);
    
    // 외부 클릭시 메뉴 닫기
    setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
            if (!menuBtn.contains(e.target) && !menuDiv.contains(e.target)) {
                menuDiv.remove();
                document.removeEventListener('click', closeMenu);
            }
        });
    }, 10);
}
// 메뉴 기능 함수들
function editPost(postId) {
    closePostMenu();
    
    // 포스트 데이터 가져오기
    fetch(`/home/post/${postId}/edit/`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showEditModal(data.post);
        } else {
            Toast.error(data.error);
        }
    })
    .catch(error => {
        Toast.error('포스트 정보를 가져올 수 없습니다.');
    });
}

function deletePost(postId) {
    closePostMenu();
    if (confirm('정말 삭제하시겠습니까?')) {
        fetch(`/home/post/${postId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // DOM에서 포스트 제거
                const postCard = document.querySelector(`[data-post-id="${postId}"]`).closest('.post-card');
                postCard.remove();
                Toast.success('포스트가 삭제되었습니다.');
            } else {
                Toast.error(data.error || '삭제에 실패했습니다.');
            }
        })
        .catch(error => {
            Toast.error('네트워크 오류가 발생했습니다.');
        });
    }
}
function copyPostLink(postId) {
    closePostMenu();
    const postUrl = window.location.origin + `/post/${postId}/`;
    navigator.clipboard.writeText(postUrl).then(() => {
        Toast.success('링크가 복사되었습니다!');
    }).catch(() => {
        Toast.error('링크 복사에 실패했습니다.');
    });
}

function hidePost(postId) {
    closePostMenu();
    
    fetch(`/home/post/${postId}/hide/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const postCard = document.querySelector(`[data-post-id="${postId}"]`).closest('.post-card');
            postCard.style.display = 'none';
            Toast.success('포스트를 숨겼습니다.');
        } else {
            Toast.error(data.error);
        }
    })
    .catch(error => {
        Toast.error('처리 중 오류가 발생했습니다.');
    });
}

function reportPost(postId) {
    closePostMenu();
    showReportModal(postId);
}
function closePostMenu() {
    const existingMenu = document.querySelector('.post-menu-dropdown');
    if (existingMenu) {
        existingMenu.remove();
    }
}
// 댓글 수정 함수
function editComment(commentId) {
    const commentDiv = document.getElementById(`comment-${commentId}`);
    const contentDiv = commentDiv.querySelector('.comment-content');
    const currentContent = contentDiv.textContent;
    
    // 수정 폼으로 교체
    contentDiv.innerHTML = `
        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
            <input type="text" id="edit-comment-input-${commentId}" value="${currentContent}" 
                   style="flex: 1; padding: 6px 12px; border: 1px solid #eff3f4; border-radius: 20px; outline: none; font-size: 13px;">
            <button onclick="saveCommentEdit(${commentId})" 
                    style="padding: 6px 12px; background: #1d9bf0; color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 13px;">
                저장
            </button>
            <button onclick="cancelCommentEdit(${commentId}, '${currentContent}')" 
                    style="padding: 6px 12px; background: #f0f0f0; color: #333; border: none; border-radius: 20px; cursor: pointer; font-size: 13px;">
                취소
            </button>
        </div>
    `;
}

// 댓글 수정 저장
function saveCommentEdit(commentId) {
    const newContent = document.getElementById(`edit-comment-input-${commentId}`).value.trim();
    
    if (!newContent) {
        Toast.warning('댓글 내용을 입력해주세요.');
        return;
    }
    
    fetch(`/home/comment/${commentId}/edit/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({ content: newContent })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const commentDiv = document.getElementById(`comment-${commentId}`);
            const contentDiv = commentDiv.querySelector('.comment-content');
            contentDiv.innerHTML = `${data.comment.content}`;
            
            // (수정됨) 표시 추가
            const timeSpan = commentDiv.querySelector('.comment-time');
            if (timeSpan && !timeSpan.querySelector('.edited-label')) {
                timeSpan.insertAdjacentHTML('afterend', '<span class="edited-label" style="color: #536471; font-size: 11px; margin-left: 4px;">(수정됨)</span>');
            }
            
            Toast.success('댓글이 수정되었습니다.');
        } else {
            Toast.error(data.error);
        }
    })
    .catch(error => {
        Toast.error('댓글 수정 중 오류가 발생했습니다.');
    });
}

// 댓글 수정 취소
function cancelCommentEdit(commentId, originalContent) {
    const commentDiv = document.getElementById(`comment-${commentId}`);
    const contentDiv = commentDiv.querySelector('.comment-content');
    contentDiv.innerHTML = originalContent;
}

// 댓글 삭제
function deleteComment(commentId) {
    if (!confirm('댓글을 삭제하시겠습니까?')) return;
    
    fetch(`/home/comment/${commentId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`comment-${commentId}`).remove();
            Toast.success('댓글이 삭제되었습니다.');
        } else {
            Toast.error(data.error);
        }
    })
    .catch(error => {
        Toast.error('댓글 삭제 중 오류가 발생했습니다.');
    });
}

// 답글 폼 표시
function showReplyForm(commentId) {
    const replyForm = document.getElementById(`reply-form-${commentId}`);
    replyForm.style.display = 'block';
    document.getElementById(`reply-input-${commentId}`).focus();
}

// 답글 폼 숨기기
function hideReplyForm(commentId) {
    const replyForm = document.getElementById(`reply-form-${commentId}`);
    replyForm.style.display = 'none';
    document.getElementById(`reply-input-${commentId}`).value = '';
}

// 답글 작성
function submitReply(postId, parentCommentId) {
    const replyInput = document.getElementById(`reply-input-${parentCommentId}`);
    const content = replyInput.value.trim();
    
    if (!content) {
        Toast.warning('답글 내용을 입력해주세요.');
        return;
    }
    
    fetch(`/home/comment/${parentCommentId}/reply/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.reply_id) {
            // 답글 추가
            addReplyToComment(parentCommentId, data);
            
            // 댓글 수 업데이트
            const commentsCountElement = document.querySelector(`[data-post-id="${postId}"][data-action="comments"] span:last-child`);
            commentsCountElement.textContent = data.comments_count;
            
            // 입력창 초기화 및 숨기기
            replyInput.value = '';
            hideReplyForm(parentCommentId);
            
            Toast.success('답글이 작성되었습니다.');
        } else {
            Toast.error(data.error || '답글 작성 중 오류가 발생했습니다.');
        }
    })
    .catch(error => {
        console.error('답글 작성 오류:', error);
        Toast.error('답글 작성 중 오류가 발생했습니다.');
    });
}
// 댓글에 답글 추가
function addReplyToComment(parentCommentId, replyData) {
    const commentDiv = document.getElementById(`comment-${parentCommentId}`);
    const timeAgo = '방금 전';
    const currentUserId = getCurrentUserId();
    const isMyReply = replyData.my_ID === currentUserId;
    
    // 대댓글 HTML 생성
    const replyHTML = `
        <div class="reply" style="margin-left: 32px; margin-top: 8px; padding-top: 8px; border-top: 1px solid #f0f0f0;" id="reply-${replyData.reply_id}">
            <div style="display: flex; align-items: flex-start; gap: 8px;">
                <!-- 답글 작성자 프로필 아이콘 -->
                <a href="/profile/${replyData.my_ID}/" style="text-decoration: none;">
                    <div style="width: 20px; height: 20px; background: #1d9bf0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 10px; flex-shrink: 0;">
                        ${replyData.my_ID.charAt(0).toUpperCase()}
                    </div>
                </a>
                
                <!-- 답글 내용 -->
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 2px;">
                        <a href="/profile/${replyData.my_ID}/" style="text-decoration: none; display: flex; align-items: center; gap: 4px;">
                            <span style="font-weight: bold; color: #0f1419; font-size: 13px;">${replyData.nickname || replyData.my_ID}</span>
                            <span style="color: #536471; font-size: 11px; font-weight: normal;">@${replyData.my_ID}</span>
                        </a>
                        <span style="color: #536471; font-size: 11px;">·</span>
                        <span style="color: #536471; font-size: 11px;">${timeAgo}</span>
                    </div>
                    
                    <div class="reply-content" style="color: #0f1419; line-height: 1.4; font-size: 13px; margin-bottom: 6px;">
                        ${replyData.content}
                    </div>
                    
                    <!-- 답글 액션 버튼들 -->
                    ${isMyReply ? `
                        <div style="display: flex; gap: 12px; font-size: 12px; color: #536471;">
                            <button onclick="editReply(${replyData.reply_id})" style="background: none; border: none; color: #536471; cursor: pointer; font-size: 12px;">
                                수정
                            </button>
                            <button onclick="deleteReply(${replyData.reply_id})" style="background: none; border: none; color: #536471; cursor: pointer; font-size: 12px;">
                                삭제
                            </button>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
    
    // 기존 대댓글들 뒤에 추가
    const existingReplies = commentDiv.querySelectorAll('.reply');
    if (existingReplies.length > 0) {
        // 마지막 대댓글 뒤에 추가
        existingReplies[existingReplies.length - 1].insertAdjacentHTML('afterend', replyHTML);
    } else {
        // 첫 번째 대댓글이면 답글 폼 앞에 추가
        const replyForm = document.getElementById(`reply-form-${parentCommentId}`);
        replyForm.insertAdjacentHTML('beforebegin', replyHTML);
    }
}
// 이벤트 리스너 등록
document.addEventListener('DOMContentLoaded', function() {
    showSlide(0);
    
    // LazyLoader 초기화 추가
    LazyLoader.init();

    updateAllPostTimes();
    
    setTimeout(() => {
        InfiniteScroll.init();
    }, 2000);
    document.addEventListener('click', function(e) {
        if (e.target.closest('.post-menu-btn')) {
            const menuBtn = e.target.closest('.post-menu-btn');
            const postId = menuBtn.getAttribute('data-post-id');
            const isMyPost = menuBtn.getAttribute('data-is-my-post') === 'true';
            
            togglePostMenu(postId, isMyPost);
        }
    });
    
    // 모든 action 버튼에 클릭 이벤트 추가
    document.querySelectorAll('.action-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const action = this.getAttribute('data-action');
            const postId = this.getAttribute('data-post-id');
            
            if (action === 'like') {
                toggleLike(postId);
            } else if (action === 'comments') {
                toggleComments(postId);

            } else if (action === 'bookmark') {
                toggleBookmark(postId);

            } else if (action === 'share') {
                sharePost(postId);
            }
        });
    });
    // 댓글 작성 버튼들
    document.querySelectorAll('[data-action="submit-comment"]').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const postId = this.getAttribute('data-post-id');
            submitComment(postId);
        });
    });
});

</script>
{% endblock %}