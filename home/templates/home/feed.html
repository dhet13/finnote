{% extends 'home/base.html' %}

{% block title %}í™ˆ í”¼ë“œ - FinTech SNS{% endblock %}

{% block content %}
<div style="display: none;" id="auth-data" data-authenticated="{% if user.is_authenticated %}true{% else %}false{% endif %}"></div>

{% if user.is_authenticated %}
    <meta name="current-user" content="{{ user.my_ID }}">
{% endif %}


<!-- í¬ìŠ¤íŠ¸ ì‘ì„± ì˜ì—­ -->
<form method="POST" action="{% url 'home:create_simple_post' %}" enctype="multipart/form-data" style="border-bottom: 1px solid #eff3f4; padding: 15px;" onsubmit="submitPost(event)">
    {% csrf_token %}
    <div style="display: flex; align-items: flex-start; gap: 12px;">
        {% if user.is_authenticated %}
            <a href="{% url 'user_profile:profile' my_ID=user.my_ID %}" style="text-decoration: none;">
                {% if user.profile_picture %}
                    <img src="{{ user.profile_picture.url }}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                {% else %}
                    <div style="width: 40px; height: 40px; background: #1d9bf0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px;">
                        {{ user.my_ID|first|upper }}
                    </div>
                {% endif %}
            </a>
        {% else %}
            <div style="width: 40px; height: 40px; background: #ccc; border-radius: 50%;"></div>
        {% endif %}
                        
        <!-- ì…ë ¥ ì˜ì—­ -->
        <div style="flex: 1;">
            <div style="position: relative;">
                <textarea name="content" id="post-content" placeholder="What's happening?" 
                    style="width: 100%; min-height: 50px; font-size: 18px; color: #0f1419; border: none; outline: none; resize: none; padding: 12px 0; border-bottom: 1px solid #eff3f4; margin-bottom: 12px; background: transparent; font-family: inherit;" 
                    oninput="handleTextInput(this)" 
                    onkeyup="handleTextInput(this)"></textarea>
                
                <!-- í•´ì‹œíƒœê·¸ ë¯¸ë¦¬ë³´ê¸° -->
                <div id="hashtag-preview" style="font-size: 14px; color: #1d9bf0; margin-bottom: 8px; display: none;">
                    <strong>ê°ì§€ëœ í•´ì‹œíƒœê·¸:</strong> <span id="detected-tags"></span>
                </div>
            </div>

            <input type="file" id="image-input" name="image" accept="image/*" style="display: none;" onchange="previewImage(this)">
            
            <div id="image-preview" style="display: none; margin-bottom: 12px; position: relative;">
                <div style="width: 100%; aspect-ratio: 16/9; overflow: hidden; border-radius: 12px; border: 1px solid #eff3f4; position: relative;">
                    <img id="preview-img" style="width: 100%; height: 100%; object-fit: cover;">
                    <button type="button" onclick="removeImage()" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 12px;">âœ•</button>
                </div>
            </div>

            <!-- ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; gap: 16px;">
                    <button type="button" id="trading-journal-btn" onclick="openTradingJournal()" style="display: inline-block; padding: 8px; border-radius: 50%; transition: background-color 0.2s; margin-right: 12px; background: none; border: none; cursor: pointer;" 
                    onmouseover="this.style.backgroundColor='rgba(29, 155, 240, 0.1)'" 
                    onmouseout="this.style.backgroundColor='transparent'"
                    title="ë§¤ë§¤ì¼ì§€ ì‘ì„±">
                        <span class="material-symbols-outlined" style="color: #1d9bf0; font-size: 20px;">assessment</span>
                    </button>

                    <button type="button" id="image-upload-btn" onclick="document.getElementById('image-input').click()" style="display: inline-block; padding: 8px; border-radius: 50%; transition: background-color 0.2s; background: none; border: none; cursor: pointer;"
                    onmouseover="this.style.backgroundColor='rgba(29, 155, 240, 0.1)'" 
                    onmouseout="this.style.backgroundColor='transparent'"
                    title="ì´ë¯¸ì§€ ì²¨ë¶€">
                        <span class="material-symbols-outlined" style="color: #1d9bf0; font-size: 20px;">image</span>
                    </button>
                </div>
                
                <button type="submit" id="post-button" style="background: #1d9bf0; color: white; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; opacity: 0.5;" disabled>
                    Post
                </button>
            </div>
        </div>
    </div>
</form>



<!-- í•„í„° ë²„íŠ¼ -->
<div style="padding: 12px 16px; border-bottom: 1px solid #eff3f4; background: #f7f9fa;">
    <div style="display: flex; gap: 8px; align-items: center; width: 100%;">
        <!-- íƒœê·¸ ë²„íŠ¼ë“¤ - ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì˜ì—­ -->
        <div style="display: flex; gap: 8px; align-items: center; flex: 1; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none; white-space: nowrap;">
            <button onclick="toggleFilter('ë§¤ë§¤ì¼ì§€')" id="filter-ë§¤ë§¤ì¼ì§€" style="background: #ffffff; color: #0f1419; border: 1px solid #eff3f4; padding: 6px 12px; border-radius: 20px; font-size: 14px; cursor: pointer; flex-shrink: 0;">
                #ë§¤ë§¤ì¼ì§€
            </button>
            <button onclick="toggleFilter('ì£¼ì‹')" id="filter-ì£¼ì‹" style="background: #ffffff; color: #0f1419; border: 1px solid #eff3f4; padding: 6px 12px; border-radius: 20px; font-size: 14px; cursor: pointer; flex-shrink: 0;">
                #ì£¼ì‹
            </button>
            <button onclick="toggleFilter('ë¶€ë™ì‚°')" id="filter-ë¶€ë™ì‚°" style="background: #ffffff; color: #0f1419; border: 1px solid #eff3f4; padding: 6px 12px; border-radius: 20px; font-size: 14px; cursor: pointer; flex-shrink: 0;">
                #ë¶€ë™ì‚°
            </button>
            
            <!-- ì¶”ê°€ íƒœê·¸ë“¤ -->
            <div id="custom-tags-container" style="display: flex; gap: 8px;"></div>
        </div>
        
        <!-- íƒœê·¸ ì¶”ê°€ ì…ë ¥ì°½ - ê³ ì • ìœ„ì¹˜ -->
        <div style="display: flex; gap: 4px; align-items: center; flex-shrink: 0;">
            <input type="text" id="tag-input" placeholder="íƒœê·¸ ì¶”ê°€" maxlength="10" 
                style="width: 80px; padding: 4px 8px; border: 1px solid #eff3f4; border-radius: 12px; font-size: 13px;"
                onkeypress="handleTagInput(event)">
            <button onclick="addCustomTag()" id="add-tag-btn" 
                style="background: #1d9bf0; color: white; border: none; padding: 4px 8px; border-radius: 12px; font-size: 12px; cursor: pointer;">
                ì¶”ê°€
            </button>
        </div>
    </div>
</div>

<!-- í¬ìŠ¤íŠ¸ í”¼ë“œ -->
<div id="posts-container">
    {% if posts %}
        {% for post in posts %}
        <div class="post-card" data-post-type="{{ post.asset_class }}" style="position: relative;">
            <!-- ë©”ë‰´ ë²„íŠ¼ì„ ë³„ë„ë¡œ ìµœìƒë‹¨ì— ë°°ì¹˜ -->
            <div class="post-menu-btn" data-post-id="{{ post.id }}" data-is-my-post="{% if user.is_authenticated and post.user == user %}true{% else %}false{% endif %}" style="position: absolute; top: 8px; right: 8px; z-index: 10;">
                <span class="material-symbols-outlined">more_horiz</span>
            </div>
            
            <div style="display: flex; align-items: flex-start; gap: 12px;">
                <!-- í”„ë¡œí•„ ì•„ì´ì½˜ -->
                {% if post.user.my_ID %}
                    <a href="{% url 'user_profile:profile' my_ID=post.user.my_ID %}" style="text-decoration: none;">
                        {% if post.user.profile_picture %}
                            <img src="{{ post.user.profile_picture.url }}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                        {% else %}
                            <div style="width: 32px; height: 32px; background: #1d9bf0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
                                {{ post.user.my_ID|first|upper }}
                            </div>
                        {% endif %}
                    </a>
                {% else %}
                    <div style="width: 32px; height: 32px; background: #ccc; border-radius: 50%;"></div>
                {% endif %}
                
                <!-- ì˜¤ë¥¸ìª½ ëª¨ë“  ë‚´ìš© -->
                <div style="flex: 1; margin-top: -4px;">
                    <!-- ì‚¬ìš©ìëª…ê³¼ ì‹œê°„ -->
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        {% if post.user.my_ID %}
                            <a href="{% url 'user_profile:profile' my_ID=post.user.my_ID %}" style="text-decoration: none; display: flex; align-items: center; gap: 4px;">
                                <span style="font-weight: bold; color: #0f1419;">{{ post.user.nickname }}</span>
                                <span style="color: #536471; font-weight: normal;">@{{ post.user.my_ID }}</span>
                            </a>
                        {% else %}
                            <span class="post-username">ì•Œ ìˆ˜ ì—†ìŒ</span>
                        {% endif %}
                        <span style="color: #536471; font-size: 14px;">Â·</span>
                        <span class="post-time" data-timestamp="{{ post.created_at|date:'c' }}" style="color: #536471; font-size: 14px;">{{ post.created_at|timesince }} ì „</span>
                    </div>
                    
                    <!-- í¬ìŠ¤íŠ¸ ë‚´ìš© -->
                    <div class="post-content">
                        {{ post.content }}
                    </div>

                    {% if post.image %}
                        <div style="margin: 10px 0;">
                            <div style="width: 100%; aspect-ratio: 16/9; overflow: hidden; border-radius: 12px; border: 1px solid #eff3f4; cursor: pointer;" onclick="openImageModal('{{ post.image.url }}')">
                                <img data-src="{{ post.image.url }}" 
                                    src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='225'%3E%3Crect width='100%25' height='100%25' fill='%23f0f0f0'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' fill='%23999'%3Eì´ë¯¸ì§€ ë¡œë”©ì¤‘...%3C/text%3E%3C/svg%3E"
                                    alt="ì²¨ë¶€ ì´ë¯¸ì§€" 
                                    class="lazy-image"
                                    style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                        </div>
                    {% elif post.screenshot_url %}
                        <div style="margin: 10px 0; cursor: pointer;" onclick="openImageModal('{{ post.screenshot_url }}')">
                            <img data-src="{{ post.screenshot_url }}" 
                                src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='225'%3E%3Crect width='100%25' height='100%25' fill='%23f0f0f0'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' fill='%23999'%3Eì´ë¯¸ì§€ ë¡œë”©ì¤‘...%3C/text%3E%3C/svg%3E"
                                alt="ì²¨ë¶€ ì´ë¯¸ì§€" 
                                class="lazy-image"
                                style="max-width: 100%; border-radius: 12px; border: 1px solid #eff3f4;">
                        </div>
                    {% endif %}
                </div>
            </div>
                        
            {% if post.tags.all %}
            <div style="margin: 10px 0;">
                {% for tag in post.tags.all %}
                <span onclick="toggleFilter('{{ tag.name }}')" 
                    style="display: inline-block; background: #f0f8ff; color: #1d9bf0; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-right: 6px; margin-bottom: 4px; cursor: pointer; border: 1px solid #e1f5fe;"
                    onmouseover="this.style.backgroundColor='#e3f2fd'"
                    onmouseout="this.style.backgroundColor='#f0f8ff'">
                    #{{ tag.name }}
                </span>
                {% endfor %}
            </div>
            {% endif %}
            <div class="action-buttons">
                <div class="action-btn" data-action="comments" data-post-id="{{ post.id }}">
                    <span class="material-symbols-outlined">chat_bubble</span>
                    <span>{{ post.comments.count }}</span>
                </div>
                
                <div class="action-btn" data-action="like" data-post-id="{{ post.id }}" id="like-btn-{{ post.id }}">
                    <span class="material-symbols-outlined {% if user.is_authenticated and post.is_liked_by_user %}liked{% endif %}" id="like-icon-{{ post.id }}">
                        {% if user.is_authenticated and post.is_liked_by_user %}favorite{% else %}favorite_border{% endif %}
                    </span>
                    <span id="likes-count-{{ post.id }}">{{ post.likes.count }}</span>
                </div>
          
                <div class="action-btn" data-action="bookmark" data-post-id="{{ post.id }}">
                    <span class="material-symbols-outlined {% if user.is_authenticated and post.is_bookmarked_by_user %}bookmarked{% endif %}">
                        {% if user.is_authenticated and post.is_bookmarked_by_user %}bookmark{% else %}bookmark_border{% endif %}
                    </span>
                    <span>{{ post.bookmarks.count }}</span>
                </div>
                
                <div class="action-btn" data-action="share" data-post-id="{{ post.id }}" id="share-btn-{{ post.id }}">
                    <span class="material-symbols-outlined" id="share-icon-{{ post.id }}">share</span>
                    <span id="shares-count-{{ post.id }}">{{ post.shares.count }}</span>
                </div>
            </div>
            <!-- ëŒ“ê¸€ ì„¹ì…˜ ì¶”ê°€ -->
            <div class="comments-section" id="comments-{{ post.id }}" style="display: none; margin-top: 15px; border-top: 1px solid #eff3f4; padding-top: 15px;">
                <!-- ëŒ“ê¸€ ì‘ì„± ì˜ì—­ -->
                <div class="comment-write" style="display: flex; gap: 8px; margin-bottom: 15px;">
                    <input type="text" id="comment-input-{{ post.id }}" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                           style="flex: 1; padding: 8px 12px; border: 1px solid #eff3f4; border-radius: 20px; outline: none;">
                    <button data-action="submit-comment" data-post-id="{{ post.id }}" 
                            style="padding: 8px 16px; background: #1d9bf0; color: white; border: none; border-radius: 20px; cursor: pointer;">
                        ì‘ì„±
                    </button>
                </div>
                
                <!-- ëŒ“ê¸€ ëª©ë¡ -->
                <div class="comments-list" id="comments-list-{{ post.id }}">
                    <!-- ëŒ“ê¸€ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <h3></h3>
        </div>
    {% endif %}
</div>

<!-- ì´ë¯¸ì§€ ëª¨ë‹¬ -->
<div id="image-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9);" onclick="closeImageModal()">
    <span style="position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer;" onclick="closeImageModal()">&times;</span>
    <img id="modal-image" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90%; max-height: 90%;">
</div>

<script>
// ë§¤ë§¤ì¼ì§€ ì¸í„°í˜ì´ìŠ¤ ì¶”ìƒí™” ë ˆì´ì–´
const TradingJournalInterface = {
    config: {
        modalUrl: '/journals/compose/?modal=1',
        modalWidth: 800,
        modalHeight: 600
    },
    
    // ëª¨ë‹¬ ì—´ê¸°
    openModal: function(callback) {
        this.resultCallback = callback;
        
        // fetchë¡œ modal HTML ê°€ì ¸ì˜¤ê¸°
        fetch(this.config.modalUrl)
            .then(response => response.text())
            .then(html => {
                // ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ ìƒì„±
                const overlay = document.createElement('div');
                overlay.id = 'trading-modal-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                
                overlay.innerHTML = html;
                document.body.appendChild(overlay);

                // â˜… JavaScript ìˆ˜ë™ ë¡œë“œ ë° ì‹¤í–‰
                this.loadJournalScripts();

                // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
                const closeBtn = overlay.querySelector('.close-modal');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => this.closeModal());
                }
                
                // ë°°ê²½ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        this.closeModal();
                    }
                });
                
                console.log('ë§¤ë§¤ì¼ì§€ ëª¨ë‹¬ ì—´ë¦¼');
            })
            .catch(error => {
                console.error('ë§¤ë§¤ì¼ì§€ ëª¨ë‹¬ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ë§¤ë§¤ì¼ì§€ ì‘ì„± ì°½ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            });
    },
    
    loadJournalScripts: function() {
        // Chart.js ë¡œë“œ
        if (!window.Chart) {
            const chartScript = document.createElement('script');
            chartScript.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
            document.head.appendChild(chartScript);
        }
        
        // journal_lookup.js ë¡œë“œ ë° ì‹¤í–‰
        const journalScript = document.createElement('script');
        journalScript.src = '/static/journals/journal_lookup.js';
        journalScript.onload = () => {
            console.log('Journal script loaded');
            
            // ğŸ”§ ì¶”ê°€: íƒ­ ì „í™˜ ë¡œì§ ìˆ˜ë™ ì‹¤í–‰
            this.initializeTabSwitching();
            
            // DOMContentLoaded ì´ë²¤íŠ¸ë¥¼ ìˆ˜ë™ìœ¼ë¡œ íŠ¸ë¦¬ê±°
            setTimeout(() => {
                const event = new Event('DOMContentLoaded');
                document.dispatchEvent(event);
            }, 100);
        };
        document.head.appendChild(journalScript);
    },

    // ğŸ”§ ìƒˆë¡œ ì¶”ê°€: íƒ­ ì „í™˜ ë¡œì§
    initializeTabSwitching: function() {
        const composeTabs = document.querySelectorAll('.compose-tab-item');
        const composeTabContents = document.querySelectorAll('.compose-tab-content');

        composeTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                console.log('íƒ­ í´ë¦­:', this.dataset.assetType); // ë””ë²„ê¹…ìš©
                
                composeTabs.forEach(item => item.classList.remove('active'));
                composeTabContents.forEach(content => content.classList.remove('active'));

                this.classList.add('active');
                const targetContent = document.getElementById(this.dataset.assetType + '-tab-content');
                if (targetContent) {
                    targetContent.classList.add('active');
                }
            });
        });

        // URL íŒŒë¼ë¯¸í„° ê¸°ë°˜ ì´ˆê¸° íƒ­ í™œì„±í™”
        const urlParams = new URLSearchParams(window.location.search);
        const assetType = urlParams.get('asset');
        if (assetType) {
            const initialTab = document.querySelector(`.compose-tab-item[data-asset-type="${assetType}"]`);
            if (initialTab) {
                initialTab.click();
            }
        }
    },
    
    // ëª¨ë‹¬ ë‹«ê¸°
    closeModal: function() {
        this.forceCloseModal();
    },

    // ìƒˆë¡œìš´ ê°•ì œ ë‹«ê¸° í•¨ìˆ˜ ì¶”ê°€
    forceCloseModal: function() {
        // 1. IDë¡œ ì°¾ê¸°
        const overlay = document.getElementById('trading-modal-overlay');
        if (overlay) {
            overlay.remove();
            console.log('IDë¡œ ëª¨ë‹¬ ì œê±° ì™„ë£Œ');
            return;
        }
        
        // 2. í´ë˜ìŠ¤ë¡œ ì°¾ê¸° (ëŒ€ì•ˆ)
        const modals = document.querySelectorAll('[id*="modal"], [class*="modal"]');
        modals.forEach(modal => {
            if (modal.innerHTML && modal.innerHTML.includes('ë§¤ë§¤ì¼ì§€')) {
                modal.remove();
                console.log('ë§¤ë§¤ì¼ì§€ ëª¨ë‹¬ ê°•ì œ ì œê±°');
            }
        });
        
        if (this.keyHandler) {
            document.removeEventListener('keydown', this.keyHandler);
        }
    },
    
    // ì™„ë£Œ ê²°ê³¼ ì²˜ë¦¬ (íŒ€ì› ì‹œìŠ¤í…œì—ì„œ í˜¸ì¶œ)
    onComplete: function(result) {
        if (this.resultCallback) {
            this.resultCallback(result);
        }
        this.closeModal();
    },
    
    // íŒ€ì›ê³¼ì˜ ì¸í„°í˜ì´ìŠ¤ (postMessage ìˆ˜ì‹ )
    setupMessageListener: function() {
        window.addEventListener('message', (event) => {
            if (event.data.type === 'trading-journal-complete') {
                console.log('ë§¤ë§¤ì¼ì§€ ì™„ë£Œ, ëª¨ë‹¬ ë‹«ê¸°');
                
                // 1. ëª¨ë‹¬ ë¨¼ì € ë‹«ê¸°
                this.closeModal();
                
                // 2. form ë°ì´í„°ë¡œ ë°”ë¡œ ì¹´ë“œ ìƒì„±
                if (event.data.payload && event.data.payload.form_data) {
                    this.createSimpleJournalCard(event.data.payload.form_data);
                }
                
                Toast.success('ë§¤ë§¤ì¼ì§€ê°€ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        });
    },

    createSimpleJournalCard: function(formData) {
        const postsContainer = document.getElementById('posts-container');
        if (!postsContainer) return;
        
        const ticker = formData.ticker_symbol || 'UNKNOWN';
        const side = formData.side || 'BUY';
        const sideKor = side === 'BUY' ? 'ë§¤ìˆ˜' : 'ë§¤ë„';
        const sideColor = side === 'BUY' ? '#ef4444' : '#16a34a';
        const price = formData.price || '0';
        const quantity = formData.quantity || '0';
        const date = formData.date || new Date().toISOString().split('T')[0];
        
        const cardHTML = `
            <div class="post-card trading-journal-card fade-in" style="border-left: 4px solid ${sideColor};">
                <div style="background: #f8fafc; border-radius: 12px; padding: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <div style="width: 40px; height: 40px; background: ${sideColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <span class="material-symbols-outlined" style="color: white; font-size: 20px;">assessment</span>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #0f172a; font-size: 16px;">ë§¤ë§¤ì¼ì§€ ì‘ì„± ì™„ë£Œ</div>
                            <div style="color: #64748b; font-size: 14px;">ë°©ê¸ˆ ì „</div>
                        </div>
                        <div style="background: ${sideColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                            ${sideKor}
                        </div>
                    </div>
                    
                    <div style="background: white; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <div style="color: #64748b; font-size: 13px;">ì¢…ëª©</div>
                                <div style="font-weight: bold; font-size: 18px; color: #0f172a;">${ticker}</div>
                            </div>
                            <div>
                                <div style="color: #64748b; font-size: 13px;">ê±°ë˜ì¼</div>
                                <div style="font-weight: 600; color: #0f172a;">${date}</div>
                            </div>
                            <div>
                                <div style="color: #64748b; font-size: 13px;">ê°€ê²©</div>
                                <div style="font-weight: 600; color: #0f172a;">$${price}</div>
                            </div>
                            <div>
                                <div style="color: #64748b; font-size: 13px;">ìˆ˜ëŸ‰</div>
                                <div style="font-weight: 600; color: #0f172a;">${quantity}ì£¼</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <a href="/journals/my-list/" 
                        style="flex: 1; background: ${sideColor}; color: white; padding: 12px; border-radius: 8px; text-decoration: none; text-align: center; font-weight: 600;">
                            ë§¤ë§¤ì¼ì§€ ë³´ê¸°
                        </a>
                        <button onclick="this.closest('.post-card').remove()" 
                                style="background: #f1f5f9; color: #64748b; padding: 12px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ë‹«ê¸°
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        postsContainer.insertAdjacentHTML('afterbegin', cardHTML);
        console.log('ì¹´ë“œ ìƒì„± ì™„ë£Œ');
    },

    // ë§¤ë§¤ì¼ì§€ ì¹´ë“œ ì¶”ê°€ í•¨ìˆ˜
    addTradingJournalCard: function(payload) {
        const postsContainer = document.getElementById('posts-container');
        if (!postsContainer) return;
        
        console.log('ì¹´ë“œ ì¶”ê°€ payload:', payload);
        
        console.log('ë°±ì—”ë“œ ì¹´ë“œ ì—†ìŒ, í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ìƒì„±');
        // ë°›ì€ form ë°ì´í„° í™œìš© (API í˜¸ì¶œ ì—†ìŒ)
        const formData = payload.form_data || {};
        const ticker = formData.ticker_symbol || 'UNKNOWN';
        const side = formData.side || 'BUY';
        const price = formData.price || '0';
        const quantity = formData.quantity || '0';
        const date = formData.date || new Date().toISOString().split('T')[0];
        
        // í•œêµ­ì–´ ë³€í™˜
        const sideKor = side === 'BUY' ? 'ë§¤ìˆ˜' : 'ë§¤ë„';
        const sideColor = side === 'BUY' ? '#ef4444' : '#16a34a';
        
        const cardHTML = `
            <div class="post-card trading-journal-card fade-in" style="border-left: 4px solid ${sideColor}; margin-bottom: 16px;">
                <div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    
                    <!-- í—¤ë” -->
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <div style="width: 40px; height: 40px; background: ${sideColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">
                            <span class="material-symbols-outlined" style="color: white; font-size: 20px;">assessment</span>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #0f172a; font-size: 16px;">ë§¤ë§¤ì¼ì§€ ì‘ì„± ì™„ë£Œ</div>
                            <div style="color: #64748b; font-size: 14px;">ë°©ê¸ˆ ì „</div>
                        </div>
                        <div style="background: ${sideColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                            ${sideKor}
                        </div>
                    </div>
                    
                    <!-- ê±°ë˜ ì •ë³´ ì¹´ë“œ -->
                    <div style="background: white; border-radius: 8px; padding: 16px; margin-bottom: 16px; border: 1px solid #e2e8f0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <div style="color: #64748b; font-size: 13px; margin-bottom: 4px;">ì¢…ëª©</div>
                                <div style="font-weight: bold; font-size: 18px; color: #0f172a;">${ticker}</div>
                            </div>
                            <div>
                                <div style="color: #64748b; font-size: 13px; margin-bottom: 4px;">ê±°ë˜ì¼</div>
                                <div style="font-weight: 600; color: #0f172a;">${date}</div>
                            </div>
                            <div>
                                <div style="color: #64748b; font-size: 13px; margin-bottom: 4px;">ê°€ê²©</div>
                                <div style="font-weight: 600; color: #0f172a;">$${price}</div>
                            </div>
                            <div>
                                <div style="color: #64748b; font-size: 13px; margin-bottom: 4px;">ìˆ˜ëŸ‰</div>
                                <div style="font-weight: 600; color: #0f172a;">${quantity}ì£¼</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì•¡ì…˜ ë²„íŠ¼ -->
                    <div style="display: flex; gap: 12px;">
                        <a href="/journals/my-list/" 
                        style="flex: 1; background: ${sideColor}; color: white; padding: 12px; border-radius: 8px; text-decoration: none; text-align: center; font-weight: 600; transition: all 0.2s;">
                            ë§¤ë§¤ì¼ì§€ ë³´ê¸°
                        </a>
                        <button onclick="this.closest('.post-card').remove()" 
                                style="background: #f1f5f9; color: #64748b; padding: 12px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ë‹«ê¸°
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        postsContainer.insertAdjacentHTML('afterbegin', cardHTML);
    },
};
// í¬ìŠ¤íŠ¸ ìƒíƒœ ê´€ë¦¬
const PostStateManager = {
    currentState: 'none', // 'none', 'image', 'trading'
    
    setState: function(newState) {
        this.currentState = newState;
        this.updateUI();
    },
    
    updateUI: function() {
        const tradingBtn = document.getElementById('trading-journal-btn');
        const imageBtn = document.getElementById('image-upload-btn');
        const postBtn = document.getElementById('post-button');
        
        if (this.currentState === 'trading') {
            // ë§¤ë§¤ì¼ì§€ ì„ íƒë¨
            tradingBtn.style.opacity = '1';
            imageBtn.style.opacity = '0.3';
            imageBtn.style.pointerEvents = 'none';
            this.showPrivacyToggle();
        } else if (this.currentState === 'image') {
            // ì´ë¯¸ì§€ ì„ íƒë¨  
            imageBtn.style.opacity = '1';
            tradingBtn.style.opacity = '0.3';
            tradingBtn.style.pointerEvents = 'none';
            this.hidePrivacyToggle();
        } else {
            // ì•„ë¬´ê²ƒë„ ì„ íƒ ì•ˆë¨
            tradingBtn.style.opacity = '1';
            tradingBtn.style.pointerEvents = 'auto';
            imageBtn.style.opacity = '1';
            imageBtn.style.pointerEvents = 'auto';
            this.hidePrivacyToggle();
        }
        
        this.updatePostButton();
    },
    
    updatePostButton: function() {
        const textarea = document.getElementById('post-content');
        const postBtn = document.getElementById('post-button');
        const hasContent = textarea.value.trim().length > 0;
        const hasAttachment = this.currentState !== 'none';
        
        if (hasContent || hasAttachment) {
            postBtn.disabled = false;
            postBtn.style.opacity = '1';
        } else {
            postBtn.disabled = true;
            postBtn.style.opacity = '0.5';
        }
    },
    
    showPrivacyToggle: function() {
        let toggle = document.getElementById('privacy-toggle');
        if (!toggle) {
            toggle = document.createElement('div');
            toggle.id = 'privacy-toggle';
            toggle.innerHTML = `
                <label style="display: flex; align-items: center; gap: 8px; margin-top: 10px; font-size: 14px;">
                    <input type="checkbox" id="private-post" style="margin: 0;">
                    <span>ë‚˜ë§Œë³´ê¸°</span>
                </label>
            `;
            const form = document.querySelector('form[action*="create_simple_post"]');
            form.insertBefore(toggle, form.lastElementChild);
        }
        toggle.style.display = 'block';
    },
    
    hidePrivacyToggle: function() {
        const toggle = document.getElementById('privacy-toggle');
        if (toggle) {
            toggle.style.display = 'none';
        }
    }
};

// ë§¤ë§¤ì¼ì§€ ì—´ê¸° í•¨ìˆ˜
function openTradingJournal() {
    TradingJournalInterface.openModal(function(result) {
        // ë§¤ë§¤ì¼ì§€ ì™„ë£Œì‹œ ì½œë°±
        console.log('ë§¤ë§¤ì¼ì§€ ì™„ë£Œ:', result);
        PostStateManager.setState('trading');
        // TODO: ë§¤ë§¤ì¼ì§€ ì¹´ë“œ í‘œì‹œ
    });
}
// í˜ì´ì§€ ë¡œë“œì‹œ ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
TradingJournalInterface.setupMessageListener();

document.addEventListener('DOMContentLoaded', function() {
    TradingJournalInterface.setupMessageListener();
});

// í¬ìŠ¤íŠ¸ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
function togglePostButton() {
    PostStateManager.updatePostButton(); 
}

// ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
function previewImage(input) {
    const preview = document.getElementById('image-preview');
    const img = document.getElementById('preview-img');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            img.src = e.target.result;
            preview.style.display = 'block';
            PostStateManager.setState('image');
        }
        
        reader.readAsDataURL(input.files[0]);
    }
}

// ì´ë¯¸ì§€ ì œê±°
function removeImage() {
    document.getElementById('image-input').value = '';
    document.getElementById('image-preview').style.display = 'none';
    PostStateManager.setState('none');
}

// í•„í„° ìƒíƒœ ê´€ë¦¬
let activeFilters = [];
let customTags = [];
const MAX_CUSTOM_TAGS = 3;

function toggleFilter(tagName) {
    const button = document.getElementById(`filter-${tagName}`);
    
    if (activeFilters.includes(tagName)) {
        activeFilters = activeFilters.filter(f => f !== tagName);
        button.style.background = '#ffffff';
        button.style.color = '#0f1419';
    } else {
        activeFilters.push(tagName);
        button.style.background = '#1d9bf0';
        button.style.color = '#ffffff';
    }
    
    applyFilters();
}
function handleTagInput(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        addCustomTag();
    }
}

function addCustomTag() {
    const input = document.getElementById('tag-input');
    const tagName = input.value.trim();
    
    if (!tagName) return;
    if (customTags.length >= MAX_CUSTOM_TAGS) {
        Toast.warning('ìµœëŒ€ 3ê°œê¹Œì§€ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }
    if (customTags.includes(tagName) || ['ë§¤ë§¤ì¼ì§€', 'ì£¼ì‹', 'ë¶€ë™ì‚°'].includes(tagName)) {
        Toast.warning('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íƒœê·¸ì…ë‹ˆë‹¤.');
        return;
    }
    
    customTags.push(tagName);
    renderCustomTags();
    input.value = '';
}

function renderCustomTags() {
    const container = document.getElementById('custom-tags-container');
    container.innerHTML = '';
    
    customTags.forEach(tagName => {
        const tagButton = document.createElement('button');
        tagButton.innerHTML = `#${tagName} <span onclick="removeCustomTag('${tagName}')" style="margin-left: 6px; padding: 2px 4px; background: rgba(255,255,255,0.8); border-radius: 50%; font-size: 14px; font-weight: bold; cursor: pointer; hover:background: rgba(255,255,255,1);">Ã—</span>`;
        tagButton.id = `filter-${tagName}`;
        tagButton.onclick = () => toggleFilter(tagName);
        tagButton.style.cssText = 'background: #ffffff; color: #0f1419; border: 1px solid #eff3f4; padding: 6px 12px; border-radius: 20px; font-size: 14px; cursor: pointer;';
        container.appendChild(tagButton);
    });
}

function removeCustomTag(tagName) {
    customTags = customTags.filter(tag => tag !== tagName);
    renderCustomTags();
    
    const index = activeFilters.indexOf(tagName);
    if (index > -1) {
        activeFilters.splice(index, 1);
        applyFilters();
    }
}

function applyFilters() {
    const posts = document.querySelectorAll('.post-card');
    posts.forEach(post => {
        if (activeFilters.length === 0) {
            // í•„í„° ì—†ìœ¼ë©´ ëª¨ë‘ í‘œì‹œ
            post.style.display = 'block';
        } else {
            // í¬ìŠ¤íŠ¸ì˜ íƒœê·¸ í™•ì¸
            const postTags = post.querySelectorAll('span[onclick*="toggleFilter"]');
            const postTagNames = Array.from(postTags).map(tag => 
                tag.textContent.replace('#', '').trim()
            );
            
            // í™œì„±í™”ëœ í•„í„° ì¤‘ í•˜ë‚˜ë¼ë„ í¬ìŠ¤íŠ¸ì— ìˆìœ¼ë©´ í‘œì‹œ
            const shouldShow = activeFilters.some(filter => 
                postTagNames.includes(filter)
            );
            
            post.style.display = shouldShow ? 'block' : 'none';
        }
    });
}
// ì´ë¯¸ì§€ ëª¨ë‹¬ ì—´ê¸°
function openImageModal(imageSrc) {
    const modal = document.getElementById('image-modal');
    const modalImg = document.getElementById('modal-image');
    
    modal.style.display = 'block';
    modalImg.src = imageSrc;
}

// ì´ë¯¸ì§€ ëª¨ë‹¬ ë‹«ê¸°
function closeImageModal() {
    document.getElementById('image-modal').style.display = 'none';
}
// AJAX í¬ìŠ¤íŠ¸ ì œì¶œ
function submitPost(event) {
    event.preventDefault(); // ê¸°ë³¸ form submit ë§‰ê¸°
    
    const form = event.target;
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ì„±ê³µ ì‹œ í”¼ë“œì— ìƒˆ í¬ìŠ¤íŠ¸ ì¶”ê°€
            addNewPostToFeed(data.post);
            
            // í¼ ì´ˆê¸°í™”
            form.reset();
            document.getElementById('post-button').disabled = true;
            document.getElementById('post-button').style.opacity = '0.5';
            document.getElementById('image-preview').style.display = 'none';
            
            // PostStateManager ìƒíƒœ ì´ˆê¸°í™”
            PostStateManager.setState('none');
        } else {
            Toast.error('í¬ìŠ¤íŠ¸ ì‘ì„± ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Toast.error('í¬ìŠ¤íŠ¸ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

function addNewPostToFeed(postData) {
    const postsContainer = document.getElementById('posts-container');
    let tagsHtml = '';
    if (postData.tags && postData.tags.length > 0) {
        tagsHtml = '<div style="margin: 10px 0;">';
        postData.tags.forEach(tag => {
            tagsHtml += `<span onclick="toggleFilter('${tag}')" style="display: inline-block; background: #f0f8ff; color: #1d9bf0; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-right: 6px; cursor: pointer;">#${tag}</span>`;
        });
        tagsHtml += '</div>';
    }
    
    // ìƒˆ í¬ìŠ¤íŠ¸ HTML ìƒì„±
    const newPostHTML = `
        <div class="post-card" style="position: relative;">
            <div class="post-menu-btn" data-post-id="${postData.id}" data-is-my-post="true">
                <span class="material-symbols-outlined">more_horiz</span>
            </div>

            <div style="display: flex; align-items: flex-start; gap: 12px;">
                <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ -->
                <a href="/profile/${postData.my_ID}/" style="text-decoration: none;">
                    <div style="width: 32px; height: 32px; background: #1d9bf0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
                        ${postData.my_ID.charAt(0).toUpperCase()}
                    </div>
                </a>
                
                <!-- ì˜¤ë¥¸ìª½ ëª¨ë“  ë‚´ìš© -->
                <div style="flex: 1; margin-top: -4px;">
                    <!-- ì‚¬ìš©ìëª…ê³¼ ì‹œê°„ -->
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <a href="/profile/${postData.my_ID}/" style="text-decoration: none; display: flex; align-items: center; gap: 4px;">
                            <span style="font-weight: bold; color: #0f1419;">${postData.nickname || postData.my_ID}</span>
                            <span style="color: #536471; font-weight: normal;">@${postData.my_ID}</span>
                        </a>
                        <span style="color: #536471; font-size: 14px;">Â·</span>
                        <span style="color: #536471; font-size: 14px;">ë°©ê¸ˆ ì „</span>
                    </div>
                    
                    <!-- í¬ìŠ¤íŠ¸ ë‚´ìš© -->
                    <div class="post-content">
                        ${postData.content}
                    </div>

                    ${postData.image_url ? `
                    <div style="margin: 10px 0;">
                        <div style="width: 100%; aspect-ratio: 16/9; overflow: hidden; border-radius: 12px; border: 1px solid #eff3f4; cursor: pointer;" onclick="openImageModal('${postData.image_url}')">
                            <img data-src="${postData.image_url}" 
                                src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='225'%3E%3Crect width='100%25' height='100%25' fill='%23f0f0f0'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' fill='%23999'%3Eì´ë¯¸ì§€ ë¡œë”©ì¤‘...%3C/text%3E%3C/svg%3E"
                                alt="ì²¨ë¶€ ì´ë¯¸ì§€" 
                                class="lazy-image"
                                style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                    </div>
                    ` : ''}
                    ${tagsHtml}
                    <div class="action-buttons">
                        <div class="action-btn">
                            <span class="material-symbols-outlined">chat_bubble</span>
                            <span>0</span>
                        </div>
                        
                        <div class="action-btn">
                            <span class="material-symbols-outlined">favorite</span>
                            <span>0</span>
                        </div>
                        
                        <div class="action-btn">
                            <span class="material-symbols-outlined">bookmark</span>
                            <span>0</span>
                        </div>
                        
                        <div class="action-btn">
                            <span class="material-symbols-outlined">share</span>
                            <span>0</span>
                        </div>
                    </div>
                                    </div> 
                                </div>
                            </div>
                        `;
                        
                        // í”¼ë“œ ë§¨ ìœ„ì— ìƒˆ í¬ìŠ¤íŠ¸ ì¶”ê°€
                        postsContainer.insertAdjacentHTML('afterbegin', newPostHTML);
                        LazyLoader.observeNewImages();
                    }
// ë¬´í•œ ìŠ¤í¬ë¡¤ìš© í¬ìŠ¤íŠ¸ ì¶”ê°€ (ê¸°ì¡´ í•¨ìˆ˜ ì¬ì‚¬ìš©)
function addPostToFeed(postData) {
    const postsContainer = document.getElementById('posts-container');
    
    // asset_class ê´€ë ¨ ì œê±°í•˜ê³  ê¸°ì¡´ í•¨ìˆ˜ ë¡œì§ ì¬ì‚¬ìš©
    const modifiedPostData = {
        ...postData,
        username: postData.my_ID,
        asset_class: '',
        asset_class_display: ''
    };
    
    let tagsHtml = '';
    if (postData.tags && postData.tags.length > 0) {
        tagsHtml = '<div style="margin: 10px 0;">';
        postData.tags.forEach(tag => {
            tagsHtml += `<span onclick="toggleFilter('${tag}')" style="display: inline-block; background: #f0f8ff; color: #1d9bf0; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-right: 6px; cursor: pointer;">#${tag}</span>`;
        });
        tagsHtml += '</div>';
    }
    
    const newPostHTML = `
        <div class="post-card">
            <div class="post-header">
                <span class="post-username">${postData.my_ID}</span>
                <span class="post-time">${postData.created_at}</span>
            </div>
            
            <div class="post-content">
                ${postData.content}
            </div>
            
            ${postData.image_url ? `
            <div style="margin: 10px 0;">
                <div style="width: 100%; aspect-ratio: 16/9; overflow: hidden; border-radius: 12px; border: 1px solid #eff3f4; cursor: pointer;" onclick="openImageModal('${postData.image_url}')">
                    <img data-src="${postData.image_url}" 
                        src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='225'%3E%3Crect width='100%25' height='100%25' fill='%23f0f0f0'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' fill='%23999'%3Eì´ë¯¸ì§€ ë¡œë”©ì¤‘...%3C/text%3E%3C/svg%3E"
                        alt="ì²¨ë¶€ ì´ë¯¸ì§€" 
                        class="lazy-image"
                        style="width: 100%; height: 100%; object-fit: cover;">
                </div>
            </div>
            ` : ''}
            
            ${tagsHtml}
            
            <div class="action-buttons">
                <div class="action-btn" data-action="comments" data-post-id="${postData.id}">
                    <span class="material-symbols-outlined">chat_bubble</span>
                    <span>${postData.comments_count}</span>
                </div>
                <div class="action-btn" data-action="like" data-post-id="${postData.id}">
                    <span class="material-symbols-outlined${postData.is_liked ? ' liked' : ''}">${postData.is_liked ? 'favorite' : 'favorite_border'}</span>
                    <span>${postData.likes_count}</span>
                </div>
                <div class="action-btn" data-action="bookmark" data-post-id="${postData.id}">
                    <span class="material-symbols-outlined">bookmark_border</span>
                    <span>${postData.bookmarks_count}</span>
                </div>
                <div class="action-btn" data-action="share" data-post-id="${postData.id}">
                    <span class="material-symbols-outlined">share</span>
                    <span>${postData.shares_count}</span>
                </div>
            </div>
        </div>
    `;
    
    // ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì¶”ê°€
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = newPostHTML;
    const postElement = tempDiv.firstElementChild;
    postElement.classList.add('fade-in');

    postsContainer.appendChild(postElement);
    LazyLoader.observeNewImages();
    }
// ìºëŸ¬ì…€ ë³€ìˆ˜
let currentSlide = 0;
const totalSlides = 3; // ì´ 3ê°œ ìŠ¬ë¼ì´ë“œ (9ê°œ ë‰´ìŠ¤ Ã· 3ê°œ = 3ê°œ)

// ìŠ¬ë¼ì´ë“œ í‘œì‹œ í•¨ìˆ˜
function showSlide(slideIndex) {
    const newsItems = document.querySelectorAll('.news-item');
    const dots = document.querySelectorAll('.dot');
    
    // ëª¨ë“  ë‰´ìŠ¤ ì•„ì´í…œ ìˆ¨ê¸°ê¸°
    newsItems.forEach(item => {
        item.classList.add('hidden');
    });
    
    // í•´ë‹¹ ìŠ¬ë¼ì´ë“œì˜ ë‰´ìŠ¤ ì•„ì´í…œë“¤ ë³´ì´ê¸° (3ê°œì”©)
    for (let i = slideIndex * 3; i < (slideIndex + 1) * 3; i++) {
        if (newsItems[i]) {
            newsItems[i].classList.remove('hidden');
        }
    }
    
    // ëª¨ë“  ì  ë¹„í™œì„±í™”
    dots.forEach(dot => {
        dot.style.background = '#ccc';
    });
    
    // í˜„ì¬ ì  í™œì„±í™”
    if (dots[slideIndex]) {
        dots[slideIndex].style.background = '#1d9bf0';
    }
    
    currentSlide = slideIndex;
}

// ì´ì „ ìŠ¬ë¼ì´ë“œ
function prevSlide() {
    const newSlide = currentSlide === 0 ? totalSlides - 1 : currentSlide - 1;
    showSlide(newSlide);
}

// ë‹¤ìŒ ìŠ¬ë¼ì´ë“œ
function nextSlide() {
    const newSlide = currentSlide === totalSlides - 1 ? 0 : currentSlide + 1;
    showSlide(newSlide);
}

// ìë™ ìŠ¬ë¼ì´ë“œ (5ì´ˆë§ˆë‹¤)
let autoSlideInterval = setInterval(nextSlide, 10000);

// í˜¸ë²„ì‹œ ìë™ ìŠ¬ë¼ì´ë“œ ì •ì§€
const carousel = document.querySelector('.news-carousel');
if (carousel) {
    carousel.addEventListener('mouseenter', () => {
        clearInterval(autoSlideInterval);
    });
    
    carousel.addEventListener('mouseleave', () => {
        autoSlideInterval = setInterval(nextSlide, 10000);
    });
}
// CSRF í† í° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ 
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// ì‚¬ìš©ì ì¸ì¦ í™•ì¸ í•¨ìˆ˜
function isUserAuthenticated() {
    const authData = document.getElementById('auth-data');
    return authData.getAttribute('data-authenticated') === 'true';
}

// ì¢‹ì•„ìš” í† ê¸€ í•¨ìˆ˜
function toggleLike(postId) {
    if (!isUserAuthenticated()) {
        Toast.warning('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
    }

    const likeBtn = document.getElementById('like-btn-' + postId);
    const likeIcon = document.getElementById('like-icon-' + postId);
    const likesCount = document.getElementById('likes-count-' + postId);
    
    const isCurrentlyLiked = likeIcon.textContent === 'favorite';
    
    // ë‚™ê´€ì  ì—…ë°ì´íŠ¸
    likeIcon.textContent = isCurrentlyLiked ? 'favorite_border' : 'favorite';
    likeIcon.style.color = isCurrentlyLiked ? '#536471' : '#e91e63';
    
    const currentCount = parseInt(likesCount.textContent);
    likesCount.textContent = isCurrentlyLiked ? currentCount - 1 : currentCount + 1;
    
    // ì„œë²„ ìš”ì²­
    fetch('/home/post/' + postId + '/like/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
    })
    .then(response => response.json())
    .then(data => {
        likeIcon.textContent = data.liked ? 'favorite' : 'favorite_border';
        if (data.liked) {
            likeIcon.classList.add('liked');
        } else {
            likeIcon.classList.remove('liked');
        }
        likesCount.textContent = data.likes_count;
    })
    .catch(error => {
        console.error('ì˜¤ë¥˜:', error);
        likeIcon.textContent = isCurrentlyLiked ? 'favorite' : 'favorite_border';
        if (isCurrentlyLiked) {
            likeIcon.classList.add('liked');
        } else {
            likeIcon.classList.remove('liked');
        }
        likesCount.textContent = currentCount;
        Toast.error('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}
// ë¶ë§ˆí¬ í† ê¸€ í•¨ìˆ˜
function toggleBookmark(postId) {
    if (!isUserAuthenticated()) {
        Toast.warning('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
    }

    const bookmarkBtn = document.querySelector('[data-post-id="' + postId + '"][data-action="bookmark"]');
    const bookmarkIcon = bookmarkBtn.querySelector('.material-symbols-outlined');
    const bookmarksCount = bookmarkBtn.querySelector('span:last-child');
    
    const isCurrentlyBookmarked = bookmarkIcon.textContent === 'bookmark';
    
    // ë‚™ê´€ì  ì—…ë°ì´íŠ¸
    bookmarkIcon.textContent = isCurrentlyBookmarked ? 'bookmark_border' : 'bookmark';
    bookmarkIcon.style.color = isCurrentlyBookmarked ? '#536471' : '#1d9bf0';
    
    const currentCount = parseInt(bookmarksCount.textContent);
    bookmarksCount.textContent = isCurrentlyBookmarked ? currentCount - 1 : currentCount + 1;
    
    // ì„œë²„ ìš”ì²­
    fetch('/home/post/' + postId + '/bookmark/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
    })
    .then(response => response.json())
    .then(data => {
        bookmarkIcon.textContent = data.bookmarked ? 'bookmark' : 'bookmark_border';
        if (data.bookmarked) {
            bookmarkIcon.classList.add('bookmarked');
        } else {
            bookmarkIcon.classList.remove('bookmarked');
        }
        bookmarksCount.textContent = data.bookmarks_count;
    })
    .catch(error => {
        console.error('ì˜¤ë¥˜:', error);
        bookmarkIcon.textContent = isCurrentlyBookmarked ? 'bookmark' : 'bookmark_border';
        bookmarkIcon.style.color = isCurrentlyBookmarked ? '#1d9bf0' : '#536471';
        bookmarksCount.textContent = currentCount;
        Toast.error('ë¶ë§ˆí¬ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}   
// ëŒ“ê¸€ í† ê¸€ í•¨ìˆ˜ (ëŒ“ê¸€ ì„¹ì…˜ ì—´ê¸°/ë‹«ê¸°)
function toggleComments(postId) {
    const commentsSection = document.getElementById('comments-' + postId);
    
    if (commentsSection.style.display === 'none' || commentsSection.style.display === '') {
        commentsSection.style.display = 'block';
        loadComments(postId);
    } else {
        commentsSection.style.display = 'none';
    }
}

// ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ
function loadComments(postId) {
    fetch('/home/post/' + postId + '/comments/')
    .then(response => response.json())
    .then(data => {
        displayComments(postId, data.comments);
    })
    .catch(error => {
        console.error('ëŒ“ê¸€ ë¡œë“œ ì˜¤ë¥˜:', error);
    });
}

// ëŒ“ê¸€ ì œì¶œ
function submitComment(postId) {
    if (!isUserAuthenticated()) {
        Toast.warning('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
    }
    
    const commentInput = document.getElementById('comment-input-' + postId);
    const content = commentInput.value.trim();
    
    if (!content) {
        Toast.warning('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    fetch('/home/post/' + postId + '/comment/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.comment_id) {
            commentInput.value = '';
            const commentsCountElement = document.querySelector(`[data-post-id="${postId}"][data-action="comments"] span:last-child`);
            commentsCountElement.textContent = data.comments_count;
            loadComments(postId);
        } else {
            Toast.error(data.error || 'ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        console.error('ëŒ“ê¸€ ì‘ì„± ì˜¤ë¥˜:', error);
        Toast.error('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

function displayComments(postId, comments) {
    const commentsList = document.getElementById('comments-list-' + postId);
    
    if (comments.length === 0) {
        commentsList.innerHTML = '<div style="color: #536471; text-align: center; padding: 20px;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }
    
    let commentsHTML = '';
    comments.forEach(comment => {
        const timeAgo = getRelativeTime(comment.created_at);
        const isMyComment = isUserAuthenticated() && comment.my_ID === getCurrentUserId();
        
        commentsHTML += `
            <div class="comment" style="margin-bottom: 12px;" id="comment-${comment.id}">
                <div style="display: flex; align-items: flex-start; gap: 8px;">
                    <!-- ëŒ“ê¸€ ì‘ì„±ì í”„ë¡œí•„ ì•„ì´ì½˜ -->
                    <a href="/profile/${comment.my_ID}/" style="text-decoration: none;">
                        <div style="width: 24px; height: 24px; background: #1d9bf0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px; flex-shrink: 0;">
                            ${comment.my_ID ? comment.my_ID.charAt(0).toUpperCase() : 'U'}
                        </div>
                    </a>
                    
                    <!-- ëŒ“ê¸€ ë‚´ìš© -->
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 2px;">
                            <a href="/profile/${comment.my_ID}/" style="text-decoration: none; display: flex; align-items: center; gap: 4px;">
                                <span style="font-weight: bold; color: #0f1419; font-size: 14px;">${comment.nickname || comment.my_ID}</span>
                                <span style="color: #536471; font-size: 12px; font-weight: normal;">@${comment.my_ID}</span>
                            </a>
                            <span style="color: #536471; font-size: 12px;">Â·</span>
                            <span style="color: #536471; font-size: 12px;">${timeAgo}</span>
                            ${comment.is_edited ? '<span style="color: #536471; font-size: 11px; margin-left: 4px;">(ìˆ˜ì •ë¨)</span>' : ''}
                        </div>
                        
                        <div class="comment-content" style="color: #0f1419; line-height: 1.4; font-size: 14px; margin-bottom: 8px;">
                            ${comment.content}
                        </div>
                        
                        <!-- ëŒ“ê¸€ ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
                        <div style="display: flex; gap: 16px; font-size: 13px; color: #536471;">
                            <button onclick="showReplyForm(${comment.id})" style="background: none; border: none; color: #536471; cursor: pointer; font-size: 13px;">
                                ë‹µê¸€
                            </button>
                            
                            ${isMyComment ? `
                                <button onclick="editComment(${comment.id})" style="background: none; border: none; color: #536471; cursor: pointer; font-size: 13px;">
                                    ìˆ˜ì •
                                </button>
                                <button onclick="deleteComment(${comment.id})" style="background: none; border: none; color: #536471; cursor: pointer; font-size: 13px;">
                                    ì‚­ì œ
                                </button>
                            ` : ''}
                        </div>
                        <!-- ê¸°ì¡´ ëŒ€ëŒ“ê¸€ë“¤ í‘œì‹œ -->
                        ${comment.replies && comment.replies.length > 0 ? comment.replies.map(reply => {
                            const isMyReply = isUserAuthenticated() && reply.my_ID === getCurrentUserId();
                            const replyTimeAgo = getRelativeTime(reply.created_at);
                            
                            return `
                                <div class="reply" style="margin-left: 32px; margin-top: 8px; padding-top: 8px; border-top: 1px solid #f0f0f0;" id="reply-${reply.id}">
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <a href="/profile/${reply.my_ID}/" style="text-decoration: none;">
                                            <div style="width: 20px; height: 20px; background: #1d9bf0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 10px; flex-shrink: 0;">
                                                ${reply.my_ID.charAt(0).toUpperCase()}
                                            </div>
                                        </a>
                                        
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 2px;">
                                                <a href="/profile/${reply.my_ID}/" style="text-decoration: none; display: flex; align-items: center; gap: 4px;">
                                                    <span style="font-weight: bold; color: #0f1419; font-size: 13px;">${reply.nickname || reply.my_ID}</span>
                                                    <span style="color: #536471; font-size: 11px; font-weight: normal;">@${reply.my_ID}</span>
                                                </a>
                                                <span style="color: #536471; font-size: 11px;">Â·</span>
                                                <span style="color: #536471; font-size: 11px;">${replyTimeAgo}</span>
                                                ${reply.is_edited ? '<span style="color: #536471; font-size: 10px; margin-left: 4px;">(ìˆ˜ì •ë¨)</span>' : ''}
                                            </div>
                                            
                                            <div class="reply-content" style="color: #0f1419; line-height: 1.4; font-size: 13px; margin-bottom: 6px;">
                                                ${reply.content}
                                            </div>
                                            
                                            ${isMyReply ? `
                                                <div style="display: flex; gap: 12px; font-size: 12px; color: #536471;">
                                                    <button onclick="editReply(${reply.id})" style="background: none; border: none; color: #536471; cursor: pointer; font-size: 12px;">ìˆ˜ì •</button>
                                                    <button onclick="deleteReply(${reply.id})" style="background: none; border: none; color: #536471; cursor: pointer; font-size: 12px;">ì‚­ì œ</button>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('') : ''}
                        <!-- ëŒ€ëŒ“ê¸€ ì‘ì„± í¼ (ì²˜ìŒì—ëŠ” ìˆ¨ê¹€) -->
                        <div id="reply-form-${comment.id}" style="display: none; margin-top: 12px;">
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="reply-input-${comment.id}" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                                       style="flex: 1; padding: 6px 12px; border: 1px solid #eff3f4; border-radius: 20px; outline: none; font-size: 13px;">
                                <button onclick="submitReply(${postId}, ${comment.id})" 
                                        style="padding: 6px 12px; background: #1d9bf0; color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 13px;">
                                    ì‘ì„±
                                </button>
                                <button onclick="hideReplyForm(${comment.id})" 
                                        style="padding: 6px 12px; background: #f0f0f0; color: #333; border: none; border-radius: 20px; cursor: pointer; font-size: 13px;">
                                    ì·¨ì†Œ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    commentsList.innerHTML = commentsHTML;
}

// í˜„ì¬ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ ì¶”ê°€
function getCurrentUserId() {
    // í˜ì´ì§€ì—ì„œ í˜„ì¬ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë°©ë²•
    // ë°©ë²• 1: HTMLì— ìˆ¨ê²¨ì§„ ë°ì´í„°ë¡œ ì¶”ê°€
    return document.querySelector('meta[name="current-user"]')?.content || null;
}
// ê³µìœ  ê¸°ëŠ¥
function sharePost(postId) {
    if (!isUserAuthenticated()) {
        Toast.warning('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
    }
    
    // ë¨¼ì € ê³µìœ  ì¹´ìš´íŠ¸ ì¦ê°€ (ì‚¬ìš©ìë‹¹ 1íšŒ)
    toggleShareCount(postId);
    
    // ê·¸ ë‹¤ìŒ ê³µìœ  ë„êµ¬ ì œê³µ
    const postUrl = window.location.origin + '/post/' + postId + '/';
    showShareOptions(postUrl);
}

// ê³µìœ  ì¹´ìš´íŠ¸ í† ê¸€ (ì‚¬ìš©ìë‹¹ 1íšŒ)
function toggleShareCount(postId) {
    fetch('/post/' + postId + '/share/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
    })
    .then(response => response.json())
    .then(data => {
        const sharesCount = document.getElementById('shares-count-' + postId);
        sharesCount.textContent = data.shares_count;
        
        // ê³µìœ  ìƒíƒœì— ë”°ë¼ ì•„ì´ì½˜ ìƒ‰ìƒ ë³€ê²½
        const shareIcon = document.getElementById('share-icon-' + postId);
        shareIcon.style.color = data.shared ? '#1d9bf0' : '#536471';
    })
    .catch(error => {
        console.error('ê³µìœ  ì¹´ìš´íŠ¸ ì˜¤ë¥˜:', error);
    });
}

// ê³µìœ  ë„êµ¬ ëª¨ë‹¬ í‘œì‹œ
function showShareOptions(postUrl) {
    const shareOptions = [
        { name: 'KakaoTalk', icon: 'ğŸ’¬', color: '#FEE500', textColor: '#3C1E1E', action: () => shareToKakao(postUrl) },
        { name: 'Instagram', icon: 'ğŸ“·', color: 'linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%)', textColor: '#ffffff', action: () => shareToInstagram(postUrl) },
        { name: 'Twitter', icon: 'ğŸ¦', color: '#1DA1F2', textColor: '#ffffff', action: () => shareToTwitter(postUrl) },
        { name: 'URL ë³µì‚¬', icon: 'ğŸ”—', color: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', textColor: '#ffffff', action: () => copyToClipboard(postUrl) }
    ];
    
    let optionsHtml = `
    <div style="padding: 32px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 20px;">
        <div style="text-align: center; margin-bottom: 24px;">
            <div style="font-size: 24px; margin-bottom: 8px;">âœ¨</div>
            <h3 style="margin: 0; font-size: 20px; font-weight: 700; color: #2d3748; letter-spacing: -0.5px;">ê³µìœ í•˜ê¸°</h3>
            <p style="margin: 8px 0 0 0; color: #718096; font-size: 14px;">ì¹œêµ¬ë“¤ê³¼ ì´ í¬ìŠ¤íŠ¸ë¥¼ ê³µìœ í•´ë³´ì„¸ìš”!</p>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
    `;
    
    shareOptions.forEach((option, index) => {
        optionsHtml += `
            <button onclick="handleShareOption(${index})" 
                style="
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    padding: 20px 16px;
                    background: ${option.color};
                    color: ${option.textColor};
                    border: none;
                    border-radius: 16px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 600;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    position: relative;
                    overflow: hidden;
                "
                onmouseover="
                    this.style.transform='translateY(-2px) scale(1.02)';
                    this.style.boxShadow='0 8px 25px rgba(0,0,0,0.25)';
                "
                onmouseout="
                    this.style.transform='translateY(0) scale(1)';
                    this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';
                "
                onmousedown="this.style.transform='translateY(-1px) scale(0.98)'"
                onmouseup="this.style.transform='translateY(-2px) scale(1.02)'"
            >
                <div style="font-size: 24px; margin-bottom: 8px;">${option.icon}</div>
                <div style="font-size: 13px; font-weight: 600;">${option.name}</div>
            </button>
        `;
    });
    
    optionsHtml += `
        </div>
        <button onclick="closeShareModal()" 
            style="
                width: 100%;
                padding: 14px;
                background: rgba(255,255,255,0.9);
                color: #4a5568;
                border: 2px solid rgba(255,255,255,0.3);
                border-radius: 12px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.2s ease;
                backdrop-filter: blur(10px);
            "
            onmouseover="
                this.style.background='rgba(255,255,255,1)';
                this.style.transform='translateY(-1px)';
            "
            onmouseout="
                this.style.background='rgba(255,255,255,0.9)';
                this.style.transform='translateY(0)';
            "
        >
            ë‹«ê¸°
        </button>
    </div>
    `;
    
    // ê³µìœ  ëª¨ë‹¬ ìƒì„±
    const shareModal = document.createElement('div');
    shareModal.id = 'share-modal';
    shareModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: modalFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    `;
    
    const shareContent = document.createElement('div');
    shareContent.style.cssText = `
        background: transparent;
        border-radius: 20px;
        max-width: 360px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        transform-origin: center;
    `;
    shareContent.innerHTML = optionsHtml;
    
    shareModal.appendChild(shareContent);
    
    // CSS ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
    const style = document.createElement('style');
    style.textContent = `
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes modalSlideIn {
            from { 
                transform: scale(0.7) translateY(20px);
                opacity: 0;
            }
            to { 
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        @keyframes modalSlideOut {
            from { 
                transform: scale(1) translateY(0);
                opacity: 1;
            }
            to { 
                transform: scale(0.7) translateY(-20px);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(shareModal);
    
    // ì „ì—­ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì €ì¥
    window.currentShareOptions = shareOptions;
    
    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸° (ì• ë‹ˆë©”ì´ì…˜ í¬í•¨)
    shareModal.addEventListener('click', function(e) {
        if (e.target === shareModal) {
            closeShareModalWithAnimation();
        }
    });
    
    // ESC í‚¤ë¡œ ë‹«ê¸°
    const handleEsc = (e) => {
        if (e.key === 'Escape') {
            closeShareModalWithAnimation();
            document.removeEventListener('keydown', handleEsc);
        }
    };
    document.addEventListener('keydown', handleEsc);
}

// ì• ë‹ˆë©”ì´ì…˜ê³¼ í•¨ê»˜ ëª¨ë‹¬ ë‹«ê¸°
function closeShareModalWithAnimation() {
    const modal = document.getElementById('share-modal');
    const content = modal?.querySelector('div');
    
    if (modal && content) {
        modal.style.animation = 'modalFadeIn 0.2s cubic-bezier(0.4, 0, 0.2, 1) reverse';
        content.style.animation = 'modalSlideOut 0.2s cubic-bezier(0.4, 0, 0.2, 1)';
        
        setTimeout(() => {
            closeShareModal();
        }, 200);
    }
}

// ê¸°ì¡´ closeShareModal í•¨ìˆ˜ ìˆ˜ì •
function closeShareModal() {
    const modal = document.getElementById('share-modal');
    if (modal) {
        modal.remove();
    }
    window.currentShareOptions = null;
}

// ì¹´ì¹´ì˜¤í†¡ ê³µìœ 
function shareToKakao(postUrl) {
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        // ëª¨ë°”ì¼ì—ì„œëŠ” ì¹´ì¹´ì˜¤í†¡ URL ìŠ¤í‚´ ì‚¬ìš©
        const kakaoUrl = `kakaotalk://send?text=${encodeURIComponent('FinTech SNSì—ì„œ í¥ë¯¸ë¡œìš´ í¬ìŠ¤íŠ¸ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤! ' + postUrl)}`;
        window.location.href = kakaoUrl;
        
        // ì¹´ì¹´ì˜¤í†¡ ì•±ì´ ì—†ì„ ê²½ìš° ëŒ€ì²´ ë°©ë²•
        setTimeout(() => {
            copyToClipboard(postUrl);
            Toast.warning('ì¹´ì¹´ì˜¤í†¡ ì•±ìœ¼ë¡œ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. URLì´ ë³µì‚¬ë˜ì—ˆìœ¼ë‹ˆ ì¹´ì¹´ì˜¤í†¡ì—ì„œ ì§ì ‘ ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
        }, 1000);
    } else {
        // ë°ìŠ¤í¬íƒ‘ì—ì„œëŠ” URL ë³µì‚¬ í›„ ì•ˆë‚´
        copyToClipboard(postUrl);
        Toast.warning('URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì¹´ì¹´ì˜¤í†¡ì—ì„œ ë¶™ì—¬ë„£ê¸° í•˜ì—¬ ê³µìœ í•˜ì„¸ìš”.');
    }
    
    closeShareModal();
}

// Instagram ê³µìœ 
function shareToInstagram(postUrl) {
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        // ëª¨ë°”ì¼ì—ì„œëŠ” Instagram ì•±ìœ¼ë¡œ ì—°ê²° ì‹œë„
        const instagramUrl = `instagram://library?AssetPath=${encodeURIComponent(postUrl)}`;
        window.location.href = instagramUrl;
        
        setTimeout(() => {
            copyToClipboard(postUrl);
            Toast.warning('Instagram ì•±ìœ¼ë¡œ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. URLì´ ë³µì‚¬ë˜ì—ˆìœ¼ë‹ˆ Instagramì—ì„œ ì§ì ‘ ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
        }, 1000);
    } else {
        copyToClipboard(postUrl);
        Toast.warning('URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. Instagram ì›¹ì‚¬ì´íŠ¸ë‚˜ ì•±ì—ì„œ ë¶™ì—¬ë„£ê¸° í•˜ì—¬ ê³µìœ í•˜ì„¸ìš”.');
    }
    
    closeShareModal();
}

// Twitter ê³µìœ 
function shareToTwitter(postUrl) {
    const twitterUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(postUrl)}&text=${encodeURIComponent('FinTech SNSì—ì„œ í¥ë¯¸ë¡œìš´ í¬ìŠ¤íŠ¸ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!')}`;
    window.open(twitterUrl, '_blank');
    closeShareModal();
}

// URL í´ë¦½ë³´ë“œ ë³µì‚¬
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        Toast.warning('URLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        closeShareModal();
    }).catch(err => {
        console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
        Toast.error('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}

// ê³µìœ  ì˜µì…˜ ì²˜ë¦¬
function handleShareOption(index) {
    if (window.currentShareOptions && window.currentShareOptions[index]) {
        window.currentShareOptions[index].action();
    }
}

// ê³µìœ  ëª¨ë‹¬ ë‹«ê¸°
function closeShareModal() {
    const modal = document.getElementById('share-modal');
    if (modal) {
        modal.remove();
    }
    window.currentShareOptions = null;
}
// ì‹¤ì‹œê°„ í…ìŠ¤íŠ¸ ì…ë ¥ ì²˜ë¦¬
function handleTextInput(textarea) {
    const text = textarea.value;
    
    // í•´ì‹œíƒœê·¸ ê°ì§€
    const hashtags = extractHashtags(text);
    
    // í•´ì‹œíƒœê·¸ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    updateHashtagPreview(hashtags);
    
    // í¬ìŠ¤íŠ¸ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    PostStateManager.updatePostButton();
}

// í•´ì‹œíƒœê·¸ ì¶”ì¶œ
function extractHashtags(text) {
    const hashtag_pattern = /#(\w+)/g;
    const matches = text.match(hashtag_pattern);
    return matches ? matches.map(tag => tag.substring(1)) : [];
}

// í•´ì‹œíƒœê·¸ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
function updateHashtagPreview(hashtags) {
    const preview = document.getElementById('hashtag-preview');
    const tagsSpan = document.getElementById('detected-tags');
    
    if (hashtags.length > 0) {
        tagsSpan.innerHTML = hashtags.map(tag => `<span style="background: #e3f2fd; padding: 2px 6px; border-radius: 8px; margin-right: 4px;">#${tag}</span>`).join('');
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
}


// ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
function showLoadingSpinner() {
    let spinner = document.getElementById('loading-spinner');
    if (!spinner) {
        spinner = document.createElement('div');
        spinner.id = 'loading-spinner';
        spinner.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #536471;">
                <div class="loading-spinner" style="display: inline-block; width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #1d9bf0; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <div style="margin-top: 8px;">í¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        `;
        document.getElementById('posts-container').appendChild(spinner);
    }
    spinner.style.display = 'block';
}

// ë¡œë”© ìŠ¤í”¼ë„ˆ ìˆ¨ê¸°ê¸°
function hideLoadingSpinner() {
    const spinner = document.getElementById('loading-spinner');
    if (spinner) {
        spinner.style.display = 'none';
    }
}
// ì´ë¯¸ì§€ ì§€ì—° ë¡œë”© êµ¬í˜„
const LazyLoader = {
    observer: null,
    
    init() {
        // Intersection Observer ì§€ì› í™•ì¸
        if ('IntersectionObserver' in window) {
            this.observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        this.loadImage(entry.target);
                        this.observer.unobserve(entry.target);
                    }
                });
            }, {
                root: null,
                rootMargin: '50px', // 50px ì „ì— ë¯¸ë¦¬ ë¡œë“œ
                threshold: 0.1
            });
            
            // ê¸°ì¡´ ì´ë¯¸ì§€ë“¤ ê´€ì°° ì‹œì‘
            this.observeImages();
        } else {
            // êµ¬í˜• ë¸Œë¼ìš°ì €ëŠ” ì¦‰ì‹œ ëª¨ë“  ì´ë¯¸ì§€ ë¡œë“œ
            this.loadAllImages();
        }
    },
    
    observeImages() {
        const lazyImages = document.querySelectorAll('.lazy-image');
        lazyImages.forEach(img => {
            this.observer.observe(img);
        });
    },
    
    loadImage(img) {
        const src = img.getAttribute('data-src');
        if (src) {
            img.src = src;
            img.classList.add('loaded');
            img.removeAttribute('data-src');
        }
    },
    
    loadAllImages() {
        const lazyImages = document.querySelectorAll('.lazy-image');
        lazyImages.forEach(img => {
            this.loadImage(img);
        });
    },
    
    // ìƒˆë¡œìš´ ì´ë¯¸ì§€ê°€ ì¶”ê°€ë  ë•Œ í˜¸ì¶œ
    observeNewImages() {
        const newImages = document.querySelectorAll('.lazy-image:not(.loaded)');
        newImages.forEach(img => {
            if (this.observer) {
                this.observer.observe(img);
            } else {
                this.loadImage(img);
            }
        });
    }
};

// ë¬´í•œ ìŠ¤í¬ë¡¤ ê´€ë¦¬ ê°ì²´
const InfiniteScroll = {
    currentPage: 1,
    isLoading: false,
    hasMorePosts: true,
    debounceTimer: null,
    
    init() {
        window.addEventListener('scroll', () => {
            clearTimeout(this.debounceTimer);
            this.debounceTimer = setTimeout(() => {
                this.handleScroll();
            }, 150);
        });
    },
    
    handleScroll() {
        if (this.isLoading || !this.hasMorePosts) return;
        
        const threshold = 300;
        const scrolled = window.innerHeight + window.scrollY;
        const documentHeight = document.body.offsetHeight;
        
        if (scrolled >= documentHeight - threshold) {
            this.loadMorePosts();
        }
    },
    
    loadMorePosts() {
        this.isLoading = true;
        this.currentPage++;
        
        showLoadingSpinner();
        
        fetch(`/home/load-more-posts/?page=${this.currentPage}`)
            .then(response => response.json())
            .then(data => {
                if (data.posts && data.posts.length > 0) {
                    data.posts.forEach((post, index) => {
                        setTimeout(() => {
                            addPostToFeed(post);
                        }, index * 100); // 100ms ê°„ê²©ìœ¼ë¡œ ìˆœì°¨ ë“±ì¥
                    });
                    this.hasMorePosts = data.has_next;
                } else {
                    this.hasMorePosts = false;
                }
            })
            .catch(error => {
                console.error('í¬ìŠ¤íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', error);
                this.currentPage--;
            })
            .finally(() => {
                this.isLoading = false;
                hideLoadingSpinner();
            });
    }
};
// ìƒëŒ€ì‹œê°„ ê³„ì‚° í•¨ìˆ˜
function getRelativeTime(dateString) {
    const now = new Date();
    const postTime = new Date(dateString);
    const diffInSeconds = Math.floor((now - postTime) / 1000);
    
    if (diffInSeconds < 60) {
        return "ë°©ê¸ˆ ì „";
    } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes}ë¶„ ì „`;
    } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours}ì‹œê°„ ì „`;
    } else if (diffInSeconds < 2592000) {
        const days = Math.floor(diffInSeconds / 86400);
        return `${days}ì¼ ì „`;
    } else if (diffInSeconds < 31536000) {
        const months = Math.floor(diffInSeconds / 2592000);
        return `${months}ê°œì›” ì „`;
    } else {
        const years = Math.floor(diffInSeconds / 31536000);
        return `${years}ë…„ ì „`;
    }
}

// ëª¨ë“  í¬ìŠ¤íŠ¸ ì‹œê°„ ì—…ë°ì´íŠ¸
function updateAllPostTimes() {
    const timeElements = document.querySelectorAll('.post-time[data-timestamp]');
    timeElements.forEach(element => {
        const timestamp = element.getAttribute('data-timestamp');
        element.textContent = getRelativeTime(timestamp);
    });
}

// 1ë¶„ë§ˆë‹¤ ì‹œê°„ ì—…ë°ì´íŠ¸
setInterval(updateAllPostTimes, 60000);
// í¬ìŠ¤íŠ¸ ìˆ˜ì • ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
function showEditModal(post) {
    const modal = document.createElement('div');
    modal.id = 'edit-modal';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 1000;
        display: flex; align-items: center; justify-content: center;
    `;
    
    const modalContent = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 500px; padding: 20px;">
            <h3 style="margin: 0 0 15px 0;">í¬ìŠ¤íŠ¸ ìˆ˜ì •</h3>
            <textarea id="edit-content" style="width: 100%; height: 120px; border: 1px solid #ddd; border-radius: 8px; padding: 12px; resize: vertical;">${post.content}${post.tags.map(tag => ' #' + tag).join('')}</textarea>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button onclick="submitEdit(${post.id})" style="flex: 1; background: #1d9bf0; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">ìˆ˜ì •</button>
                <button onclick="closeEditModal()" style="flex: 1; background: #f0f0f0; color: #333; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">ì·¨ì†Œ</button>
            </div>
        </div>
    `;
    
    modal.innerHTML = modalContent;
    document.body.appendChild(modal);
}

function submitEdit(postId) {
    const content = document.getElementById('edit-content').value.trim();
    
    if (!content) {
        Toast.warning('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    fetch(`/home/post/${postId}/edit/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updatePostInDOM(postId, data.post);
            closeEditModal();
            Toast.success('í¬ìŠ¤íŠ¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            Toast.error(data.error);
        }
    })
    .catch(error => {
        Toast.error('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

function updatePostInDOM(postId, postData) {
    const postCard = document.querySelector(`[data-post-id="${postId}"]`).closest('.post-card');
    const contentElement = postCard.querySelector('.post-content');
    
    contentElement.textContent = postData.content;
    
    // ê¸°ì¡´ íƒœê·¸ ì œê±°
    const existingTagsDiv = contentElement.nextElementSibling;
    if (existingTagsDiv && existingTagsDiv.querySelector('span[onclick*="toggleFilter"]')) {
        existingTagsDiv.remove();
    }
    
    // ìƒˆ íƒœê·¸ ì¶”ê°€
    if (postData.tags.length > 0) {
        let tagsHtml = '<div style="margin: 10px 0;">';
        postData.tags.forEach(tag => {
            tagsHtml += `<span onclick="toggleFilter('${tag}')" style="display: inline-block; background: #f0f8ff; color: #1d9bf0; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-right: 6px; margin-bottom: 4px; cursor: pointer; border: 1px solid #e1f5fe;">#${tag}</span>`;
        });
        tagsHtml += '</div>';
        contentElement.insertAdjacentHTML('afterend', tagsHtml);
    }
}

function closeEditModal() {
    const modal = document.getElementById('edit-modal');
    if (modal) modal.remove();
}

// ì‹ ê³  ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
function showReportModal(postId) {
    const modal = document.createElement('div');
    modal.id = 'report-modal';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 1000;
        display: flex; align-items: center; justify-content: center;
    `;
    
    const modalContent = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 400px; padding: 20px;">
            <h3 style="margin: 0 0 15px 0;">í¬ìŠ¤íŠ¸ ì‹ ê³ </h3>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px;"><input type="radio" name="report-reason" value="spam" style="margin-right: 8px;"> ìŠ¤íŒ¸</label>
                <label style="display: block; margin-bottom: 8px;"><input type="radio" name="report-reason" value="abuse" style="margin-right: 8px;"> ìš•ì„¤/ë¹„ë°©</label>
                <label style="display: block; margin-bottom: 8px;"><input type="radio" name="report-reason" value="inappropriate" style="margin-right: 8px;"> ë¶€ì ì ˆí•œ ë‚´ìš©</label>
                <label style="display: block; margin-bottom: 8px;"><input type="radio" name="report-reason" value="fake" style="margin-right: 8px;"> í—ˆìœ„ ì •ë³´</label>
                <label style="display: block; margin-bottom: 8px;"><input type="radio" name="report-reason" value="other" style="margin-right: 8px;"> ê¸°íƒ€</label>
            </div>
            <textarea id="report-description" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒì‚¬í•­)" style="width: 100%; height: 80px; border: 1px solid #ddd; border-radius: 6px; padding: 8px; resize: vertical;"></textarea>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button onclick="submitReport(${postId})" style="flex: 1; background: #e74c3c; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">ì‹ ê³ </button>
                <button onclick="closeReportModal()" style="flex: 1; background: #f0f0f0; color: #333; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">ì·¨ì†Œ</button>
            </div>
        </div>
    `;
    
    modal.innerHTML = modalContent;
    document.body.appendChild(modal);
}

function submitReport(postId) {
    const reason = document.querySelector('input[name="report-reason"]:checked')?.value;
    const description = document.getElementById('report-description').value;
    
    if (!reason) {
        Toast.warning('ì‹ ê³  ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    fetch(`/home/post/${postId}/report/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({
            reason: reason,
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeReportModal();
            Toast.success(data.message);
        } else {
            Toast.error(data.error);
        }
    })
    .catch(error => {
        Toast.error('ì‹ ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

function closeReportModal() {
    const modal = document.getElementById('report-modal');
    if (modal) modal.remove();
}
// Toast ë©”ì‹œì§€ ì‹œìŠ¤í…œ
const Toast = {
    show(message, type = 'info', duration = 3000) {
        // ê¸°ì¡´ toast ì œê±°
        const existingToast = document.querySelector('.toast');
        if (existingToast) {
            existingToast.remove();
        }
        
        // ìƒˆ toast ìƒì„±
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        // ìë™ ì œê±°
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 300);
        }, duration);
    },
    
    success(message) {
        this.show(message, 'success');
    },
    
    error(message) {
        this.show(message, 'error');
    },
    
    warning(message) {
        this.show(message, 'warning');
    }
};
function togglePostMenu(postId, isMyPost) {
    // í˜„ì¬ ì—´ë¦° ë©”ë‰´ê°€ ê°™ì€ í¬ìŠ¤íŠ¸ì¸ì§€ í™•ì¸
    const existingMenu = document.querySelector('.post-menu-dropdown');
    if (existingMenu && existingMenu.dataset.postId === postId.toString()) {
        // ê°™ì€ ë²„íŠ¼ í´ë¦­ì‹œ ë©”ë‰´ ë‹«ê¸°
        existingMenu.remove();
        return;
    }
    
    // ë‹¤ë¥¸ ë©”ë‰´ê°€ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
    if (existingMenu) {
        existingMenu.remove();
    }
    
    // ë©”ë‰´ ìƒì„±
    const menuDiv = document.createElement('div');
    menuDiv.className = 'post-menu-dropdown show';
    menuDiv.dataset.postId = postId; // í¬ìŠ¤íŠ¸ ID ì €ì¥
    
    let menuItems = '';
    
    if (isMyPost) {
        // ë‚´ í¬ìŠ¤íŠ¸ ë©”ë‰´
        menuItems = `
            <div class="menu-item" onclick="editPost(${postId})">
                <span class="material-symbols-outlined" style="font-size: 18px;">edit</span>
                ìˆ˜ì •í•˜ê¸°
            </div>
            <div class="menu-item danger" onclick="deletePost(${postId})">
                <span class="material-symbols-outlined" style="font-size: 18px;">delete</span>
                ì‚­ì œí•˜ê¸°
            </div>
            <div class="menu-item" onclick="copyPostLink(${postId})">
                <span class="material-symbols-outlined" style="font-size: 18px;">link</span>
                ë§í¬ ë³µì‚¬
            </div>
        `;
    } else {
        // ë‹¤ë¥¸ ì‚¬ëŒ í¬ìŠ¤íŠ¸ ë©”ë‰´
        menuItems = `
            <div class="menu-item" onclick="copyPostLink(${postId})">
                <span class="material-symbols-outlined" style="font-size: 18px;">link</span>
                ë§í¬ ë³µì‚¬
            </div>
            <div class="menu-item" onclick="hidePost(${postId})">
                <span class="material-symbols-outlined" style="font-size: 18px;">visibility_off</span>
                ê´€ì‹¬ ì—†ìŒ
            </div>
            <div class="menu-item danger" onclick="reportPost(${postId})">
                <span class="material-symbols-outlined" style="font-size: 18px;">flag</span>
                í¬ìŠ¤íŠ¸ ì‹ ê³ 
            </div>
        `;
    }
    
    menuDiv.innerHTML = menuItems;
    
    // bodyì— ì¶”ê°€í•˜ê³  ìœ„ì¹˜ ê³„ì‚°
    const menuBtn = document.querySelector(`[data-post-id="${postId}"]`);
    const btnRect = menuBtn.getBoundingClientRect();
    
    menuDiv.style.position = 'fixed';
    menuDiv.style.top = btnRect.bottom + 'px';
    menuDiv.style.left = (btnRect.right - 180) + 'px';
    menuDiv.style.width = '180px';
    menuDiv.style.zIndex = '1000';
    
    document.body.appendChild(menuDiv);
    
    // ì™¸ë¶€ í´ë¦­ì‹œ ë©”ë‰´ ë‹«ê¸°
    setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
            if (!menuBtn.contains(e.target) && !menuDiv.contains(e.target)) {
                menuDiv.remove();
                document.removeEventListener('click', closeMenu);
            }
        });
    }, 10);
}
// ë©”ë‰´ ê¸°ëŠ¥ í•¨ìˆ˜ë“¤
function editPost(postId) {
    closePostMenu();
    
    // í¬ìŠ¤íŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    fetch(`/home/post/${postId}/edit/`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showEditModal(data.post);
        } else {
            Toast.error(data.error);
        }
    })
    .catch(error => {
        Toast.error('í¬ìŠ¤íŠ¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    });
}

function deletePost(postId) {
    closePostMenu();
    if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        fetch(`/home/post/${postId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // DOMì—ì„œ í¬ìŠ¤íŠ¸ ì œê±°
                const postCard = document.querySelector(`[data-post-id="${postId}"]`).closest('.post-card');
                postCard.remove();
                Toast.success('í¬ìŠ¤íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                Toast.error(data.error || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            Toast.error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }
}
function copyPostLink(postId) {
    closePostMenu();
    const postUrl = window.location.origin + `/post/${postId}/`;
    navigator.clipboard.writeText(postUrl).then(() => {
        Toast.success('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }).catch(() => {
        Toast.error('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}

function hidePost(postId) {
    closePostMenu();
    
    fetch(`/home/post/${postId}/hide/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const postCard = document.querySelector(`[data-post-id="${postId}"]`).closest('.post-card');
            postCard.style.display = 'none';
            Toast.success('í¬ìŠ¤íŠ¸ë¥¼ ìˆ¨ê²¼ìŠµë‹ˆë‹¤.');
        } else {
            Toast.error(data.error);
        }
    })
    .catch(error => {
        Toast.error('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

function reportPost(postId) {
    closePostMenu();
    showReportModal(postId);
}
function closePostMenu() {
    const existingMenu = document.querySelector('.post-menu-dropdown');
    if (existingMenu) {
        existingMenu.remove();
    }
}
// ëŒ“ê¸€ ìˆ˜ì • í•¨ìˆ˜
function editComment(commentId) {
    const commentDiv = document.getElementById(`comment-${commentId}`);
    const contentDiv = commentDiv.querySelector('.comment-content');
    const currentContent = contentDiv.textContent;
    
    // ìˆ˜ì • í¼ìœ¼ë¡œ êµì²´
    contentDiv.innerHTML = `
        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
            <input type="text" id="edit-comment-input-${commentId}" value="${currentContent}" 
                   style="flex: 1; padding: 6px 12px; border: 1px solid #eff3f4; border-radius: 20px; outline: none; font-size: 13px;">
            <button onclick="saveCommentEdit(${commentId})" 
                    style="padding: 6px 12px; background: #1d9bf0; color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 13px;">
                ì €ì¥
            </button>
            <button onclick="cancelCommentEdit(${commentId}, '${currentContent}')" 
                    style="padding: 6px 12px; background: #f0f0f0; color: #333; border: none; border-radius: 20px; cursor: pointer; font-size: 13px;">
                ì·¨ì†Œ
            </button>
        </div>
    `;
}

// ëŒ“ê¸€ ìˆ˜ì • ì €ì¥
function saveCommentEdit(commentId) {
    const newContent = document.getElementById(`edit-comment-input-${commentId}`).value.trim();
    
    if (!newContent) {
        Toast.warning('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    fetch(`/home/comment/${commentId}/edit/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({ content: newContent })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const commentDiv = document.getElementById(`comment-${commentId}`);
            const contentDiv = commentDiv.querySelector('.comment-content');
            contentDiv.innerHTML = `${data.comment.content}`;
            
            // (ìˆ˜ì •ë¨) í‘œì‹œ ì¶”ê°€
            const timeSpan = commentDiv.querySelector('.comment-time');
            if (timeSpan && !timeSpan.querySelector('.edited-label')) {
                timeSpan.insertAdjacentHTML('afterend', '<span class="edited-label" style="color: #536471; font-size: 11px; margin-left: 4px;">(ìˆ˜ì •ë¨)</span>');
            }
            
            Toast.success('ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            Toast.error(data.error);
        }
    })
    .catch(error => {
        Toast.error('ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ëŒ“ê¸€ ìˆ˜ì • ì·¨ì†Œ
function cancelCommentEdit(commentId, originalContent) {
    const commentDiv = document.getElementById(`comment-${commentId}`);
    const contentDiv = commentDiv.querySelector('.comment-content');
    contentDiv.innerHTML = originalContent;
}

// ëŒ“ê¸€ ì‚­ì œ
function deleteComment(commentId) {
    if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    fetch(`/home/comment/${commentId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`comment-${commentId}`).remove();
            Toast.success('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            Toast.error(data.error);
        }
    })
    .catch(error => {
        Toast.error('ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ë‹µê¸€ í¼ í‘œì‹œ
function showReplyForm(commentId) {
    const replyForm = document.getElementById(`reply-form-${commentId}`);
    replyForm.style.display = 'block';
    document.getElementById(`reply-input-${commentId}`).focus();
}

// ë‹µê¸€ í¼ ìˆ¨ê¸°ê¸°
function hideReplyForm(commentId) {
    const replyForm = document.getElementById(`reply-form-${commentId}`);
    replyForm.style.display = 'none';
    document.getElementById(`reply-input-${commentId}`).value = '';
}

// ë‹µê¸€ ì‘ì„±
function submitReply(postId, parentCommentId) {
    const replyInput = document.getElementById(`reply-input-${parentCommentId}`);
    const content = replyInput.value.trim();
    
    if (!content) {
        Toast.warning('ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    fetch(`/home/comment/${parentCommentId}/reply/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.reply_id) {
            // ë‹µê¸€ ì¶”ê°€
            addReplyToComment(parentCommentId, data);
            
            // ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸
            const commentsCountElement = document.querySelector(`[data-post-id="${postId}"][data-action="comments"] span:last-child`);
            commentsCountElement.textContent = data.comments_count;
            
            // ì…ë ¥ì°½ ì´ˆê¸°í™” ë° ìˆ¨ê¸°ê¸°
            replyInput.value = '';
            hideReplyForm(parentCommentId);
            
            Toast.success('ë‹µê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            Toast.error(data.error || 'ë‹µê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        console.error('ë‹µê¸€ ì‘ì„± ì˜¤ë¥˜:', error);
        Toast.error('ë‹µê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}
// ëŒ“ê¸€ì— ë‹µê¸€ ì¶”ê°€
function addReplyToComment(parentCommentId, replyData) {
    const commentDiv = document.getElementById(`comment-${parentCommentId}`);
    const timeAgo = 'ë°©ê¸ˆ ì „';
    const currentUserId = getCurrentUserId();
    const isMyReply = replyData.my_ID === currentUserId;
    
    // ëŒ€ëŒ“ê¸€ HTML ìƒì„±
    const replyHTML = `
        <div class="reply" style="margin-left: 32px; margin-top: 8px; padding-top: 8px; border-top: 1px solid #f0f0f0;" id="reply-${replyData.reply_id}">
            <div style="display: flex; align-items: flex-start; gap: 8px;">
                <!-- ë‹µê¸€ ì‘ì„±ì í”„ë¡œí•„ ì•„ì´ì½˜ -->
                <a href="/profile/${replyData.my_ID}/" style="text-decoration: none;">
                    <div style="width: 20px; height: 20px; background: #1d9bf0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 10px; flex-shrink: 0;">
                        ${replyData.my_ID.charAt(0).toUpperCase()}
                    </div>
                </a>
                
                <!-- ë‹µê¸€ ë‚´ìš© -->
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 2px;">
                        <a href="/profile/${replyData.my_ID}/" style="text-decoration: none; display: flex; align-items: center; gap: 4px;">
                            <span style="font-weight: bold; color: #0f1419; font-size: 13px;">${replyData.nickname || replyData.my_ID}</span>
                            <span style="color: #536471; font-size: 11px; font-weight: normal;">@${replyData.my_ID}</span>
                        </a>
                        <span style="color: #536471; font-size: 11px;">Â·</span>
                        <span style="color: #536471; font-size: 11px;">${timeAgo}</span>
                    </div>
                    
                    <div class="reply-content" style="color: #0f1419; line-height: 1.4; font-size: 13px; margin-bottom: 6px;">
                        ${replyData.content}
                    </div>
                    
                    <!-- ë‹µê¸€ ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
                    ${isMyReply ? `
                        <div style="display: flex; gap: 12px; font-size: 12px; color: #536471;">
                            <button onclick="editReply(${replyData.reply_id})" style="background: none; border: none; color: #536471; cursor: pointer; font-size: 12px;">
                                ìˆ˜ì •
                            </button>
                            <button onclick="deleteReply(${replyData.reply_id})" style="background: none; border: none; color: #536471; cursor: pointer; font-size: 12px;">
                                ì‚­ì œ
                            </button>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
    
    // ê¸°ì¡´ ëŒ€ëŒ“ê¸€ë“¤ ë’¤ì— ì¶”ê°€
    const existingReplies = commentDiv.querySelectorAll('.reply');
    if (existingReplies.length > 0) {
        // ë§ˆì§€ë§‰ ëŒ€ëŒ“ê¸€ ë’¤ì— ì¶”ê°€
        existingReplies[existingReplies.length - 1].insertAdjacentHTML('afterend', replyHTML);
    } else {
        // ì²« ë²ˆì§¸ ëŒ€ëŒ“ê¸€ì´ë©´ ë‹µê¸€ í¼ ì•ì— ì¶”ê°€
        const replyForm = document.getElementById(`reply-form-${parentCommentId}`);
        replyForm.insertAdjacentHTML('beforebegin', replyHTML);
    }
}
// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
document.addEventListener('DOMContentLoaded', function() {
    showSlide(0);
    
    // LazyLoader ì´ˆê¸°í™” ì¶”ê°€
    LazyLoader.init();

    updateAllPostTimes();
    
    setTimeout(() => {
        InfiniteScroll.init();
    }, 2000);
    document.addEventListener('click', function(e) {
        if (e.target.closest('.post-menu-btn')) {
            const menuBtn = e.target.closest('.post-menu-btn');
            const postId = menuBtn.getAttribute('data-post-id');
            const isMyPost = menuBtn.getAttribute('data-is-my-post') === 'true';
            
            togglePostMenu(postId, isMyPost);
        }
    });
    
    // ëª¨ë“  action ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    document.querySelectorAll('.action-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const action = this.getAttribute('data-action');
            const postId = this.getAttribute('data-post-id');
            
            if (action === 'like') {
                toggleLike(postId);
            } else if (action === 'comments') {
                toggleComments(postId);

            } else if (action === 'bookmark') {
                toggleBookmark(postId);

            } else if (action === 'share') {
                sharePost(postId);
            }
        });
    });
    // ëŒ“ê¸€ ì‘ì„± ë²„íŠ¼ë“¤
    document.querySelectorAll('[data-action="submit-comment"]').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const postId = this.getAttribute('data-post-id');
            submitComment(postId);
        });
    });
});

</script>
{% endblock %}