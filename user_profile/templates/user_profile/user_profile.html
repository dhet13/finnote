{% extends 'base.html' %}

{% block title %}프로필{% endblock %}

{% block feed %}
{% load static %}
{% load humanize %}
<div style="width: 100%; margin: 0 auto; background-color: #fff; border-radius: 16px; box-shadow: 0 0 10px rgba(0,0,0,0.1); overflow: hidden; border: 1px solid #ebeef0; box-sizing: border-box;">
    <!-- ... (profile header section remains the same) ... -->
    <div style="height: 160px; position: relative; background-color: #cfd9de;">
        {% if user_to_view.background_picture %}
            <img src="{{ user_to_view.background_picture.url }}" alt="" style="width: 100%; height: 100%; object-fit: cover; display: block;">
        {% else %}
            <div style="height: 100%; background-color: #cfd9de;"></div>
        {% endif %}
    </div>

    <div style="padding: 16px; display: flex; flex-direction: column; align-items: center;">
        <div style="margin-top: -80px; margin-left: -360px; width: 130px; height: 130px; border-radius: 50%; background-color: #fff; border: 4px solid #fff; z-index: 2; position: relative; overflow: hidden;">
            {% if user_to_view.profile_picture %}
                <img src="{{ user_to_view.profile_picture.url }}" alt="" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
            {% else %}
                <div style="background-color: #e1e8ed; border: 4px solid #e1e8ed; width: 100%; height: 100%; border-radius: 50%;"></div>
            {% endif %}
        </div>
        
        <div style="display: flex; justify-content: flex-end; margin-top: -40px; margin-bottom: 16px; z-index: 1; position: relative; padding-right: 16px; width: 100%;">
            {% if request.user.my_ID == user_to_view.my_ID %}
                <a href="{% url 'user_profile:edit_profile' %}" style="background-color: #fff; color: #1da1f2; border: 1px solid #1da1f2; padding: 8px 16px; border-radius: 9999px; text-decoration: none; font-weight: bold; font-size: 14px; white-space: nowrap; transition: background-color 0.2s, color 0.2s;">프로필 수정</a>
            {% endif %}
        </div>
        
        <div style="margin-top: 20px; width: 100%;">
            <div style="display: flex; align-items: center;">                                                                                     
                <h2 style="margin: 0; font-size: 20px; font-weight: bold; color: #14171a; margin-right: 8px;">{{ user_to_view.nickname }}</h2>        
                {% if user_to_view.is_private %}                                                                                                      
                    <img src="{% static 'icon/lock.svg' %}" alt="Private" style="width: 20px; height: 20px;">                                         
                {% endif %}                                                                                                                           
            </div> 
            <p style="color: #657786; font-size: 15px; margin-top: 4px;">@{{ user_to_view.my_ID }}</p>
            
            <div style="display: flex; align-items: center; color: #657786; font-size: 15px; margin-top: 8px; width: 100%;">
                <p style="margin: 0; margin-right: 16px;"><span style="margin-right: 4px;">🗓️</span><span style="margin-right: 4px;">가입일: {{ user_to_view.created_at|date:"Y년 n월 j일" }}</span></p>

            </div>
        </div>
    </div>

    <div style="display: flex; justify-content: space-around; border-bottom: 1px solid #ebeef0; padding: 12px 0; margin-top: 16px;">
        <a href="{% url 'user_profile:profile' my_ID=request.user.my_ID %}" style="text-decoration: none; color: #657786; font-weight: bold; padding: 8px 16px; border-radius: 9999px; transition: background-color 0.2s;">자산 현황</a>
        <a href="{% url 'user_profile:user_likes' %}" style="text-decoration: none; color: #657786; font-weight: bold; padding: 8px 16px; border-radius: 9999px; transition: background-color 0.2s;">좋아요</a>
        <a href="#" style="text-decoration: none; color: #657786; font-weight: bold; padding: 8px 16px; border-radius: 9999px; transition: background-color 0.2s;">북마크</a>
        <a href="#" style="text-decoration: none; color: #657786; font-weight: bold; padding: 8px 16px; border-radius: 9999px; transition: background-color 0.2s;">게시물</a>
    </div>
    <div style="padding: 16px; border-top: 1px solid #ebeef0; margin-top: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 style="margin: 0; font-size: 18px; font-weight: bold;">보유 주식</h3>
            {% if request.user.my_ID == user_to_view.my_ID %}
                <a href="{% url 'user_profile:add_stock_asset' %}" style="background-color: #007bff; color: white; padding: 8px 16px; border-radius: 8px; text-decoration: none; font-weight: 500;">자산 추가</a>
            {% endif %}
        </div>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 1px solid #ddd;">
                    <th style="padding: 12px; text-align: left; color: #333;">종목명</th>
                    <th style="padding: 12px; text-align: right; color: #333;">보유 수량</th>
                    <th style="padding: 12px; text-align: right; color: #333;">평균 매수가</th>
                    {% if request.user.my_ID == user_to_view.my_ID %}
                        <th style="padding: 12px; text-align: right; color: #333;"></th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% if user_to_view.is_private and not is_profile_owner %}
                    <tr>
                        <td colspan="4" style="padding: 20px; text-align: center; color: #777;">
                            이 프로필은 비공개입니다.
                        </td>
                    </tr>
                {% else %}
                    {% for journal in stock_journals %}
                        {% if journal.net_qty > 0 %}
                            <tr id="stock-row-{{ journal.ticker_symbol.ticker_symbol }}" style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px;">
                                    <div style="font-weight: 600;">{{ journal.ticker_symbol.stock_name }}</div>
                                    <div style="font-size: 0.9em; color: #666;">{{ journal.ticker_symbol.ticker_symbol }}</div>
                                </td>
                                <td style="padding: 12px; text-align: right;">{{ journal.net_qty|floatformat:"-2g"|intcomma }} 주</td>
                                <td style="padding: 12px; text-align: right;">\ {{ journal.avg_buy_price|floatformat:"-2g"|intcomma }}</td>
                                {% if request.user.my_ID == user_to_view.my_ID %}
                                    <td style="padding: 12px; text-align: right;">
                                        <button onclick="confirmAndDelete('{{ journal.ticker_symbol.ticker_symbol }}')"
                                           style="background: none; border: none; color: #dc3545; font-weight: bold; font-size: 1.2em; cursor: pointer;">
                                           X
                                        </button>
                                    </td>
                                {% endif %}
                            </tr>
                        {% endif %}
                    {% endfor %}
                    {% if not stock_journals %}
                         <tr>
                            <td colspan="3" style="padding: 20px; text-align: center; color: #777;">보유 주식이 없습니다.</td>
                        </tr>
                    {% endif %}
                {% endif %}
            </tbody>
        </table>
    </div>

    <div style="padding: 16px; border-top: 1px solid #ebeef0; margin-top: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 style="margin: 0; font-size: 18px; font-weight: bold;">보유 부동산</h3>
            {% if request.user.my_ID == user_to_view.my_ID %}
                <a href="{% url 'user_profile:add_real_estate_asset' %}" style="background-color: #007bff; color: white; padding: 8px 16px; border-radius: 8px; text-decoration: none; font-weight: 500;">부동산 추가</a>
            {% endif %}
        </div>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 1px solid #ddd;">
                    <th style="padding: 12px; text-align: left; color: #333;">건물 이름</th>
                    <th style="padding: 12px; text-align: right; color: #333;">거래 종류</th>
                    <th style="padding: 12px; text-align: right; color: #333;">계약일</th>
                    <th style="padding: 12px; text-align: right; color: #333;">거래가</th>
                    {% if request.user.my_ID == user_to_view.my_ID %}
                        <th style="padding: 12px; text-align: right; color: #333;"></th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% if user_to_view.is_private and not is_profile_owner %}
                    <tr>
                        <td colspan="4" style="padding: 20px; text-align: center; color: #777;">
                            이 프로필은 비공개입니다.
                        </td>
                    </tr>
                {% else %}
                    {% for deal in re_deals %}
                        <tr id="re-row-{{ deal.id }}" style="border-bottom: 1px solid #eee;">
                            <td style="padding: 12px;">
                                <div style="font-weight: 600;">{{ deal.property_info.building_name }}</div>
                                <div style="font-size: 0.9em; color: #666;">{{ deal.property_info.address_base }}</div>
                            </td>
                            <td style="padding: 12px; text-align: right;">{{ deal.deal_type }}</td>
                            <td style="padding: 12px; text-align: right;">{{ deal.contract_date|date:"Y-m-d" }}</td>
                            <td style="padding: 12px; text-align: right;">\ {{ deal.amount_main|intcomma }}</td>
                            {% if request.user.my_ID == user_to_view.my_ID %}
                                <td style="padding: 12px; text-align: right;">
                                    <button onclick="confirmAndDeleteRealEstate('{{ deal.id }}')" style="background: none; border: none; color: #dc3545; font-weight: bold; font-size: 1.2em; cursor: pointer;">
                                       X
                                    </button>
                                </td>
                            {% endif %}
                        </tr>
                    {% endfor %}
                    {% if not re_deals %}
                         <tr>
                            <td colspan="4" style="padding: 20px; text-align: center; color: #777;">보유 부동산이 없습니다.</td>
                        </tr>
                    {% endif %}
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function confirmAndDelete(tickerSymbol) {
        if (confirm("이 자산을 정말 삭제하시겠습니까?")) {
            fetch(`/profile/delete_stock/{{ request.user.my_ID }}/${tickerSymbol}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({ ticker_symbol: tickerSymbol })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('삭제 실패');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const rowToRemove = document.getElementById(`stock-row-${tickerSymbol}`);
                    if (rowToRemove) {
                        rowToRemove.remove();
                    }
                    alert("자산이 성공적으로 삭제되었습니다.");
                } else {
                    alert("자산 삭제에 실패했습니다.");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("자산 삭제 중 오류가 발생했습니다.");
            });
        }
    }

    function confirmAndDeleteRealEstate(dealId) {
        if (confirm("이 자산을 정말 삭제하시겠습니까?")) {
            fetch(`/profile/delete_real_estate/${dealId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({ deal_id: dealId })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('삭제 실패');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const rowToRemove = document.getElementById(`re-row-${dealId}`);
                    if (rowToRemove) {
                        rowToRemove.remove();
                    }
                    alert("자산이 성공적으로 삭제되었습니다.");
                } else {
                    alert("자산 삭제에 실패했습니다.");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("자산 삭제 중 오류가 발생했습니다.");
            });
        }
    }
</script>

{% endblock %}